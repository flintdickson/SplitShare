<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>SplitShare - Track Your Strength</title>
    
    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SplitShare">
    
    <!-- iOS App Icon -->
    <link rel="apple-touch-icon" href="splitshare-icon-1024.png">
    <link rel="apple-touch-icon" sizes="1024x1024" href="splitshare-icon-1024.png">
    
    <!-- Prevent iOS text size adjustment -->
    <meta name="format-detection" content="telephone=no">
    
    <!-- Fonts: non-blocking via preconnect + media=print swap trick -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Bebas+Neue&family=Roboto+Mono:wght@400;500&display=swap" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Bebas+Neue&family=Roboto+Mono:wght@400;500&display=swap"></noscript>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <style>
        :root {
            --black: #0a0a0a;
            --white: #fafafa;
            --iron: #1a1a1a;
            --steel: #2a2a2a;
            --primary: #ff6b35;
            --primary-dark: #ff5722;
            --primary-light: #ff8c61;
            --accent: #ffb347;
            --highlight: #ffd89b;
            --sweat: #ff9966;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* GPU-composite animated elements */
        .activity-card { contain: layout style; }
        nav { transform: translateZ(0); }

        body {
            font-family: 'Oswald', sans-serif;
            background: var(--black);
            color: var(--white);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            max-width: 100vw;
        }

        html {
            overflow-x: hidden;
            max-width: 100vw;
        }

        /* Universal overflow guard - only for block elements */
        div, section, article, aside, header, footer, main, nav, p, h1, h2, h3, h4, h5, h6 {
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* iOS scrolling */
        main {
            -webkit-overflow-scrolling: touch;
        }

        /* Animated Background */
        .bg-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, var(--iron) 1px, transparent 1px),
                linear-gradient(180deg, var(--iron) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.3;
            z-index: 0;
            animation: gridPulse 4s ease-in-out infinite;
        }

        @keyframes gridPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.15; }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        /* Header */
        header {
            padding: 20px 0;
            border-bottom: 3px solid var(--primary);
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .header-content {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo {
            font-family: 'Bebas Neue', cursive;
            font-size: 42px;
            letter-spacing: 4px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 107, 53, 0.3);
        }

        /* Bottom Navigation Bar */
        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--iron);
            border-top: 2px solid var(--primary);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 12px 0 calc(12px + env(safe-area-inset-bottom));
            z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
        }

        nav a, nav button.nav-link {
            color: #999;
            text-decoration: none;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            flex: 1;
            max-width: 100px;
        }

        nav a:hover, nav button.nav-link:hover { color: var(--primary); }
        nav a.active, nav button.nav-link.active { color: var(--primary); }
        nav a::after, nav button.nav-link::after { display: none; }
        nav a span, nav button.nav-link span { pointer-events: none; }

        .nav-icon {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            transition: all 0.3s ease;
            flex-shrink: 0;
            pointer-events: none;
        }

        /* Ensure all child elements of nav links don't block clicks */
        nav a * {
            pointer-events: none;
        }

        nav a.active .nav-icon,
        nav a:hover .nav-icon {
            stroke: var(--primary);
            filter: drop-shadow(0 0 6px rgba(255,107,53,0.5));
        }

        .log-btn svg {
            stroke: white;
            pointer-events: none;
        }

        /* Nav buttons reset */
        nav button.nav-link {
            background: none;
            border: none;
            cursor: pointer;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Center Log Button */
        .log-btn-container {
            position: relative;
            flex: 0 0 auto;
            margin: 0 10px;
        }

        .log-btn {
            background: var(--primary);
            color: var(--white);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 4px solid var(--iron);
            font-family: 'Oswald', sans-serif;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            overflow: visible;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
            margin-top: -28px;
        }

        .log-btn span {
            position: relative;
            z-index: 1;
        }

        .log-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.6);
        }

        .log-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .log-btn:hover::before {
            width: 100%;
            height: 100%;
        }

        /* Add bottom padding to main content to account for fixed nav */
        main {
            padding-bottom: calc(120px + env(safe-area-inset-bottom));
            padding-top: env(safe-area-inset-top);
        }
        
        /* Ensure all page sections have bottom padding for the fixed nav */
        .feed-page,
        .progress-page,
        .groups-page {
            padding-bottom: 20px;
        }

        /* Profile page breaks out of the 20px container padding */
        .profile-page {
            margin: 0 -20px;
            padding-bottom: calc(100px + env(safe-area-inset-bottom));
        }
        /* Inner content padding handled by .profile-content rule */

        /* Hero Stats */
        .hero-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 30px 0;
            animation: fadeInUp 0.8s ease-out 0.2s backwards;
        }

        @keyframes fadeInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .stat-card {
            background: linear-gradient(135deg, var(--steel), var(--iron));
            padding: 20px;
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 107, 53, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            color: var(--white);
            line-height: 1;
        }

        .stat-unit {
            font-size: 16px;
            color: var(--primary);
            margin-left: 5px;
        }

        /* Feed Section */
        .feed-section {
            margin: 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .section-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .filter-tabs {
            display: flex;
            gap: 6px;
        }

        .filter-tab {
            background: transparent;
            color: #888;
            border: 1.5px solid #2a2a2a;
            border-radius: 20px;
            padding: 7px 16px;
            font-family: 'Oswald', sans-serif;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .filter-tab.active,
        .filter-tab:hover {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        /* Activity Cards */
        .activity-feed {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 25px;
        }

        .activity-card {
            background: var(--steel);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 0;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 1.2s ease-out backwards;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .activity-card:nth-child(1) { animation-delay: 0.5s; }
        .activity-card:nth-child(2) { animation-delay: 0.6s; }
        .activity-card:nth-child(3) { animation-delay: 0.7s; }
        .activity-card:nth-child(4) { animation-delay: 0.8s; }

        .activity-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
            border-radius: 12px 12px 0 0;
        }

        .activity-card:hover::before {
            transform: scaleX(1);
        }

        .activity-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.2);
        }

        .activity-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid #333;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            font-weight: 700;
            overflow: hidden;
        }

        .activity-user-info h3 {
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .activity-user-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .activity-time {
            font-size: 12px;
            color: #999;
            font-family: 'Roboto Mono', monospace;
        }

        .workout-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            letter-spacing: 2px;
            padding: 15px 20px;
            margin: 0;
            color: var(--white);
            border-bottom: 1px solid #333;
            background: rgba(0, 0, 0, 0.2);
        }

        .workout-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 15px;
        }

        .workout-stat {
            text-align: center;
            padding: 12px;
            background: rgba(255, 107, 53, 0.05);
            border: 1px solid rgba(255, 107, 53, 0.2);
            border-radius: 8px;
        }

        .workout-stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--primary);
        }

        .workout-stat-label {
            font-size: 10px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 3px;
        }

        .exercise-list {
            padding: 0 15px 15px 15px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .exercise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: var(--iron);
            border-left: 3px solid var(--sweat);
            border-radius: 6px;
            font-family: 'Roboto Mono', monospace;
            gap: 8px;
            overflow: hidden;
        }

        .exercise-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--white);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
        }

        .exercise-details {
            color: var(--sweat);
            font-size: 11px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .activity-actions {
            display: flex;
            gap: 15px;
            padding: 15px 20px;
            border-top: 1px solid #333;
            margin-top: auto;
        }

        .action-btn {
            background: transparent;
            border: none;
            color: #999;
            font-family: 'Oswald', sans-serif;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            min-height: 44px;
            -webkit-tap-highlight-color: transparent;
        }

        .action-btn:active {
            color: var(--primary);
            transform: scale(0.95);
        }

        .action-btn:hover {
            color: var(--primary);
        }

        .action-icon {
            font-size: 18px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: flex-start;
            justify-content: center;
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
            padding: 20px 0 100px 0;
        }

        .modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--steel);
            padding: 40px;
            width: 90%;
            max-width: 700px;
            border: 2px solid var(--primary);
            border-radius: 16px;
            position: relative;
            animation: slideUp 0.4s ease-out;
            margin: auto;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            color: var(--white);
            font-size: 30px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--primary);
        }

        .modal h2 {
            font-family: 'Bebas Neue', cursive;
            font-size: 42px;
            letter-spacing: 3px;
            margin-bottom: 30px;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            color: #ccc;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            background: var(--iron);
            border: 2px solid #333;
            border-radius: 8px;
            color: var(--white);
            font-family: 'Oswald', sans-serif;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .exercise-inputs {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .add-exercise-btn {
            background: transparent;
            color: var(--sweat);
            border: 2px dashed var(--sweat);
            padding: 12px;
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .add-exercise-btn:hover {
            background: var(--sweat);
            color: var(--black);
        }

        .submit-btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 18px 50px;
            font-family: 'Oswald', sans-serif;
            font-size: 18px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }

        /* Photo Upload Styling */
        .photo-upload-zone {
            border: 2px dashed rgba(255, 107, 53, 0.3);
            padding: 30px;
            text-align: center;
            background: rgba(255, 107, 53, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .photo-upload-zone:hover {
            border-color: var(--primary);
            background: rgba(255, 107, 53, 0.1);
        }

        .photo-upload-zone.has-image {
            padding: 0;
            border-style: solid;
        }

        .upload-icon {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .upload-text {
            color: #999;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #photoInput {
            display: none;
        }

        .preview-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            display: none;
        }

        .preview-image.active {
            display: block;
        }

        .remove-photo {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            color: var(--white);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .remove-photo.active {
            display: flex;
        }

        .remove-photo:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        /* Workout Photo in Activity Cards */
        .workout-photo {
            width: 100%;
            aspect-ratio: 4/5;
            object-fit: cover;
            margin: 0;
            border: none;
            display: block;
        }

        .workout-caption {
            font-size: 14px;
            line-height: 1.5;
            color: #ddd;
            padding: 10px 14px 0;
        }

        /* Workout Details Section */
        .workout-details {
            padding: 12px 14px;
            background: rgba(0, 0, 0, 0.2);
        }

        .details-toggle {
            background: transparent;
            border: none;
            color: var(--primary);
            font-family: 'Oswald', sans-serif;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            transition: color 0.3s ease;
        }

        .details-toggle:hover {
            color: var(--primary-light);
        }

        .details-toggle-icon {
            transition: transform 0.3s ease;
            font-size: 10px;
        }

        .details-toggle.active .details-toggle-icon {
            transform: rotate(180deg);
        }

        .workout-details-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .workout-details-content.active {
            max-height: 1000px;
        }

        /* ── RESPONSIVE / MOBILE ─────────────────────────────────────────── */
        @media (max-width: 1024px) {
            .activity-feed { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
            .workout-stats  { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            /* Feed single column */
            .activity-feed { grid-template-columns: 1fr; gap: 16px; }

            /* Header */
            .logo { font-size: 26px; letter-spacing: 2px; }
            header { padding: 12px 0; }
            .container { padding: 0 14px; }

            /* Section header */
            .section-header { flex-direction: row; align-items: center; margin-bottom: 10px; }
            .section-title { font-size: 26px; }

            /* Filter tabs full width */
            .filter-tabs { width: 100%; gap: 6px; }
            .filter-tab  { flex: 1; padding: 8px 6px; font-size: 11px; text-align: center; border-radius: 8px; }

            /* Nav */
            nav a         { font-size: 9px; padding: 4px 4px; max-width: 64px; gap: 2px; }
            .nav-icon { width: 20px; height: 20px; }
            .log-btn      { width: 46px; height: 46px; font-size: 20px; margin-top: -23px; }

            /* Cards */
            .activity-card    { border-radius: 10px; }
            .activity-header  { padding: 12px 14px; gap: 10px; }
            .user-avatar      { width: 38px; height: 38px; font-size: 15px; }
            .activity-user-info h3 { font-size: 14px; }
            .activity-time    { font-size: 11px; }
            .workout-title    { font-size: 16px; padding: 10px 14px; }
            .workout-photo    { aspect-ratio: 4/5; height: auto; }
            .workout-caption  { font-size: 13px; padding: 10px 14px; }

            /* Workout stats */
            .workout-stats    { grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 10px; }
            .workout-stat     { padding: 8px; border-radius: 6px; }
            .workout-stat-value { font-size: 18px; }
            .workout-stat-label { font-size: 9px; }

            /* Exercise list */
            .exercise-item    { padding: 8px 10px; }
            .exercise-name    { font-size: 12px; }
            .exercise-details { font-size: 11px; }

            /* Action buttons */
            .activity-actions { padding: 10px 14px; gap: 8px; }
            .action-btn       { font-size: 11px; min-height: 40px; padding: 6px 8px; }

            /* Modal slides up from bottom */
            .modal { padding: 0; align-items: flex-end; }
            .modal-content {
                width: 100%; max-width: 100%;
                border-radius: 20px 20px 0 0;
                padding: 24px 18px calc(24px + env(safe-area-inset-bottom));
                max-height: 92vh; overflow-y: auto;
                border-left: none; border-right: none; border-bottom: none;
            }
            .modal h2 { font-size: 26px; margin-bottom: 18px; }
            .form-group { margin-bottom: 14px; }
            .form-group input, .form-group select, .form-group textarea { padding: 12px; font-size: 15px; }
            .exercise-inputs { grid-template-columns: 1fr 1fr; gap: 8px; }
            .submit-btn { padding: 15px; font-size: 15px; border-radius: 10px; }

            /* Auth — sheet slides up from bottom */
            .auth-page { align-items: flex-end; }
            .auth-container { width: 100%; max-width: 100%; }
            .auth-logo { margin-bottom: 16px; padding-top: 30px; }
            .auth-logo-text { font-size: 40px; letter-spacing: 3px; }
            .auth-tagline { font-size: 12px; margin-top: 6px; }
            .auth-form {
                padding: 26px 18px calc(30px + env(safe-area-inset-bottom));
                border-radius: 20px 20px 0 0;
                border-left: none; border-right: none; border-bottom: none;
            }
            .auth-title { font-size: 24px; margin-bottom: 18px; }
            .auth-input-group { margin-bottom: 12px; }
            .auth-input-group input { padding: 13px; font-size: 15px; border-radius: 8px; }
            .auth-input-group label { font-size: 11px; margin-bottom: 5px; }
            .auth-submit-btn { padding: 15px; font-size: 15px; border-radius: 10px; margin-top: 6px; }
            .auth-switch { font-size: 13px; margin-top: 16px; }

            /* Profile */
            .profile-header      { padding: 16px 16px 14px; }
            .profile-top         { gap: 12px; overflow: visible; }
            .profile-avatar-large { width: 76px; height: 76px; min-width: 76px; font-size: 30px; }
            .profile-name        { font-size: 20px; letter-spacing: 1px; }
            .profile-username    { font-size: 11px; }
            .profile-bio         { font-size: 12px; -webkit-line-clamp: 2; }
            .profile-stats-row   { gap: 0; }
            .profile-stat-number { font-size: 20px; }
            .profile-stat-label  { font-size: 9px; }
            .edit-profile-btn, .logout-btn { font-size: 12px; padding: 9px 0; border-radius: 6px; }
            .profile-tabs        { margin: 0 0 16px; }
            .profile-tab         { padding: 11px 2px; font-size: 11px; flex: 1; text-align: center; }

            /* Progress */
            .progress-header  { margin: 16px 0; }
            .progress-title   { font-size: 30px; }
            .chart-container  { padding: 18px 14px; border-radius: 10px; }
            .chart-wrapper    { height: 280px; padding: 10px; overflow: visible; }
            .stats-grid       { grid-template-columns: repeat(3, 1fr); gap: 8px; }
            .stat-box         { padding: 10px 6px; border-radius: 8px; }
            .stat-box-value   { font-size: 22px; }
            .stat-box-label   { font-size: 10px; }
            .exercise-selector { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .exercise-btn     { padding: 12px 8px; font-size: 13px; }
            .history-table th, .history-table td { padding: 8px 6px; font-size: 11px; }

            /* Groups */
            .groups-header    { margin: 16px 0; flex-direction: column; align-items: flex-start; gap: 12px; }
            .groups-grid      { grid-template-columns: 1fr; gap: 14px; }
            .group-header-banner { padding: 18px; border-radius: 10px 10px 0 0; }
            .group-name       { font-size: 20px; }
            .group-body       { padding: 14px; }
            .create-group-btn { padding: 12px 24px; font-size: 14px; }
            .group-detail-header { padding: 18px 14px; }
            .group-detail-title  { font-size: 28px; }

            /* Search */
            #userSearchInput { font-size: 14px; padding: 12px 14px; }
        }

        /* Progress Page Styles */
        .progress-page {
            display: none;
        }

        .progress-page.active {
            display: block;
        }

        .feed-page.active {
            display: block;
        }

        .feed-page {
            display: none;
        }

        .progress-header {
            margin: 60px 0 40px 0;
            animation: fadeInUp 0.6s ease-out;
        }

        .progress-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 48px;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .progress-subtitle {
            color: #999;
            font-size: 16px;
            letter-spacing: 1px;
        }

        .exercise-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
            animation: fadeInUp 0.8s ease-out 0.2s backwards;
        }

        .exercise-btn {
            background: var(--steel);
            border: 2px solid #333;
            color: var(--white);
            padding: 20px;
            font-family: 'Oswald', sans-serif;
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .exercise-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .exercise-btn:hover::before,
        .exercise-btn.active::before {
            transform: scaleY(1);
        }

        .exercise-btn:hover,
        .exercise-btn.active {
            border-color: var(--primary);
            background: rgba(255, 107, 53, 0.1);
        }

        .chart-container {
            background: var(--steel);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 30px;
            animation: fadeInUp 1s ease-out 0.4s backwards;
        }

        .chart-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            letter-spacing: 2px;
            margin-bottom: 30px;
            color: var(--primary);
        }

        .chart-wrapper {
            position: relative;
            height: 280px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
            overflow: visible;
        }

        .chart-canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .pr-badge {
            display: inline-block;
            background: var(--primary);
            color: var(--white);
            padding: 5px 12px;
            font-size: 12px;
            font-weight: 700;
            border-radius: 6px;
            margin-left: 10px;
            letter-spacing: 1px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 30px;
        }

        .stat-box {
            background: rgba(255, 107, 53, 0.05);
            border: 1px solid rgba(255, 107, 53, 0.2);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-box-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-box-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: var(--primary);
        }

        .workout-history {
            margin-top: 20px;
        }

        .history-table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .history-table {
            width: 100%;
            min-width: 520px;
            border-collapse: collapse;
        }

        .history-table thead {
            background: rgba(0, 0, 0, 0.3);
        }

        .history-table th {
            padding: 15px;
            text-align: left;
            font-family: 'Oswald', sans-serif;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .history-table td {
            padding: 15px;
            border-bottom: 1px solid #333;
            font-family: 'Roboto Mono', monospace;
            font-size: 14px;
        }

        .history-table tbody tr {
            transition: background 0.3s ease;
        }

        .history-table tbody tr:hover {
            background: rgba(255, 107, 53, 0.05);
        }

        .trend-up {
            color: #4ade80;
        }

        .trend-down {
            color: #f87171;
        }

        .trend-neutral {
            color: #999;
        }

        /* Groups Page Styles */
        .groups-page {
            display: none;
        }

        .groups-page.active {
            display: block;
        }

        .groups-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 60px 0 40px 0;
            animation: fadeInUp 0.6s ease-out;
        }

        .create-group-btn {
            background: var(--primary);
            color: var(--white);
            padding: 15px 35px;
            border: none;
            font-family: 'Oswald', sans-serif;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .create-group-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }

        .group-card {
            background: var(--steel);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 0;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .group-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .group-header-banner {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            padding: 30px;
            position: relative;
            border-radius: 12px 12px 0 0;
        }

        .group-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 2px;
            color: var(--white);
            margin-bottom: 5px;
        }

        .group-members-count {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Roboto Mono', monospace;
        }

        .group-body {
            padding: 25px;
        }

        .group-description {
            color: #ccc;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .group-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .group-stat {
            text-align: center;
            padding: 12px;
            background: rgba(255, 107, 53, 0.05);
            border: 1px solid rgba(255, 107, 53, 0.2);
            border-radius: 8px;
        }

        .group-stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--primary);
        }

        .group-stat-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .view-group-btn {
            width: 100%;
            background: transparent;
            border: 2px solid var(--primary);
            border-radius: 8px;
            color: var(--primary);
            padding: 12px;
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-group-btn:hover {
            background: var(--primary);
            color: var(--white);
        }

        /* Group Detail View */
        .group-detail {
            display: none;
        }

        .group-detail.active {
            display: block;
        }

        .group-detail-header {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            padding: 40px;
            margin-bottom: 30px;
            animation: fadeInUp 0.6s ease-out;
        }

        .back-to-groups {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s ease;
        }

        .back-to-groups:hover {
            color: var(--white);
        }

        .group-detail-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 48px;
            letter-spacing: 3px;
            margin-bottom: 10px;
        }

        .group-detail-info {
            display: flex;
            gap: 30px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        .post-workout-btn {
            background: var(--white);
            color: var(--primary);
            padding: 15px 40px;
            border: none;
            font-family: 'Oswald', sans-serif;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .post-workout-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 107, 53, 0.3);
        }

        .group-workout-feed {
            animation: fadeInUp 0.8s ease-out 0.2s backwards;
        }

        .group-workout-card {
            background: var(--steel);
            border: 1px solid #333;
            padding: 0;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .group-workout-card:hover {
            border-color: var(--primary);
        }

        .workout-posted-by {
            padding: 20px 30px;
            background: rgba(255, 107, 53, 0.1);
            border-bottom: 2px solid var(--primary);
        }

        .posted-by-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .posted-by-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--primary);
        }

        .workout-challenge-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 2px;
            padding: 20px 30px 10px 30px;
        }

        .workout-challenge-description {
            padding: 0 30px 20px 30px;
            color: #ccc;
            font-size: 15px;
            line-height: 1.6;
        }

        .workout-challenge-exercises {
            padding: 0 30px 20px 30px;
        }

        .completions-section {
            padding: 25px 30px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid #333;
        }

        .completions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .completions-title {
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #999;
        }

        .complete-workout-btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 10px 25px;
            font-family: 'Oswald', sans-serif;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .complete-workout-btn:hover {
            background: var(--primary-dark);
        }

        .complete-workout-btn.completed {
            background: #4ade80;
        }

        .completions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .completion-item {
            background: var(--iron);
            padding: 15px;
            border-left: 3px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .completion-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            flex-shrink: 0;
        }

        .completion-info {
            flex: 1;
        }

        .completion-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .completion-time {
            font-size: 11px;
            color: #999;
            font-family: 'Roboto Mono', monospace;
        }

        .completion-status {
            font-size: 20px;
        }

        .completion-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border: 2px solid var(--primary);
            cursor: pointer;
        }

        /* Auth Pages (Login/Signup) */
        .auth-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--black);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .auth-page.active {
            display: flex;
        }

        .auth-container {
            max-width: 450px;
            width: 90%;
            animation: slideUp 0.5s ease-out;
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-logo-text {
            font-family: 'Bebas Neue', cursive;
            font-size: 56px;
            letter-spacing: 4px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-tagline {
            color: #999;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 10px;
        }

        .auth-form {
            background: var(--steel);
            padding: 40px;
            border: 2px solid var(--primary);
        }

        .auth-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            letter-spacing: 2px;
            color: var(--primary);
            margin-bottom: 30px;
        }

        .auth-input-group {
            margin-bottom: 20px;
        }

        .auth-input-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            color: #ccc;
        }

        .auth-input-group input {
            width: 100%;
            padding: 15px;
            background: var(--iron);
            border: 2px solid #333;
            color: var(--white);
            font-family: 'Oswald', sans-serif;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .auth-input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-submit-btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 18px;
            font-family: 'Oswald', sans-serif;
            font-size: 18px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .auth-submit-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .auth-switch {
            text-align: center;
            margin-top: 25px;
            color: #999;
            font-size: 14px;
        }

        .auth-switch-link {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
            font-weight: 600;
        }

        .auth-switch-link:hover {
            color: var(--primary-light);
        }

        /* Profile Page */
        .profile-page {
            display: none;
            width: 100%;
            overflow-x: hidden;
        }

        .profile-page.active {
            display: block;
        }

        .profile-header {
            background: linear-gradient(135deg, var(--steel), var(--iron));
            padding: 20px 20px 16px;
            margin: 0;
            border-bottom: 3px solid var(--primary);
            width: 100%;
            box-sizing: border-box;
        }

        .profile-top {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            margin-bottom: 14px;
            width: 100%;
        }

        .profile-avatar-large {
            width: 88px;
            height: 88px;
            min-width: 88px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            border: 3px solid var(--primary);
            flex-shrink: 0;
            overflow: hidden;
        }

        .profile-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            width: 0; /* force flex child to respect parent */
        }

        .profile-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 1.5px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-username {
            color: var(--primary);
            font-size: 13px;
            font-family: 'Roboto Mono', monospace;
            margin-bottom: 6px;
        }

        .profile-bio {
            color: #ccc;
            line-height: 1.5;
            font-size: 13px;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .profile-stats-row {
            display: flex;
            gap: 0;
            margin-top: 4px;
        }

        .profile-stat-item {
            text-align: center;
            flex: 1;
            padding: 8px 4px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .profile-stat-item:hover {
            background: rgba(255,107,53,0.1);
        }

        .profile-stat-number {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            color: var(--primary);
            line-height: 1;
        }

        .profile-stat-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
            margin-top: 14px;
        }

        .edit-profile-btn, .logout-btn {
            padding: 10px 0;
            font-family: 'Oswald', sans-serif;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            flex: 1;
            border-radius: 8px;
        }

        .edit-profile-btn {
            background: var(--primary);
            color: var(--white);
        }

        .edit-profile-btn:hover {
            background: var(--primary-dark);
        }

        .logout-btn {
            background: transparent;
            border: 2px solid #666;
            color: #999;
        }

        .logout-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .profile-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #2a2a2a;
            margin: 0;
            padding: 0 4px;
            width: 100%;
            box-sizing: border-box;
            background: var(--iron);
        }
        .profile-tabs::-webkit-scrollbar { display: none; }

        .profile-tab {
            background: transparent;
            border: none;
            color: #666;
            padding: 14px 4px;
            font-family: 'Oswald', sans-serif;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            flex: 1;
            text-align: center;
        }

        .profile-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .profile-tab:hover {
            color: var(--primary);
        }

        .profile-content {
            padding: 16px 20px 0;
        }

        .profile-tab-content {
            display: none;
            min-height: 200px;
        }

        .profile-tab-content.active {
            display: block;
        }

        .profile-achievements {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 60px;
        }

        .achievement-card {
            background: var(--steel);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .achievement-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .achievement-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .achievement-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .achievement-description {
            font-size: 13px;
            color: #999;
        }

        .no-auth-message {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .no-auth-message h2 {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .login-prompt-btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 15px 40px;
            font-family: 'Oswald', sans-serif;
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .login-prompt-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }



    </style>
</head>
<body>
    <div class="bg-grid"></div>
    
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">SPLITSHARE</div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Feed Page -->
        <div class="feed-page active">
        <section class="feed-section">

            <!-- ── Compact feed header: title + search + tabs ── -->
            <div style="padding:10px 0 14px;">

                <!-- Row 1: Title + search icon -->
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                    <h2 class="section-title">Activity Feed</h2>
                    <!-- Search toggle -->
                    <button onclick="toggleFeedSearch(this)"
                        style="background:rgba(255,255,255,0.06);border:1.5px solid #2a2a2a;border-radius:20px;
                        color:#888;padding:7px 14px;font-family:'Oswald',sans-serif;font-size:12px;font-weight:600;
                        text-transform:uppercase;letter-spacing:0.5px;cursor:pointer;display:flex;align-items:center;
                        gap:6px;transition:all 0.2s;">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        Search
                    </button>
                </div>

                <!-- Expandable search bar -->
                <div id="feedSearchWrap" style="display:none;position:relative;margin-bottom:10px;">
                    <svg style="position:absolute;left:11px;top:50%;transform:translateY(-50%);width:15px;height:15px;stroke:#666;pointer-events:none;" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input id="userSearchInput" type="text" placeholder="Search by name or @username..."
                        style="width:100%;padding:10px 14px 10px 34px;background:#1a1a1a;border:1.5px solid #2a2a2a;
                        color:var(--white);font-family:'Oswald',sans-serif;font-size:14px;border-radius:10px;
                        outline:none;box-sizing:border-box;transition:border-color 0.2s;"
                        oninput="handleUserSearch(this.value)"
                        onfocus="this.style.borderColor='var(--primary)'"
                        onblur="setTimeout(()=>{ if(!window._searchTapped) document.getElementById('userSearchResults').style.display='none'; window._searchTapped=false; },350)">
                    <div id="userSearchResults" ontouchstart="window._searchTapped=true"
                        style="display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:#1e1e1e;
                        border:1.5px solid var(--primary);border-radius:12px;z-index:600;max-height:300px;
                        overflow-y:auto;box-shadow:0 16px 48px rgba(0,0,0,0.9);"></div>
                </div>

                <!-- Row 2: Filter tabs -->
                <div class="filter-tabs">
                    <button class="filter-tab" onclick="switchFeedTab('following', this)">Following</button>
                    <button class="filter-tab active" onclick="switchFeedTab('everyone', this)">Everyone</button>
                    <button class="filter-tab" onclick="switchFeedTab('mine', this)">My Workouts</button>
                </div>
            </div>

            <div class="activity-feed" id="mainFeed">
                <div class="feed-empty-state" id="feedEmptyState" style="display:none; text-align:center; padding:80px 20px; color:#999;">
                    <div style="margin-bottom:20px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" stroke-linecap="round" style="width:64px;height:64px;opacity:0.4;">
                        <rect x="2" y="10" width="4" height="4" rx="1"/><rect x="18" y="10" width="4" height="4" rx="1"/>
                        <rect x="7" y="8" width="2" height="8" rx="1"/><rect x="15" y="8" width="2" height="8" rx="1"/>
                        <line x1="9" y1="12" x2="15" y2="12" stroke-width="2.5"/>
                    </svg>
                </div>
                    <h3 style="font-family:'Bebas Neue',cursive; font-size:32px; color:var(--primary); margin-bottom:10px; letter-spacing:2px;">NO WORKOUTS YET</h3>
                    <p style="font-size:16px; line-height:1.6;" id="feedEmptyMsg">Be the first to log a workout!<br>Hit the <strong style="color:var(--primary)">+</strong> button below to get started.</p>
                </div>
            </div>
        </section>
        </div>
        <!-- End Feed Page -->

        <!-- Progress Page -->
        <div class="progress-page">

            <!-- ── Overview Stats ──────────────────────────────────────────── -->
            <div style="padding:16px 0 10px;">
                <h1 style="font-family:'Bebas Neue',cursive;font-size:30px;letter-spacing:2px;color:#fff;margin-bottom:14px;">Progress</h1>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:4px;">
                    <div style="background:var(--steel);border-radius:12px;padding:14px 10px;text-align:center;border:1px solid #2a2a2a;">
                        <div id="pgTotalWorkouts" style="font-family:'Bebas Neue',cursive;font-size:32px;color:var(--primary);line-height:1;">0</div>
                        <div style="font-family:'Oswald',sans-serif;font-size:10px;color:#666;text-transform:uppercase;letter-spacing:0.5px;margin-top:4px;">Total<br>Workouts</div>
                    </div>
                    <div style="background:var(--steel);border-radius:12px;padding:14px 10px;text-align:center;border:1px solid #2a2a2a;">
                        <div id="pgWeekMins" style="font-family:'Bebas Neue',cursive;font-size:32px;color:var(--primary);line-height:1;">0</div>
                        <div style="font-family:'Oswald',sans-serif;font-size:10px;color:#666;text-transform:uppercase;letter-spacing:0.5px;margin-top:4px;">Mins This<br>Week</div>
                    </div>
                    <div style="background:var(--steel);border-radius:12px;padding:14px 10px;text-align:center;border:1px solid #2a2a2a;position:relative;overflow:hidden;">
                        <div style="position:absolute;top:6px;right:8px;font-size:14px;">🔥</div>
                        <div id="pgStreak" style="font-family:'Bebas Neue',cursive;font-size:32px;color:var(--primary);line-height:1;">0</div>
                        <div style="font-family:'Oswald',sans-serif;font-size:10px;color:#666;text-transform:uppercase;letter-spacing:0.5px;margin-top:4px;">Day<br>Streak</div>
                    </div>
                </div>
            </div>

            <!-- ── Lift Selector Dropdown ───────────────────────────────────── -->
            <div style="margin-bottom:14px;">
                <label style="display:block;font-family:'Oswald',sans-serif;font-size:11px;font-weight:600;
                    text-transform:uppercase;letter-spacing:1px;color:#555;margin-bottom:8px;">Select a Lift</label>
                <div style="position:relative;">
                    <select id="liftDropdown" onchange="onLiftDropdownChange(this.value)"
                        style="width:100%;padding:13px 40px 13px 16px;background:#1a1a1a;border:1.5px solid #2a2a2a;
                        border-radius:10px;color:#fff;font-family:'Oswald',sans-serif;font-size:15px;
                        font-weight:600;outline:none;appearance:none;cursor:pointer;transition:border-color 0.2s;"
                        onfocus="this.style.borderColor='var(--primary)'"
                        onblur="this.style.borderColor='#2a2a2a'">
                        <option value="">— Choose a lift —</option>
                    </select>
                    <svg style="position:absolute;right:14px;top:50%;transform:translateY(-50%);pointer-events:none;width:16px;height:16px;stroke:var(--primary);"
                        viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
            </div>

            <!-- ── Chart + Stats (hidden until lift selected) ──────────────── -->
            <div id="liftDetailSection" style="display:none;">

                <!-- Line chart -->
                <div style="background:var(--steel);border-radius:12px;padding:16px 14px;margin-bottom:12px;border:1px solid #2a2a2a;">
                    <div id="chartTitle" style="font-family:'Bebas Neue',cursive;font-size:22px;letter-spacing:1.5px;
                        color:#fff;margin-bottom:2px;"></div>
                    <div id="chartPrBadge" style="display:inline-block;background:var(--primary);color:#fff;
                        font-family:'Oswald',sans-serif;font-size:11px;font-weight:700;padding:2px 10px;
                        border-radius:20px;margin-bottom:12px;letter-spacing:1px;"></div>
                    <div style="position:relative;height:220px;">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>

                <!-- 3 stat boxes -->
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;">
                    <div style="background:var(--steel);border-radius:12px;padding:14px 10px;text-align:center;border:1px solid #2a2a2a;">
                        <div style="font-family:'Oswald',sans-serif;font-size:10px;color:#555;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Current PR</div>
                        <div id="currentPR" style="font-family:'Bebas Neue',cursive;font-size:26px;color:var(--primary);line-height:1;">—</div>
                    </div>
                    <div style="background:var(--steel);border-radius:12px;padding:14px 10px;text-align:center;border:1px solid #2a2a2a;">
                        <div style="font-family:'Oswald',sans-serif;font-size:10px;color:#555;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Total Increase</div>
                        <div id="totalIncrease" style="font-family:'Bebas Neue',cursive;font-size:26px;color:var(--primary);line-height:1;">—</div>
                    </div>
                    <div style="background:var(--steel);border-radius:12px;padding:14px 10px;text-align:center;border:1px solid #2a2a2a;">
                        <div style="font-family:'Oswald',sans-serif;font-size:10px;color:#555;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Sessions</div>
                        <div id="sessionsLogged" style="font-family:'Bebas Neue',cursive;font-size:26px;color:var(--primary);line-height:1;">—</div>
                    </div>
                </div>

                <!-- Exercise History -->
                <div style="background:var(--steel);border-radius:12px;overflow:hidden;border:1px solid #2a2a2a;margin-bottom:8px;">
                    <div style="padding:12px 16px;border-bottom:1px solid #2a2a2a;font-family:'Bebas Neue',cursive;
                        font-size:18px;letter-spacing:1.5px;color:#fff;">Exercise History</div>
                    <div class="history-table-wrapper" style="overflow-x:auto;">
                        <table class="history-table" style="min-width:360px;">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Weight</th>
                                    <th>Sets × Reps</th>
                                    <th>Volume</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody"></tbody>
                        </table>
                    </div>
                </div>

            </div>

            <!-- Empty state -->
            <div id="progressEmptyState" style="display:none;text-align:center;padding:50px 20px;">
                <div style="font-size:48px;margin-bottom:14px;">📊</div>
                <div style="font-family:'Bebas Neue',cursive;font-size:26px;color:var(--primary);margin-bottom:8px;">No Lifts Tracked Yet</div>
                <p style="font-family:'Oswald',sans-serif;font-size:14px;color:#555;">Log workouts with weights and they'll appear here</p>
            </div>

        </div>
        <!-- End Progress Page -->

        <!-- My Groups Page -->
        <div class="groups-page">

            <!-- VIEW: My Groups List -->
            <div id="groupsListView">
                <div class="groups-header">
                    <div>
                        <h1 class="progress-title">My Groups</h1>
                        <p class="progress-subtitle">Train together, achieve together</p>
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="create-group-btn" style="background:transparent;border:2px solid var(--primary);color:var(--primary);" onclick="showJoinGroupPanel()">Find Group</button>
                        <button class="create-group-btn" onclick="showCreateGroupPanel()">+ Create Group</button>
                    </div>
                </div>

                <!-- Create Group Panel -->
                <div id="createGroupPanel" style="display:none; background:var(--steel); border:2px solid var(--primary); padding:24px; margin-bottom:30px; border-radius:12px;">
                    <h3 style="font-family:'Bebas Neue',cursive;font-size:28px;color:var(--primary);letter-spacing:2px;margin-bottom:20px;">CREATE NEW GROUP</h3>
                    
                    <!-- Cover Photo Upload -->
                    <div class="form-group" style="margin-bottom:20px;">
                        <label>Cover Photo</label>
                        <div id="groupCoverZone" onclick="document.getElementById('groupCoverInput').click()" style="height:140px;background:var(--iron);border:2px dashed #444;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;transition:border-color 0.3s;position:relative;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='#444'">
                            <img id="groupCoverPreview" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;display:none;">
                            <div id="groupCoverPlaceholder" style="text-align:center;pointer-events:none;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" stroke-linecap="round" style="width:36px;height:36px;margin-bottom:8px;display:block;margin:0 auto 8px;"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                <div style="color:#999;font-size:12px;text-transform:uppercase;letter-spacing:1px;">Tap to add cover photo</div>
                            </div>
                            <button id="groupCoverRemove" onclick="event.stopPropagation();removeGroupCover()" style="display:none;position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:16px;line-height:1;">×</button>
                        </div>
                        <input type="file" id="groupCoverInput" accept="image/*" style="display:none;" onchange="previewGroupCover(this)">
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;">
                        <div class="form-group" style="margin:0;">
                            <label>Group Name</label>
                            <input id="newGroupName" type="text" placeholder="Morning Grind Crew">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label>Group ID (no spaces)</label>
                            <input id="newGroupId" type="text" placeholder="morninggrind2026" oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9]/g,'')">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom:14px;">
                        <label>Description</label>
                        <textarea id="newGroupDesc" rows="3" placeholder="What's this group about? Goals, schedule, rules..."></textarea>
                    </div>
                    <div class="form-group" style="margin-bottom:14px;">
                        <label>Privacy</label>
                        <select id="newGroupPrivacy" onchange="toggleJoinCode()">
                            <option value="public">Public — anyone can join by searching the Group ID</option>
                            <option value="private">Private — requires a join code</option>
                        </select>
                    </div>
                    <div id="joinCodeRow" style="display:none;" class="form-group" style="margin-bottom:14px;">
                        <label>Join Code (members will need this)</label>
                        <input id="newGroupCode" type="text" placeholder="e.g. LIFT2026" style="text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()">
                    </div>
                    <div style="display:flex;gap:10px;margin-top:4px;">
                        <button class="submit-btn" style="margin:0;padding:14px 28px;width:auto;" onclick="handleCreateGroup()">Create Group</button>
                        <button style="background:transparent;border:2px solid #555;color:#999;padding:14px 28px;font-family:'Oswald',sans-serif;font-size:14px;text-transform:uppercase;letter-spacing:1px;cursor:pointer;border-radius:8px;" onclick="hideCreateGroupPanel()">Cancel</button>
                    </div>
                </div>

                <!-- Join Group Panel -->
                <div id="joinGroupPanel" style="display:none; background:var(--steel); border:2px solid var(--primary); padding:30px; margin-bottom:30px;">
                    <h3 style="font-family:'Bebas Neue',cursive;font-size:28px;color:var(--primary);letter-spacing:2px;margin-bottom:20px;">FIND & JOIN A GROUP</h3>
                    <div style="display:flex;gap:10px;align-items:flex-end;">
                        <div class="form-group" style="margin:0;flex:1;">
                            <label>Group ID</label>
                            <input id="searchGroupId" type="text" placeholder="Enter group ID (e.g. morninggrind2026)">
                        </div>
                        <button class="submit-btn" style="margin:0;padding:15px 30px;width:auto;" onclick="handleSearchGroup()">Search</button>
                    </div>
                    <div id="searchGroupResult" style="margin-top:20px;"></div>
                    <button style="background:transparent;border:none;color:#666;font-family:'Oswald',sans-serif;font-size:13px;text-transform:uppercase;letter-spacing:1px;cursor:pointer;margin-top:15px;" onclick="hideJoinGroupPanel()">Cancel</button>
                </div>

                <!-- My Groups Grid -->
                <div id="myGroupsGrid" class="groups-grid">
                    <!-- Populated by JS -->
                </div>
                <div id="myGroupsEmpty" style="display:none;text-align:center;padding:80px 20px;color:#999;">
                    <div style="font-size:64px;margin-bottom:20px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:1em;height:1em;display:inline-block;vertical-align:-0.1em;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
                    <h3 style="font-family:'Bebas Neue',cursive;font-size:32px;color:var(--primary);margin-bottom:10px;letter-spacing:2px;">NO GROUPS YET</h3>
                    <p style="font-size:16px;line-height:1.8;">Create a group or find one by its Group ID.</p>
                </div>
            </div>

            <!-- VIEW: Group Detail -->
            <div id="groupDetailView" style="display:none;">
                <!-- Cover Photo Header -->
                <div id="groupDetailHeader" style="position:relative;min-height:180px;overflow:hidden;margin:-20px -20px 0;border-bottom:3px solid var(--primary);">
                    <div id="groupCoverBg" style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,var(--steel),var(--iron));"></div>
                    <img id="groupCoverImg" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;display:none;">
                    <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.75) 100%);"></div>
                    <div style="position:relative;padding:14px 16px 18px;">
                        <button class="back-to-groups" onclick="closeGroupDetail()" style="color:rgba(255,255,255,0.8);margin-bottom:12px;">← Back to Groups</button>
                        <h2 class="group-detail-title" id="groupDetailTitle" style="font-size:28px;letter-spacing:2px;text-shadow:0 2px 8px rgba(0,0,0,0.5);"></h2>
                        <p id="groupDetailDesc" style="color:rgba(255,255,255,0.8);font-size:13px;margin:6px 0 10px;line-height:1.5;max-width:520px;"></p>
                        <div class="group-detail-info" id="groupDetailInfo" style="font-size:12px;gap:12px;flex-wrap:wrap;"></div>
                        <div id="groupDetailActions" style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;"></div>
                    </div>
                </div>

                <!-- Post Workout Challenge Form (admin only) -->
                <div id="postChallengePanel" style="display:none; background:var(--steel); border:2px solid var(--primary); padding:20px; margin:16px 0; border-radius:12px;">
                    <h3 style="font-family:'Bebas Neue',cursive;font-size:24px;color:var(--primary);letter-spacing:2px;margin-bottom:16px;">POST WORKOUT CHALLENGE</h3>
                    <div class="form-group">
                        <label>Challenge Title</label>
                        <input id="challengeTitle" type="text" placeholder="Monday Push Day">
                    </div>
                    <div class="form-group">
                        <label>Description / Motivation</label>
                        <textarea id="challengeDesc" rows="2" placeholder="Add notes, motivation, or instructions..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Exercises</label>
                        <div id="challengeExerciseContainer">
                            <div class="exercise-inputs">
                                <input type="text" placeholder="Exercise name">
                                <input type="number" placeholder="Sets">
                                <input type="number" placeholder="Reps">
                                <input type="text" placeholder="Notes (optional)">
                            </div>
                        </div>
                        <button type="button" class="add-exercise-btn" onclick="addChallengeExercise()">+ Add Exercise</button>
                    </div>
                    <div style="display:flex;gap:10px;">
                        <button class="submit-btn" style="margin:0;padding:14px 28px;width:auto;" onclick="handlePostChallenge()">Post Challenge</button>
                        <button style="background:transparent;border:2px solid #555;color:#999;padding:14px 28px;font-family:'Oswald',sans-serif;font-size:14px;text-transform:uppercase;letter-spacing:1px;cursor:pointer;border-radius:8px;" onclick="document.getElementById('postChallengePanel').style.display='none'">Cancel</button>
                    </div>
                </div>

                <!-- Edit Group Panel (admin only) -->
                <div id="editGroupPanel" style="display:none; background:var(--steel); border:2px solid #555; padding:20px; margin:0 0 16px; border-radius:12px;">
                    <h3 style="font-family:'Bebas Neue',cursive;font-size:24px;color:var(--primary);letter-spacing:2px;margin-bottom:16px;">EDIT GROUP</h3>
                    <!-- Edit cover photo -->
                    <div class="form-group" style="margin-bottom:16px;">
                        <label>Cover Photo</label>
                        <div id="editCoverZone" onclick="document.getElementById('editCoverInput').click()" style="height:120px;background:var(--iron);border:2px dashed #444;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;position:relative;transition:border-color 0.3s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='#444'">
                            <img id="editCoverPreview" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;display:none;">
                            <div id="editCoverPlaceholder" style="text-align:center;pointer-events:none;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" stroke-linecap="round" style="width:28px;height:28px;display:block;margin:0 auto 6px;"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                <div style="color:#999;font-size:11px;text-transform:uppercase;letter-spacing:1px;">Change cover photo</div>
                            </div>
                            <button id="editCoverRemove" onclick="event.stopPropagation();removeEditCover()" style="display:none;position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);border:none;color:#fff;width:26px;height:26px;border-radius:50%;cursor:pointer;font-size:15px;">×</button>
                        </div>
                        <input type="file" id="editCoverInput" accept="image/*" style="display:none;" onchange="previewEditCover(this)">
                    </div>
                    <div class="form-group" style="margin-bottom:14px;">
                        <label>Group Name</label>
                        <input id="editGroupName" type="text" placeholder="Group name">
                    </div>
                    <div class="form-group" style="margin-bottom:14px;">
                        <label>Description</label>
                        <textarea id="editGroupDesc" rows="3" placeholder="What's this group about?"></textarea>
                    </div>
                    <div style="display:flex;gap:10px;">
                        <button class="submit-btn" style="margin:0;padding:14px 28px;width:auto;" onclick="handleSaveGroupEdit()">Save Changes</button>
                        <button style="background:transparent;border:2px solid #555;color:#999;padding:14px 28px;font-family:'Oswald',sans-serif;font-size:14px;text-transform:uppercase;letter-spacing:1px;cursor:pointer;border-radius:8px;" onclick="document.getElementById('editGroupPanel').style.display='none'">Cancel</button>
                    </div>
                </div>

                <div id="groupChallengesFeed">
                    <!-- Challenges loaded by JS -->
                </div>
            </div>

        </div>
        <!-- End My Groups Page -->

        <!-- Profile Page -->
        <div class="profile-page">
            <div class="profile-header">
                <div class="profile-top">
                    <div class="profile-avatar-large" id="profileInitials">MK</div>
                    <div class="profile-info">
                        <h1 class="profile-name" id="profileName">Marcus King</h1>
                        <div class="profile-username" id="profileUsername">@marcusking</div>
                        <p class="profile-bio" id="profileBio">Powerlifter | 5 AM Grind | Chasing 500lb deadlift <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:1em;height:1em;display:inline-block;vertical-align:-0.1em;color:var(--primary);"><path d="M12 2a4 4 0 0 1 4 4v1h1a3 3 0 0 1 3 3v2a3 3 0 0 1-3 3h-1l-1 4H9l-1-4H7a3 3 0 0 1-3-3v-2a3 3 0 0 1 3-3h1V6a4 4 0 0 1 4-4z" stroke="var(--primary)" fill="rgba(255,107,53,0.2)" stroke-width="1.5"/></svg></p>
                        <div class="profile-stats-row">
                            <div class="profile-stat-item">
                                <div class="profile-stat-number" id="profileWorkoutCount">0</div>
                                <div class="profile-stat-label">Workouts</div>
                            </div>
                            <div class="profile-stat-item" onclick="openFollowersModal()" style="cursor:pointer;transition:transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <div class="profile-stat-number" id="profileFollowers">0</div>
                                <div class="profile-stat-label">Followers</div>
                            </div>
                            <div class="profile-stat-item" onclick="openFollowingModal()" style="cursor:pointer;transition:transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <div class="profile-stat-number" id="profileFollowing">0</div>
                                <div class="profile-stat-label">Following</div>
                            </div>
                        </div>
                        <div class="profile-actions">
                            <button class="edit-profile-btn" onclick="openEditProfile()">Edit Profile</button>
                            <button class="logout-btn" onclick="logout()">Logout</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="profile-tabs">
                <button class="profile-tab active" onclick="switchProfileTab('workouts')">Workouts</button>
                <button class="profile-tab" onclick="switchProfileTab('achievements')">Achievements</button>
                <button class="profile-tab" onclick="switchProfileTab('stats')">Stats</button>
                <button class="profile-tab" onclick="switchProfileTab('groups')">Groups</button>
            </div>

            <div class="profile-content">
                <!-- Workouts Tab -->
                <div class="profile-tab-content active" id="workouts-tab">
                    <div id="profileWorkoutFeed" class="activity-feed" style="padding-bottom:20px;"></div>
                </div>

                <!-- Achievements Tab -->
                <div class="profile-tab-content" id="achievements-tab">
                    <div class="profile-achievements" id="achievementsGrid"></div>
                </div>

                <!-- Stats Tab -->
                <div class="profile-tab-content" id="stats-tab">
                    <div class="chart-container">
                        <h2 class="chart-title">My Workout Stats</h2>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-box-label">Total Workouts</div>
                                <div class="stat-box-value" id="statTotalWorkouts">0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-box-label">Total Exercises</div>
                                <div class="stat-box-value" id="statTotalExercises">0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-box-label">Total Minutes</div>
                                <div class="stat-box-value" id="statTotalMinutes">0</div>
                            </div>
                        </div>
                        <div id="recentWorkoutsList" style="margin-top:30px;"></div>
                    </div>
                </div>

                <!-- Groups Tab -->
                <div class="profile-tab-content" id="groups-tab">
                    <div id="profileGroupsGrid" class="groups-grid">
                        <!-- Groups loaded by JS -->
                    </div>
                </div>
            </div>
        </div>
        <!-- End Profile Page -->

        <!-- User Profile View Page (for viewing other users) -->
        <div class="profile-page" id="userProfileView" style="display:none;">
            <div class="profile-header">
                <button class="back-to-groups" onclick="closeUserProfile()" style="margin-bottom:15px;color:#ccc;">← Back to Feed</button>
                <div class="profile-top">
                    <div class="profile-avatar-large" id="viewUserAvatar">MK</div>
                    <div class="profile-info">
                        <h1 class="profile-name" id="viewUserName">User Name</h1>
                        <div class="profile-username" id="viewUserUsername">@username</div>
                        <p class="profile-bio" id="viewUserBio">Bio goes here</p>
                        <div class="profile-stats-row">
                            <div class="profile-stat-item">
                                <div class="profile-stat-number" id="viewUserWorkoutCount">0</div>
                                <div class="profile-stat-label">Workouts</div>
                            </div>
                            <div class="profile-stat-item" onclick="openFollowersModalForUser(viewingUserId)" style="cursor:pointer;transition:transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <div class="profile-stat-number" id="viewUserFollowers">0</div>
                                <div class="profile-stat-label">Followers</div>
                            </div>
                            <div class="profile-stat-item" onclick="openFollowingModalForUser(viewingUserId)" style="cursor:pointer;transition:transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <div class="profile-stat-number" id="viewUserFollowing">0</div>
                                <div class="profile-stat-label">Following</div>
                            </div>
                        </div>
                        <div class="profile-actions">
                            <button class="edit-profile-btn" id="viewUserFollowBtn" onclick="toggleFollowOnProfile()">Follow</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="profile-tabs">
                <button class="profile-tab active">Workouts</button>
            </div>

            <div class="profile-content">
                <div class="profile-tab-content active">
                    <div id="viewUserWorkoutFeed" class="activity-feed"></div>
                </div>
            </div>
        </div>
        <!-- End User Profile View Page -->

        <!-- Edit Profile Modal -->
        <div class="modal" id="editProfileModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeEditProfile()">×</button>
                <h2>Edit Profile</h2>
                <form id="editProfileForm">
                    <!-- Profile Picture -->
                    <div class="form-group">
                        <label>Profile Picture</label>
                        <div style="display:flex;gap:20px;align-items:center;">
                            <div id="editProfileAvatar" style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:32px;border:3px solid var(--primary);flex-shrink:0;overflow:hidden;">
                                <img id="editProfileAvatarImg" style="width:100%;height:100%;object-fit:cover;display:none;" alt="">
                                <span id="editProfileAvatarInitials"></span>
                            </div>
                            <div style="flex:1;">
                                <input type="file" id="profilePicInput" accept="image/*" style="display:none;">
                                <button type="button" onclick="document.getElementById('profilePicInput').click()"
                                    style="background:var(--primary);color:#fff;border:none;padding:12px 20px;font-family:'Oswald',sans-serif;font-size:14px;text-transform:uppercase;letter-spacing:1px;cursor:pointer;margin-bottom:8px;width:100%;">
                                    Upload Photo
                                </button>
                                <button type="button" id="removeProfilePicBtn" onclick="removeProfilePic()" style="display:none;background:transparent;border:2px solid #555;color:#999;padding:10px 20px;font-family:'Oswald',sans-serif;font-size:13px;text-transform:uppercase;letter-spacing:1px;cursor:pointer;width:100%;">
                                    Remove Photo
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Full Name</label>
                        <input id="editFullName" type="text" placeholder="Your name" required>
                    </div>

                    <div class="form-group">
                        <label>Username</label>
                        <input id="editUsername" type="text" placeholder="username" required style="text-transform:lowercase;" oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9_]/g,'')">
                        <small style="display:block;color:#999;font-size:12px;margin-top:5px;">Letters, numbers, and underscores only</small>
                    </div>

                    <div class="form-group">
                        <label>Bio</label>
                        <textarea id="editBio" rows="3" placeholder="Tell us about yourself..."></textarea>
                    </div>

                    <button type="button" class="submit-btn" onclick="handleSaveProfile()">Save Changes</button>
                </form>
            </div>
        </div>

        <!-- Followers/Following Modal -->
        <div class="modal" id="followModal">
            <div class="modal-content" style="max-width:600px;">
                <button class="modal-close" onclick="closeFollowModal()">×</button>
                <h2 id="followModalTitle">Followers</h2>
                <div id="followModalContent" style="max-height:500px;overflow-y:auto;margin-top:20px;">
                    <!-- Users loaded by JS -->
                </div>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav>
        <button type="button" class="nav-link active" data-page="feed" onclick="handleNav('feed',this)">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
            </svg>
            <span>Feed</span>
        </button>
        <button type="button" class="nav-link" data-page="progress" onclick="handleNav('progress',this)">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
            </svg>
            <span>Progress</span>
        </button>
        <div class="log-btn-container">
            <button class="log-btn" onclick="openLogPicker()">
                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" style="width:22px;height:22px;pointer-events:none;">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
            </button>
        </div>
        <button type="button" class="nav-link" data-page="groups" onclick="handleNav('groups',this)">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="10" width="4" height="4" rx="1"/>
                <rect x="18" y="10" width="4" height="4" rx="1"/>
                <rect x="7" y="8" width="2" height="8" rx="1"/>
                <rect x="15" y="8" width="2" height="8" rx="1"/>
                <line x1="9" y1="12" x2="15" y2="12" stroke-width="2.5"/>
            </svg>
            <span>Groups</span>
        </button>
        <button type="button" class="nav-link" data-page="profile" onclick="handleNav('profile',this)">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="8" r="4"/>
                <path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/>
            </svg>
            <span>Profile</span>
        </button>
    </nav>

    <!-- Log Workout Modal -->
    <!-- ── LOG WORKOUT MODAL (2-step) ───────────────────────────────────── -->
    <div class="modal" id="workoutModal" style="align-items:flex-end;padding:0;">
        <div style="width:100%;max-width:600px;margin:0 auto;background:var(--iron);border-radius:20px 20px 0 0;
            border-top:3px solid var(--primary);max-height:92vh;overflow-y:auto;position:relative;">

            <!-- Step indicator + close -->
            <div style="display:flex;align-items:center;justify-content:space-between;padding:18px 20px 0;">
                <div style="display:flex;gap:6px;align-items:center;">
                    <div id="stepDot1" style="width:28px;height:4px;border-radius:2px;background:var(--primary);transition:all 0.3s;"></div>
                    <div id="stepDot2" style="width:28px;height:4px;border-radius:2px;background:#333;transition:all 0.3s;"></div>
                </div>
                <div style="font-family:'Oswald',sans-serif;font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;" id="stepLabel">Step 1 of 2</div>
                <button onclick="closeModal()" style="background:rgba(255,255,255,0.08);border:none;color:#fff;
                    width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer;display:flex;
                    align-items:center;justify-content:center;">✕</button>
            </div>

            <!-- ── STEP 1: Name + Type + Exercises ── -->
            <div id="logStep1" style="padding:16px 20px 24px;">
                <!-- Mode tag -->
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
                    <h2 style="font-family:'Bebas Neue',cursive;font-size:32px;letter-spacing:2px;color:var(--primary);margin:0;">
                        Log Workout
                    </h2>
                    <span id="logModeTag" style="display:none;background:rgba(255,107,53,0.15);border:1px solid rgba(255,107,53,0.35);
                        border-radius:20px;padding:4px 12px;font-family:'Oswald',sans-serif;font-size:12px;
                        color:var(--primary);text-transform:uppercase;letter-spacing:1px;white-space:nowrap;
                        overflow:hidden;text-overflow:ellipsis;max-width:160px;"></span>
                </div>

                <!-- Workout Name -->
                <div style="margin-bottom:16px;">
                    <label style="display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:8px;">Workout Name</label>
                    <input id="workoutName" type="text" placeholder="e.g., Push Day · Chest & Triceps"
                        style="width:100%;padding:14px 16px;background:#252525;border:1.5px solid #333;border-radius:10px;
                        color:#fff;font-family:'Oswald',sans-serif;font-size:16px;outline:none;transition:border-color 0.2s;"
                        onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#333'">
                </div>

                <!-- Workout Type -->
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:8px;">Workout Type</label>
                    <select id="workoutType"
                        style="width:100%;padding:14px 16px;background:#252525;border:1.5px solid #333;border-radius:10px;
                        color:#fff;font-family:'Oswald',sans-serif;font-size:16px;outline:none;appearance:none;
                        background-image:url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23ff6b35%22 stroke-width=%222%22><polyline points=%226 9 12 15 18 9%22/></svg>');
                        background-repeat:no-repeat;background-position:right 14px center;background-size:18px;">
                        <option value="">Select type</option>
                        <option value="push">Push — Chest, Shoulders, Triceps</option>
                        <option value="pull">Pull — Back, Biceps</option>
                        <option value="legs">Legs</option>
                        <option value="upper">Upper Body</option>
                        <option value="lower">Lower Body</option>
                        <option value="full">Full Body</option>
                        <option value="cardio">Cardio</option>
                        <option value="hiit">HIIT</option>
                        <option value="sport">Sport</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <!-- Duration -->
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:8px;">Duration (minutes)</label>
                    <input id="workoutDuration" type="number" placeholder="60" value="60"
                        style="width:100%;padding:14px 16px;background:#252525;border:1.5px solid #333;border-radius:10px;
                        color:#fff;font-family:'Oswald',sans-serif;font-size:16px;outline:none;transition:border-color 0.2s;"
                        onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#333'">
                </div>

                <!-- Exercises -->
                <div style="margin-bottom:8px;">
                    <label style="display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:12px;">Exercises</label>
                    <div id="exerciseContainer" style="display:flex;flex-direction:column;gap:10px;"></div>
                    <button type="button" onclick="addExercise()"
                        style="width:100%;margin-top:10px;padding:12px;background:transparent;border:1.5px dashed #444;
                        border-radius:10px;color:#666;font-family:'Oswald',sans-serif;font-size:13px;font-weight:600;
                        text-transform:uppercase;letter-spacing:1px;cursor:pointer;transition:all 0.2s;"
                        onmouseover="this.style.borderColor='var(--primary)';this.style.color='var(--primary)'"
                        onmouseout="this.style.borderColor='#444';this.style.color='#666'">
                        + Add Exercise
                    </button>
                </div>

                <!-- Next button -->
                <button onclick="goToStep2()"
                    style="width:100%;margin-top:20px;padding:16px;background:var(--primary);border:none;border-radius:12px;
                    color:#fff;font-family:'Oswald',sans-serif;font-size:17px;font-weight:600;text-transform:uppercase;
                    letter-spacing:2px;cursor:pointer;transition:all 0.2s;">
                    Continue →
                </button>
            </div>

            <!-- ── STEP 2: Photo + Caption + Group + Post ── -->
            <div id="logStep2" style="display:none;padding:16px 20px 24px;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
                    <button onclick="goToStep1()"
                        style="background:rgba(255,255,255,0.06);border:none;color:#fff;width:34px;height:34px;
                        border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;">←</button>
                    <h2 id="logStep2Title" style="font-family:'Bebas Neue',cursive;font-size:28px;letter-spacing:2px;color:var(--primary);margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Share It</h2>
                </div>

                <!-- Workout summary pill -->
                <div id="step2Summary" style="background:rgba(255,107,53,0.08);border:1px solid rgba(255,107,53,0.2);
                    border-radius:10px;padding:12px 16px;margin-bottom:20px;font-family:'Oswald',sans-serif;font-size:13px;color:#ccc;"></div>

                <!-- Photo upload -->
                <div style="margin-bottom:16px;">
                    <label style="display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:8px;">Photo (Optional)</label>
                    <div id="photoZone" onclick="document.getElementById('photoInput').click()"
                        style="border:1.5px dashed rgba(255,107,53,0.35);border-radius:12px;padding:30px;text-align:center;
                        background:rgba(255,107,53,0.04);cursor:pointer;transition:all 0.2s;position:relative;"
                        onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='rgba(255,107,53,0.35)'">
                        <div id="photoZoneInner">
                            <div style="font-size:36px;margin-bottom:8px;">📸</div>
                            <div style="font-family:'Oswald',sans-serif;font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;">Tap to add photo</div>
                        </div>
                        <img id="previewImage" style="display:none;width:100%;border-radius:10px;max-height:300px;object-fit:cover;" alt="">
                        <button type="button" id="removePhoto" onclick="event.stopPropagation();removeWorkoutPhoto()"
                            style="display:none;position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.7);
                            border:none;color:#fff;width:30px;height:30px;border-radius:50%;font-size:16px;cursor:pointer;">✕</button>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" style="display:none;" onchange="handlePhotoSelect(this)">
                </div>

                <!-- Caption -->
                <div style="margin-bottom:16px;">
                    <label style="display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:8px;">Caption (Optional)</label>
                    <textarea id="captionInput" rows="3" placeholder="How did the session feel? Any PRs?"
                        style="width:100%;padding:14px 16px;background:#252525;border:1.5px solid #333;border-radius:10px;
                        color:#fff;font-family:'Oswald',sans-serif;font-size:15px;outline:none;resize:none;transition:border-color 0.2s;box-sizing:border-box;"
                        onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#333'"></textarea>
                </div>

                <!-- Post button -->
                <button onclick="handleLogWorkout()"
                    style="width:100%;padding:16px;background:var(--primary);border:none;border-radius:12px;
                    color:#fff;font-family:'Oswald',sans-serif;font-size:17px;font-weight:600;text-transform:uppercase;
                    letter-spacing:2px;cursor:pointer;transition:all 0.2s;">
                    Post Workout
                </button>
            </div>
        </div>
    </div>

    <!-- Signup Page -->
    <div class="auth-page" id="signupPage">
        <div class="auth-container">
            <div class="auth-logo">
                <div class="auth-logo-text">SPLITSHARE</div>
                <div class="auth-tagline">Track Your Strength</div>
            </div>
            <div class="auth-form">
                <h2 class="auth-title">Create Account</h2>
                <div class="auth-error" id="signupError" style="display:none; color:#ff6b35; font-size:14px; margin-bottom:15px; padding:10px; background:rgba(255,107,53,0.1); border-left:3px solid #ff6b35;"></div>
                <form id="signupForm" onsubmit="return false;">
                    <div class="auth-input-group">
                        <label>Full Name</label>
                        <input id="signupName" type="text" placeholder="Marcus King">
                    </div>
                    <div class="auth-input-group">
                        <label>Username</label>
                        <input id="signupUsername" type="text" placeholder="marcusking">
                    </div>
                    <div class="auth-input-group">
                        <label>Email</label>
                        <input id="signupEmail" type="email" placeholder="marcus@example.com">
                    </div>
                    <div class="auth-input-group">
                        <label>Password</label>
                        <input id="signupPassword" type="password" placeholder="Min. 6 characters">
                    </div>
                    <button type="button" class="auth-submit-btn" onclick="handleSignup()">Create Account</button>
                </form>
                <div class="auth-switch">
                    Already have an account? <span class="auth-switch-link" onclick="showLogin()">Log in</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div class="auth-page" id="loginPage">
        <div class="auth-container">
            <div class="auth-logo">
                <div class="auth-logo-text">SPLITSHARE</div>
                <div class="auth-tagline">Track Your Strength</div>
            </div>
            <div class="auth-form">
                <h2 class="auth-title">Welcome Back</h2>
                <div class="auth-error" id="loginError" style="display:none; color:#ff6b35; font-size:14px; margin-bottom:15px; padding:10px; background:rgba(255,107,53,0.1); border-left:3px solid #ff6b35;"></div>
                <form id="loginForm" onsubmit="return false;">
                    <div class="auth-input-group">
                        <label>Email Address</label>
                        <input id="loginIdentifier" type="email" placeholder="marcus@example.com">
                    </div>
                    <div class="auth-input-group">
                        <label>Password</label>
                        <input id="loginPassword" type="password" placeholder="••••••••">
                    </div>
                    <button type="button" class="auth-submit-btn" onclick="handleLogin()">Log In</button>
                </form>
                <div class="auth-switch">
                    Don't have an account? <span class="auth-switch-link" onclick="showSignup()">Sign up</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Navigation System — wire up after first paint
        const navLinks = document.querySelectorAll('.nav-link');
        const feedPage = document.querySelector('.feed-page');
        const progressPage = document.querySelector('.progress-page');
        const groupsPage = document.querySelector('.groups-page');
        const profilePage = document.querySelector('.profile-page');

        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = this.dataset.page;
                
                // Update active nav link
                navLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                // Hide all pages
                if (feedPage) feedPage.classList.remove('active');
                if (progressPage) progressPage.classList.remove('active');
                if (groupsPage) groupsPage.classList.remove('active');
                if (profilePage) profilePage.classList.remove('active');
                
                // Show selected page
                if (page === 'feed' && feedPage) {
                    feedPage.classList.add('active');
                    loadFeedFromSupabase();
                } else if (page === 'progress' && progressPage) {
                    progressPage.classList.add('active');
                    // Destroy old chart so it re-renders at correct size
                    if (window.progressChart) { window.progressChart.destroy(); window.progressChart = null; }
                    if (window.demoChart) { window.demoChart.destroy(); window.demoChart = null; }
                    setTimeout(() => loadProgressPage(), 120);
                } else if (page === 'groups' && groupsPage) {
                    groupsPage.classList.add('active');
                    closeGroupDetail();
                    loadGroupsPage();
                } else if (page === 'profile' && profilePage) {
                    profilePage.classList.add('active');
                    refreshFollowCounts();
                }
            });
        });

        // ── SUPABASE CONFIG ───────────────────────────────────────────────────────
        const SUPABASE_URL = 'https://nygqoszurqvvdtndpufo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55Z3Fvc3p1cnF2dmR0bmRwdWZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NzU5NDksImV4cCI6MjA4NjM1MTk0OX0.KSd3SPRK2RULFCikjS7WpAlf8YvBiZnwsyA3OT6dzPY';

        window._ssCurrentUser = null;
        window._sbToken       = null;
        window._sbUserId      = null;
        window._refreshTimer  = null;

        async function sb(path, opts = {}) {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
                method: opts.method || 'GET',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${window._sbToken || SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': opts.prefer || 'return=representation',
                    ...opts.headers
                },
                body: opts.body ? JSON.stringify(opts.body) : undefined
            });
            if (!res.ok) {
                const e = await res.json().catch(() => ({}));
                throw new Error(e.message || e.error_description || res.statusText);
            }
            return res.status === 204 ? null : res.json();
        }

        async function sbAuth(endpoint, email, password) {
            const res = await fetch(`${SUPABASE_URL}/auth/v1/${endpoint}`, {
                method: 'POST',
                headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error_description || data.msg || 'Auth failed');
            return data;
        }

        async function refreshSession(refreshToken) {
            const res = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=refresh_token`, {
                method: 'POST',
                headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
                body: JSON.stringify({ refresh_token: refreshToken })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error_description || 'Refresh failed');
            return data;
        }

        function getCurrentUser() { return window._ssCurrentUser; }
        function setCurrentUser(u) { window._ssCurrentUser = u; }

        function saveSession(data) {
            try {
                const sess = {
                    access_token: data.access_token,
                    refresh_token: data.refresh_token || data.session?.refresh_token || null,
                    user_id: data.user?.id || data.session?.user?.id,
                    expires_at: data.expires_at || (Date.now()/1000 + (data.expires_in || 3600))
                };
                localStorage.setItem('sb_session', JSON.stringify(sess));
                sessionStorage.setItem('sb_session', JSON.stringify(sess));
            } catch(e) {}
        }

        function scheduleTokenRefresh(sess) {
            if (window._refreshTimer) clearTimeout(window._refreshTimer);
            const expiresIn = (sess.expires_at - Date.now()/1000) * 1000;
            const delay = Math.max(60000, expiresIn - 300000);
            window._refreshTimer = setTimeout(async () => {
                if (!sess.refresh_token) return;
                try {
                    const newData = await refreshSession(sess.refresh_token);
                    window._sbToken = newData.access_token;
                    saveSession(newData);
                    scheduleTokenRefresh({ ...sess, expires_at: newData.expires_at || (Date.now()/1000 + 3600), refresh_token: newData.refresh_token || sess.refresh_token });
                } catch(e) { console.warn('Token refresh failed:', e.message); }
            }, delay);
        }

        // ── AUTH UI ────────────────────────────────────────────────────────────
        function showSignup() {
            const sp = document.getElementById('signupPage');
            const lp = document.getElementById('loginPage');
            if (sp) { sp.style.display = 'flex'; sp.classList.add('active'); }
            if (lp) { lp.style.display = 'none';  lp.classList.remove('active'); }
            clearAuthErrors();
        }
        function showLogin() {
            const lp = document.getElementById('loginPage');
            const sp = document.getElementById('signupPage');
            if (lp) { lp.style.display = 'flex'; lp.classList.add('active'); }
            if (sp) { sp.style.display = 'none';  sp.classList.remove('active'); }
            clearAuthErrors();
        }
        function logout() {
            window._ssCurrentUser = null; window._sbToken = null; window._sbUserId = null;
            if (window._refreshTimer) clearTimeout(window._refreshTimer);
            try { localStorage.removeItem('sb_session'); sessionStorage.removeItem('sb_session'); } catch(e) {}
            document.querySelectorAll('.feed-page,.progress-page,.groups-page,.profile-page').forEach(p => p.classList.remove('active'));
            showSignup();
        }
        function showAuthError(formId, msg) {
            const el = document.getElementById(formId + 'Error');
            if (el) { el.textContent = msg; el.style.display = 'block'; }
        }
        function clearAuthErrors() {
            document.querySelectorAll('.auth-error').forEach(el => { el.textContent = ''; el.style.display = 'none'; });
        }

        async function handleSignup() {
            const fullName = document.getElementById('signupName').value.trim();
            const username = document.getElementById('signupUsername').value.trim().toLowerCase();
            const email    = document.getElementById('signupEmail').value.trim().toLowerCase();
            const password = document.getElementById('signupPassword').value;
            if (!fullName || !username || !email || !password) { showAuthError('signup','Please fill in all fields.'); return; }
            if (username.length < 3) { showAuthError('signup','Username must be at least 3 characters.'); return; }
            if (password.length < 6) { showAuthError('signup','Password must be at least 6 characters.'); return; }
            const btn = document.querySelector('#signupForm .auth-submit-btn');
            btn.textContent = 'Creating...'; btn.disabled = true;
            try {
                const taken = await sb(`profiles?username=eq.${username}&select=id`);
                if (taken && taken.length > 0) { showAuthError('signup','Username already taken.'); btn.textContent='Create Account'; btn.disabled=false; return; }
                const authData = await sbAuth('signup', email, password);
                const userId = authData.user?.id || authData.session?.user?.id;
                const token  = authData.access_token || authData.session?.access_token;
                if (!userId) { showAuthError('signup', 'Please check your email and confirm your account, then log in.'); btn.textContent='Create Account'; btn.disabled=false; return; }
                window._sbToken = token; window._sbUserId = userId;
                if (token) saveSession({ access_token: token, refresh_token: authData.refresh_token || authData.session?.refresh_token, user: { id: userId }, expires_at: authData.expires_at || (Date.now()/1000+3600) });
                const initials = fullName.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
                const profile = { id: userId, username, full_name: fullName, initials, bio: '', followers: 0, following: 0 };
                await sb('profiles', { method:'POST', body: profile });
                profile.workouts = []; profile.fullName = fullName;
                setCurrentUser(profile);
                loadProfileForUser(profile);
                scheduleTokenRefresh({ expires_at: authData.expires_at||(Date.now()/1000+3600), refresh_token: authData.refresh_token||authData.session?.refresh_token });
                await loadFeedFromSupabase();
                navigateToFeed();
            } catch(err) { showAuthError('signup', err.message); btn.textContent='Create Account'; btn.disabled=false; }
        }

        async function handleLogin() {
            const identifier = document.getElementById('loginIdentifier').value.trim().toLowerCase();
            const password   = document.getElementById('loginPassword').value;
            if (!identifier || !password) { showAuthError('login','Please fill in all fields.'); return; }
            const btn = document.querySelector('#loginForm .auth-submit-btn');
            btn.textContent = 'Logging in...'; btn.disabled = true;
            try {
                let email = identifier;
                if (!identifier.includes('@')) { showAuthError('login','Please use your email address to log in.'); btn.textContent='Log In'; btn.disabled=false; return; }
                const authData = await sbAuth('token?grant_type=password', email, password);
                window._sbToken = authData.access_token; window._sbUserId = authData.user.id;
                saveSession(authData);
                scheduleTokenRefresh({ expires_at: authData.expires_at||(Date.now()/1000+3600), refresh_token: authData.refresh_token });
                // Fetch profile + workouts in parallel
                const [profiles, workouts] = await Promise.all([
                    sb(`profiles?id=eq.${authData.user.id}&select=*`),
                    sb(`workouts?user_id=eq.${authData.user.id}&order=created_at.desc&select=*`)
                ]);
                let profile = profiles && profiles[0];
                if (!profile) {
                    profile = { id: authData.user.id, username: email.split('@')[0], full_name: email.split('@')[0], initials: email.slice(0,2).toUpperCase(), bio:'', followers:0, following:0 };
                    await sb('profiles', { method:'POST', body: profile });
                }
                profile.workouts = workouts || []; profile.fullName = profile.full_name;
                setCurrentUser(profile);
                loadProfileForUser(profile);
                await loadFeedFromSupabase();
                navigateToFeed();
            } catch(err) { showAuthError('login', err.message.includes('Invalid') ? 'Incorrect email or password.' : err.message); btn.textContent='Log In'; btn.disabled=false; }
        }

        // ── SESSION RESTORE ────────────────────────────────────────────────────
        (async function init() {
            try {
                const stored = localStorage.getItem('sb_session') || sessionStorage.getItem('sb_session');
                if (stored) {
                    const sess = JSON.parse(stored);
                    if (sess.expires_at > Date.now()/1000) {
                        window._sbToken = sess.access_token; window._sbUserId = sess.user_id;
                    } else if (sess.refresh_token) {
                        console.log('Token expired, refreshing...');
                        const newData = await refreshSession(sess.refresh_token);
                        window._sbToken = newData.access_token; window._sbUserId = sess.user_id;
                        saveSession({ ...newData, user: { id: sess.user_id } });
                        sess.expires_at = newData.expires_at || (Date.now()/1000+3600);
                        sess.refresh_token = newData.refresh_token || sess.refresh_token;
                    } else { showSignup(); return; }
                    scheduleTokenRefresh(sess);
                    const [profiles, workouts] = await Promise.all([
                        sb(`profiles?id=eq.${window._sbUserId}&select=*`),
                        sb(`workouts?user_id=eq.${window._sbUserId}&order=created_at.desc&select=*`)
                    ]);
                    if (profiles && profiles[0]) {
                        profiles[0].workouts = workouts || []; profiles[0].fullName = profiles[0].full_name;
                        setCurrentUser(profiles[0]);
                        loadProfileForUser(profiles[0]);
                        await loadFeedFromSupabase();
                        navigateToFeed(); return;
                    }
                }
            } catch(e) { console.warn('Session restore failed:', e.message); }
            showSignup();
        })();

        // ── FOLLOW SYSTEM ─────────────────────────────────────────────────────
        let userFollowing = new Set();

        async function loadFollowing() {
            if (!window._sbUserId) return;
            try {
                const rows = await sb(`follows?follower_id=eq.${window._sbUserId}&select=following_id`);
                userFollowing = new Set((rows||[]).map(r => r.following_id));
            } catch(e) { userFollowing = new Set(); }
        }

        async function followUser(targetId) {
            try {
                await sb('follows', { method:'POST', body:{ follower_id: window._sbUserId, following_id: targetId } });
                userFollowing.add(targetId);
                await sb(`profiles?id=eq.${targetId}`, { method:'PATCH', body:{ followers: null }, prefer:'return=minimal' });
            } catch(e) { console.warn('Follow error:', e.message); }
        }

        async function unfollowUser(targetId) {
            try {
                await sb(`follows?follower_id=eq.${window._sbUserId}&following_id=eq.${targetId}`, { method:'DELETE', prefer:'return=minimal' });
                userFollowing.delete(targetId);
            } catch(e) { console.warn('Unfollow error:', e.message); }
        }

        async function refreshFollowCounts() {
            if (!window._sbUserId) return;
            try {
                await loadFollowing();
                const user = getCurrentUser();
                if (!user) return;
                const following = userFollowing.size;
                const frs = await sb(`follows?following_id=eq.${window._sbUserId}&select=follower_id`);
                const followers = (frs||[]).length;
                const pf = document.getElementById('profileFollowers');
                const pg = document.getElementById('profileFollowing');
                if (pf) pf.textContent = followers;
                if (pg) pg.textContent = following;
            } catch(e) {}
        }

        async function toggleFollowOnProfile() {
            const btn = document.getElementById('viewUserFollowBtn');
            const uid = btn ? btn.dataset.uid : null;
            if (!uid || !window._sbUserId) return;
            const isFollowing = userFollowing.has(uid);
            if (isFollowing) { await unfollowUser(uid); btn.textContent = 'Follow'; btn.style.background = 'var(--primary)'; btn.style.color = '#fff'; }
            else { await followUser(uid); btn.textContent = 'Following'; btn.style.background = 'transparent'; btn.style.color = 'var(--primary)'; }
        }

        async function toggleFollowFromCard(targetId, btn) {
            const isFollowing = userFollowing.has(targetId);
            if (isFollowing) { await unfollowUser(targetId); btn.textContent = '+ Follow'; btn.style.background = 'var(--primary)'; btn.style.color = '#fff'; }
            else { await followUser(targetId); btn.textContent = 'Following'; btn.style.background = 'transparent'; btn.style.color = 'var(--primary)'; }
            if (currentFeedTab === 'following') await loadFeedFromSupabase();
        }

        // ── FEED ────────────────────────────────────────────────────────────────
        let currentFeedTab = 'everyone';
        let _feedCache = null; // cache of all workouts for fast tab switching

        async function switchFeedTab(tab, btn) {
            currentFeedTab = tab;
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            if (btn) btn.classList.add('active');
            renderFeedFromCache();
        }

        function toggleFeedSearch(btn) {
            const wrap = document.getElementById('feedSearchWrap');
            const input = document.getElementById('userSearchInput');
            const open = wrap.style.display === 'none';
            wrap.style.display = open ? 'block' : 'none';
            if (open) { input.focus(); btn.style.borderColor='var(--primary)'; btn.style.color='var(--primary)'; }
            else { input.value=''; document.getElementById('userSearchResults').style.display='none'; btn.style.borderColor='#2a2a2a'; btn.style.color='#888'; }
        }

        function renderFeedFromCache() {
            if (!_feedCache) return;
            const feed = document.getElementById('mainFeed');
            if (!feed) return;

            let workouts = _feedCache;
            if (currentFeedTab === 'following') {
                workouts = _feedCache.filter(w => userFollowing.has(w.user_id) || w.user_id === window._sbUserId);
            } else if (currentFeedTab === 'mine') {
                workouts = _feedCache.filter(w => w.user_id === window._sbUserId);
            }

            const emptyState = document.getElementById('feedEmptyState');
            if (workouts.length === 0) {
                if (emptyState) {
                    emptyState.style.display = 'block';
                    const msg = document.getElementById('feedEmptyMsg');
                    if (msg) {
                        if (currentFeedTab === 'following') msg.innerHTML = 'Follow people to see their workouts here!';
                        else if (currentFeedTab === 'mine') msg.innerHTML = "You haven't logged any workouts yet.<br>Hit the <strong style='color:var(--primary)'>+</strong> button to get started!";
                        else msg.innerHTML = 'Be the first to log a workout!<br>Hit the <strong style="color:var(--primary)">+</strong> button below.';
                    }
                }
                feed.innerHTML = '';
                if (emptyState) feed.appendChild(emptyState);
                return;
            }
            if (emptyState) emptyState.style.display = 'none';
            const frag = document.createDocumentFragment();
            workouts.forEach(w => frag.appendChild(buildWorkoutCard(w, w.profiles)));
            feed.innerHTML = '';
            if (emptyState) feed.appendChild(emptyState);
            feed.appendChild(frag);
        }

        async function loadFeedFromSupabase() {
            if (!window._sbUserId) return;
            await loadFollowing();
            const feed = document.getElementById('mainFeed');
            const emptyState = document.getElementById('feedEmptyState');

            // Show skeleton loading
            if (feed && (!_feedCache || _feedCache.length === 0)) {
                feed.innerHTML = [1,2,3].map(() => `
                    <div style="background:var(--steel);border-radius:12px;padding:16px;border:1px solid #2a2a2a;animation:pulse 1.5s ease-in-out infinite;">
                        <div style="display:flex;gap:10px;margin-bottom:12px;">
                            <div style="width:36px;height:36px;border-radius:50%;background:#2a2a2a;flex-shrink:0;"></div>
                            <div style="flex:1;"><div style="height:14px;background:#2a2a2a;border-radius:4px;margin-bottom:6px;width:40%;"></div>
                            <div style="height:10px;background:#222;border-radius:4px;width:25%;"></div></div>
                        </div>
                        <div style="height:20px;background:#2a2a2a;border-radius:4px;margin-bottom:8px;width:70%;"></div>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;">${[1,2,3].map(()=>'<div style="height:28px;background:#222;border-radius:20px;width:80px;"></div>').join('')}</div>
                    </div>`).join('');
            }

            try {
                // Single query: workouts + profiles joined
                const workouts = await sb('workouts?order=created_at.desc&limit=30&select=*,profiles(id,full_name,initials,username,avatar_url)');
                if (!workouts) return;

                // Batch fetch likes + comment counts in parallel (2 queries, not N)
                const ids = workouts.map(w => w.id);
                let likesMap = {}, commentMap = {};
                if (ids.length > 0) {
                    const idList = ids.join(',');
                    const [likes, comments] = await Promise.all([
                        sb(`workout_likes?workout_id=in.(${idList})&select=workout_id,user_id`).catch(()=>[]),
                        sb(`workout_comments?workout_id=in.(${idList})&select=workout_id`).catch(()=>[])
                    ]);
                    (likes||[]).forEach(l => { if(!likesMap[l.workout_id]) likesMap[l.workout_id]=[]; likesMap[l.workout_id].push(l.user_id); });
                    (comments||[]).forEach(c => { commentMap[c.workout_id] = (commentMap[c.workout_id]||0)+1; });
                }

                // Enrich workouts
                const enriched = workouts.map(w => ({
                    ...w,
                    likes: likesMap[w.id] || [],
                    commentCount: commentMap[w.id] || 0
                }));

                _feedCache = enriched;
                renderFeedFromCache();
            } catch(e) {
                console.warn('Feed load error:', e.message);
                if (feed) feed.innerHTML = '<div style="text-align:center;padding:40px;color:#555;font-family:Oswald,sans-serif;">Could not load feed. Pull to refresh.</div>';
            }
        }

        // ── WORKOUT CARD BUILDER ─────────────────────────────────────────────
        function buildWorkoutCard(w, profile) {
            const name      = profile?.full_name || 'Unknown';
            const initials  = profile?.initials  || '??';
            const avatarUrl = profile?.avatar_url;
            const userId    = profile?.id || w.user_id;
            const isMe      = userId === window._sbUserId;
            const isFollowing = userId && userFollowing.has(userId);
            const exercises = w.exercises || [];
            const likes     = w.likes || [];
            const likeCount = likes.length;
            const hasLiked  = likes.includes(window._sbUserId);
            const commentCount = w.commentCount || 0;
            const prExercises  = w.prExercises || [];
            const hasPR   = prExercises.length > 0;
            const dateStr = new Date(w.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});

            const avatarHTML = avatarUrl
                ? `<img src="${avatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" alt="" loading="lazy">`
                : initials;

            const followBtn = (!isMe && userId) ? `
                <button onclick="toggleFollowFromCard('${userId}',this)" data-uid="${userId}"
                    style="margin-left:auto;background:${isFollowing?'transparent':'var(--primary)'};border:2px solid var(--primary);
                    color:${isFollowing?'var(--primary)':'#fff'};padding:5px 12px;border-radius:20px;
                    font-family:'Oswald',sans-serif;font-size:11px;font-weight:600;text-transform:uppercase;
                    letter-spacing:1px;cursor:pointer;transition:all 0.2s;white-space:nowrap;">
                    ${isFollowing ? 'Following' : '+ Follow'}
                </button>` : '';

            const exNamesHTML = exercises.map(ex => {
                const isPR = prExercises.includes(ex.name);
                return `<span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,0.06);
                    border-radius:20px;padding:5px 12px;font-family:'Oswald',sans-serif;font-size:12px;
                    color:${isPR?'var(--accent)':'#ccc'};border:1px solid ${isPR?'rgba(255,179,71,0.3)':'rgba(255,255,255,0.08)'};">
                    ${ex.name}${isPR?' ★':''}
                </span>`;
            }).join('');

            const durationPill = w.duration
                ? `<span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,107,53,0.12);
                    border-radius:20px;padding:5px 12px;font-family:'Oswald',sans-serif;font-size:12px;
                    color:var(--primary);border:1px solid rgba(255,107,53,0.25);">${w.duration} MIN</span>` : '';

            const photoHTML = w.photo_url ? `
                <div style="position:relative;width:100%;padding-bottom:125%;overflow:hidden;background:#111;">
                    <img src="${w.photo_url}" alt="Workout" loading="lazy" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;">
                </div>` : '';

            const captionHTML = w.caption
                ? `<p style="font-size:14px;color:#ddd;padding:10px 14px 4px;line-height:1.5;">"${w.caption}"</p>` : '';

            const wData = JSON.stringify(w).replace(/'/g,'&#39;').replace(/"/g,'&quot;');

            const menuHTML = isMe ? `
                <button onclick="toggleWorkoutMenu('${w.id}',this)"
                    style="background:none;border:none;color:#555;font-size:22px;cursor:pointer;
                    padding:4px 6px;border-radius:6px;line-height:1;flex-shrink:0;
                    -webkit-tap-highlight-color:transparent;">⋯</button>
                <div id="wMenu_${w.id}" style="display:none;position:absolute;right:10px;top:46px;
                    background:#1e1e1e;border:1px solid #333;border-radius:12px;min-width:170px;
                    z-index:200;box-shadow:0 8px 24px rgba(0,0,0,0.7);overflow:hidden;">
                    <button onclick="openEditWorkout('${w.id}')"
                        style="width:100%;padding:13px 16px;background:none;border:none;border-bottom:1px solid #2a2a2a;
                        color:#fff;font-family:'Oswald',sans-serif;font-size:14px;text-align:left;cursor:pointer;
                        display:flex;align-items:center;gap:10px;"
                        onmouseover="this.style.background='rgba(255,107,53,0.1)'" onmouseout="this.style.background='none'">
                        ✏️ Edit Workout
                    </button>
                    <button onclick="confirmDeleteWorkout('${w.id}')"
                        style="width:100%;padding:13px 16px;background:none;border:none;
                        color:#f87171;font-family:'Oswald',sans-serif;font-size:14px;text-align:left;cursor:pointer;
                        display:flex;align-items:center;gap:10px;"
                        onmouseover="this.style.background='rgba(248,113,113,0.1)'" onmouseout="this.style.background='none'">
                        🗑 Delete Post
                    </button>
                </div>` : '';

            const card = document.createElement('div');
            card.className = 'activity-card';
            card.dataset.workoutId = w.id;
            card.innerHTML = `
                <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;position:relative;">
                    <div onclick="${!isMe && userId ? `viewUserProfile('${userId}')` : ''}"
                        style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));
                        display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;
                        font-size:14px;flex-shrink:0;overflow:hidden;${!isMe && userId ? 'cursor:pointer;' : ''}">
                        ${avatarHTML}
                    </div>
                    <div onclick="${!isMe && userId ? `viewUserProfile('${userId}')` : ''}" style="flex:1;min-width:0;${!isMe && userId ? 'cursor:pointer;' : ''}">
                        <div style="font-family:'Oswald',sans-serif;font-size:14px;font-weight:600;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${name}</div>
                        <div style="font-size:11px;color:#666;">${dateStr}</div>
                    </div>
                    ${followBtn}
                    ${menuHTML}
                </div>
                <div style="padding:4px 14px 10px;">
                    <span style="font-family:'Bebas Neue',cursive;font-size:20px;letter-spacing:1.5px;color:#fff;">${w.name.toUpperCase()}</span>
                    ${hasPR ? '<span style="background:var(--accent);color:#000;font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;margin-left:8px;vertical-align:middle;">PR</span>' : ''}
                </div>
                ${photoHTML}${captionHTML}
                <div style="display:flex;flex-wrap:wrap;gap:6px;padding:10px 14px 4px;">${durationPill}${exNamesHTML}</div>
                <div style="padding:8px 14px 12px;">
                    <button onclick="openWorkoutModal(this)" data-workout='${wData}'
                        style="width:100%;background:rgba(255,107,53,0.08);border:1px solid rgba(255,107,53,0.3);
                        color:var(--primary);padding:10px;border-radius:8px;font-family:'Oswald',sans-serif;
                        font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:1px;cursor:pointer;
                        transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="width:14px;height:14px;"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                        View Full Workout
                    </button>
                </div>
                <div style="display:flex;gap:0;border-top:1px solid #2a2a2a;">
                    <button class="action-btn like-btn" onclick="toggleLike('${w.id}',this)"
                        data-liked="${hasLiked}" data-wid="${w.id}"
                        style="flex:1;justify-content:center;color:${hasLiked?'var(--primary)':'#777'};border-right:1px solid #2a2a2a;border-radius:0 0 0 10px;">
                        <span class="like-icon" style="font-size:16px;">${hasLiked?'❤️':'🤍'}</span>
                        <span class="like-label">${likeCount} ${likeCount===1?'Like':'Likes'}</span>
                    </button>
                    <button class="action-btn" onclick="openWorkoutDetail('${w.id}',this)"
                        style="flex:1;justify-content:center;color:#777;border-radius:0 0 10px 0;">
                        <span style="font-size:15px;">💬</span>
                        <span class="comment-label-${w.id}">${commentCount} ${commentCount===1?'Comment':'Comments'}</span>
                    </button>
                </div>`;
            return card;
        }

        // ── USER SEARCH ─────────────────────────────────────────────────────
        function handleUserSearch(query) {
            const q = query.trim().toLowerCase().replace(/^@/,'');
            const resultsEl = document.getElementById('userSearchResults');
            if (!q || q.length < 2) { resultsEl.style.display='none'; return; }
            clearTimeout(window._searchDebounce);
            window._searchDebounce = setTimeout(async () => {
                try {
                    const users = await sb(`profiles?or=(full_name.ilike.*${q}*,username.ilike.*${q}*)&select=id,full_name,username,initials,avatar_url&limit=8`);
                    if (!users || users.length === 0) { resultsEl.style.display='none'; return; }
                    resultsEl.style.display = 'block';
                    resultsEl.innerHTML = users.map(u => `
                        <div onclick="viewUserProfile('${u.id}')" style="display:flex;align-items:center;gap:12px;
                            padding:12px 16px;cursor:pointer;transition:background 0.2s;border-bottom:1px solid #2a2a2a;"
                            onmouseover="this.style.background='rgba(255,107,53,0.08)'" onmouseout="this.style.background=''">
                            <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));
                                display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:14px;flex-shrink:0;overflow:hidden;">
                                ${u.avatar_url ? `<img src="${u.avatar_url}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" loading="lazy">` : u.initials||'?'}
                            </div>
                            <div>
                                <div style="font-family:'Oswald',sans-serif;font-size:14px;font-weight:600;">${u.full_name}</div>
                                <div style="font-size:12px;color:#666;">@${u.username}</div>
                            </div>
                        </div>`).join('');
                } catch(e) { resultsEl.style.display='none'; }
            }, 280);
        }

        // ── PROFILE ──────────────────────────────────────────────────────────
        function loadProfileForUser(user) {
            const el = id => document.getElementById(id);
            if (el('profileName'))     el('profileName').textContent     = user.full_name || user.fullName || '';
            if (el('profileUsername')) el('profileUsername').textContent  = '@' + (user.username||'');
            if (el('profileBio'))      el('profileBio').textContent       = user.bio || 'No bio yet.';
            if (el('profileInitials')) el('profileInitials').textContent  = user.initials || '';
            if (el('profileFollowers')) el('profileFollowers').textContent = user.followers || 0;
            if (el('profileFollowing')) el('profileFollowing').textContent = user.following || 0;
            refreshProfileStats(user);
            refreshProfileWorkouts(user);
            refreshAchievements(user);
        }

        function switchProfileTab(tabName) {
            document.querySelectorAll('.profile-tab').forEach(t => {
                t.classList.toggle('active', t.getAttribute('onclick')?.includes(tabName));
            });
            document.querySelectorAll('.profile-tab-content').forEach(c => c.classList.remove('active'));
            const tc = document.getElementById(tabName + '-tab');
            if (tc) tc.classList.add('active');
            const u = getCurrentUser();
            if (!u) return;
            if (tabName === 'stats')        refreshProfileStats(u);
            if (tabName === 'workouts')     refreshProfileWorkouts(u);
            if (tabName === 'achievements') refreshAchievements(u);
            if (tabName === 'groups')       loadProfileGroups();
        }

        function refreshProfileStats(user) {
            const workouts = user.workouts || [];
            const el = id => document.getElementById(id);
            if (el('statTotalWorkouts'))  el('statTotalWorkouts').textContent  = workouts.length;
            if (el('statTotalExercises')) el('statTotalExercises').textContent = workouts.reduce((s,w) => s+(w.exercises?.length||0), 0);
            if (el('statTotalMinutes'))   el('statTotalMinutes').textContent   = workouts.reduce((s,w) => s+(parseInt(w.duration)||0), 0);
            if (el('profileWorkoutCount')) el('profileWorkoutCount').textContent = workouts.length;
            const list = document.getElementById('recentWorkoutsList');
            if (list) {
                if (workouts.length === 0) { list.innerHTML = '<p style="color:#999;text-align:center;padding:30px;">No workouts yet.</p>'; return; }
                list.innerHTML = `<h3 style="font-family:'Bebas Neue',cursive;font-size:22px;letter-spacing:2px;color:var(--primary);margin-bottom:15px;">Recent Workouts</h3>` +
                    workouts.slice(0,10).map(w => `<div style="background:var(--steel);border-left:3px solid var(--primary);padding:15px 20px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;border-radius:0 8px 8px 0;">
                        <div><div style="font-family:'Bebas Neue',cursive;font-size:18px;letter-spacing:1px;">${w.name.toUpperCase()}</div>
                        <div style="font-size:12px;color:#999;margin-top:3px;">${w.exercises?.length||0} exercises · ${w.duration||0} min</div></div>
                        <div style="font-size:12px;color:#666;font-family:'Roboto Mono',monospace;">${new Date(w.created_at||w.date).toLocaleDateString()}</div>
                    </div>`).join('');
            }
        }

        // ── TOAST ─────────────────────────────────────────────────────────────
        function showToast(msg) {
            let t = document.getElementById('_toast');
            if (!t) { t = document.createElement('div'); t.id='_toast'; t.style.cssText='position:fixed;bottom:calc(90px + env(safe-area-inset-bottom));left:50%;transform:translateX(-50%) translateY(20px);background:#1e1e1e;border:1px solid var(--primary);color:#fff;padding:10px 20px;border-radius:20px;font-family:Oswald,sans-serif;font-size:14px;font-weight:600;letter-spacing:1px;z-index:9999;opacity:0;transition:all 0.25s;white-space:nowrap;pointer-events:none;'; document.body.appendChild(t); }
            t.textContent = msg;
            requestAnimationFrame(() => { t.style.opacity='1'; t.style.transform='translateX(-50%) translateY(0)'; });
            clearTimeout(t._timer);
            t._timer = setTimeout(() => { t.style.opacity='0'; t.style.transform='translateX(-50%) translateY(10px)'; }, 2200);
        }

        // ── MODAL / WORKOUT LOG ───────────────────────────────────────────────
        window._logMode = 'personal'; window._logGroupId = null; window._logGroupName = null;

        function openModal() {
            window._logMode = window._logMode || 'personal';
            const tag = document.getElementById('logModeTag');
            const step2Title = document.getElementById('logStep2Title');
            if (tag) { tag.style.display = window._logMode==='group' ? 'inline-block' : 'none'; tag.textContent = window._logGroupName||''; }
            if (step2Title) step2Title.textContent = window._logMode==='group' ? `Post to ${window._logGroupName}` : 'Workout Details';
            const modal = document.getElementById('workoutModal');
            if (modal) { modal.classList.add('active'); document.body.style.overflow='hidden'; }
            const s1 = document.getElementById('step1');
            const s2 = document.getElementById('step2');
            if (s1) s1.style.display='block';
            if (s2) s2.style.display='none';
        }

        function closeModal() {
            const modal = document.getElementById('workoutModal');
            if (modal) modal.classList.remove('active');
            document.body.style.overflow='';
            window._logMode='personal'; window._logGroupId=null; window._logGroupName=null;
        }

        function openLogPicker() {
            const sheet = document.getElementById('logPickerSheet');
            if (!sheet) { openModal(); return; }
            window._logMode = 'personal';
            sheet.style.display = 'flex';
            requestAnimationFrame(() => {
                sheet.style.background = 'rgba(0,0,0,0.75)';
                const inner = document.getElementById('logPickerInner');
                if (inner) inner.style.transform = 'translateY(0)';
                loadPickerGroups();
            });
            document.body.style.overflow = 'hidden';
        }

        function closeLogPicker() {
            const sheet = document.getElementById('logPickerSheet');
            const inner = document.getElementById('logPickerInner');
            if (sheet) sheet.style.background = 'rgba(0,0,0,0)';
            if (inner) inner.style.transform = 'translateY(100%)';
            setTimeout(() => { if (sheet) sheet.style.display='none'; document.body.style.overflow=''; }, 280);
        }

        function startPersonalLog() { window._logMode='personal'; window._logGroupId=null; window._logGroupName=null; closeLogPicker(); openModal(); }

        function startGroupLog(groupId, groupName) { window._logMode='group'; window._logGroupId=groupId; window._logGroupName=groupName; closeLogPicker(); openModal(); }

        function startGroupLogFromDetail(groupId, groupName) { window._logMode='group'; window._logGroupId=groupId; window._logGroupName=groupName; openModal(); }

        async function loadPickerGroups() {
            const list = document.getElementById('pickerGroupList');
            if (!list || !window._sbUserId) return;
            list.innerHTML = '<div style="color:#555;font-size:13px;padding:10px;font-family:Oswald,sans-serif;">Loading...</div>';
            try {
                const memberships = await sb(`group_members?user_id=eq.${window._sbUserId}&select=role,groups(id,name,cover_url)`);
                if (!memberships || memberships.length === 0) { list.innerHTML = '<div style="color:#555;font-size:13px;padding:10px;font-family:Oswald,sans-serif;text-align:center;">No groups yet</div>'; return; }
                list.innerHTML = memberships.map(m => {
                    const g = m.groups;
                    return `<div onclick="startGroupLog('${g.id}','${g.name.replace(/'/g,"\'")}'); event.stopPropagation();"
                        style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:#1e1e1e;border-radius:10px;
                        cursor:pointer;transition:background 0.2s;border:1px solid #2a2a2a;margin-bottom:8px;"
                        onmouseover="this.style.background='rgba(255,107,53,0.08)'" onmouseout="this.style.background='#1e1e1e'">
                        <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));
                            display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:16px;flex-shrink:0;overflow:hidden;">
                            ${g.cover_url ? `<img src="${g.cover_url}" style="width:100%;height:100%;object-fit:cover;" loading="lazy">` : g.name[0]}
                        </div>
                        <div style="flex:1;min-width:0;"><div style="font-family:'Oswald',sans-serif;font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${g.name}</div>
                        <div style="font-size:11px;color:#555;">${m.role}</div></div>
                        <svg viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2" stroke-linecap="round" style="width:16px;height:16px;flex-shrink:0;"><polyline points="9 18 15 12 9 6"/></svg>
                    </div>`;
                }).join('');
            } catch(e) { list.innerHTML = `<div style="color:#555;font-size:13px;padding:10px;">Error: ${e.message}</div>`; }
        }

        function addExercise() {
            const container = document.getElementById('exerciseContainer');
            if (!container) return;
            const row = document.createElement('div'); row.className='exercise-inputs';
            row.innerHTML = `<input type="text" placeholder="Exercise name"><input type="number" placeholder="Sets"><input type="number" placeholder="Reps"><input type="number" placeholder="Weight (lbs)">`;
            container.appendChild(row);
        }

        function handlePhotoSelect(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.getElementById('previewImage');
                const zone = document.getElementById('photoZone');
                const rm = document.getElementById('removePhoto');
                if (img) { img.src=e.target.result; img.style.display='block'; }
                if (zone) zone.classList.add('has-image');
                if (rm) rm.style.display='flex';
                const icon = zone?.querySelector('.upload-icon'), txt = zone?.querySelector('.upload-text');
                if (icon) icon.style.display='none'; if (txt) txt.style.display='none';
            };
            reader.readAsDataURL(file);
        }

        function removeWorkoutPhoto() {
            const img=document.getElementById('previewImage'), zone=document.getElementById('photoZone'), rm=document.getElementById('removePhoto'), inp=document.getElementById('photoInput');
            if(img){img.src='';img.style.display='none';}  if(zone)zone.classList.remove('has-image'); if(rm)rm.style.display='none'; if(inp)inp.value='';
            const icon=zone?.querySelector('.upload-icon'), txt=zone?.querySelector('.upload-text');
            if(icon)icon.style.display='block'; if(txt)txt.style.display='block';
        }

        function goToStep2() {
            const name = document.getElementById('workoutName')?.value.trim();
            const type = document.getElementById('workoutType')?.value;
            if (!name) { alert('Please enter a workout name.'); return; }
            if (!type) { alert('Please select a workout type.'); return; }
            document.getElementById('step1').style.display='none';
            document.getElementById('step2').style.display='block';
        }

        function goBackToStep1() {
            document.getElementById('step1').style.display='block';
            document.getElementById('step2').style.display='none';
        }

        function addStep2Exercise() {
            const container = document.getElementById('exerciseContainerStep2');
            if (!container) return;
            const presets = ['Preset 1','Preset 2'];
            const row = document.createElement('div'); row.className='exercise-inputs';
            row.innerHTML=`<input type="text" placeholder="Exercise name"><input type="number" placeholder="Sets"><input type="number" placeholder="Reps"><input type="number" placeholder="Weight (lbs)">`;
            container.appendChild(row);
        }

        async function handleLogWorkout() {
            const workoutName = document.getElementById('workoutName')?.value.trim();
            const duration    = parseInt(document.getElementById('workoutDuration')?.value)||0;
            const caption     = document.getElementById('captionInput')?.value.trim();
            const previewImg  = document.getElementById('previewImage');
            const photoSrc    = previewImg?.style.display!=='none' && previewImg?.src ? previewImg.src : null;
            if (!workoutName) { alert('Please enter a workout name.'); return; }

            const exerciseRows = document.querySelectorAll('#exerciseContainer .exercise-inputs');
            const exercises = [];
            exerciseRows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const name = inputs[0]?.value.trim();
                if (name) exercises.push({ name, sets:inputs[1]?.value||'', reps:inputs[2]?.value||'', weight:inputs[3]?.value||'' });
            });

            const user = getCurrentUser();
            if (!user) { alert('Please log in first.'); return; }
            const groupId = window._logMode==='group' ? window._logGroupId : null;

            const submitBtn = document.getElementById('logSubmitBtn') || document.querySelector('[onclick="handleLogWorkout()"]');
            if (submitBtn) { submitBtn.textContent='Posting...'; submitBtn.disabled=true; }

            try {
                const workoutRecord = { user_id: window._sbUserId, name: workoutName, duration, caption: caption||null, exercises, photo_url: photoSrc||null };
                const saved = await sb('workouts', { method:'POST', body: workoutRecord });
                const savedWorkout = saved && saved[0] ? saved[0] : { ...workoutRecord, id: Date.now().toString(), created_at: new Date().toISOString() };

                if (groupId) {
                    await sb('group_challenges', { method:'POST', body: { group_id: groupId, creator_id: window._sbUserId, title: workoutName, description: caption||null, exercises } });
                    showToast(`Posted to ${window._logGroupName}! 💪`);
                } else {
                    showToast('Workout posted! 💪');
                }

                if (!user.workouts) user.workouts=[];
                user.workouts.unshift(savedWorkout);
                setCurrentUser(user);
                refreshProfileStats(user);
                refreshProfileWorkouts(user);
                refreshAchievements(user);

                // Reset form
                document.getElementById('workoutForm')?.reset();
                removeWorkoutPhoto();
                const ec = document.getElementById('exerciseContainer');
                if (ec) ec.innerHTML=`<div class="exercise-inputs"><input type="text" placeholder="Exercise name"><input type="number" placeholder="Sets"><input type="number" placeholder="Reps"><input type="number" placeholder="Weight (lbs)"></div>`;

                closeModal();
                await loadFeedFromSupabase();
                navigateToFeed();
            } catch(e) {
                alert('Error posting workout: ' + e.message);
            } finally {
                if (submitBtn) { submitBtn.textContent='Post Workout'; submitBtn.disabled=false; }
            }
        }

        // ── VIEW OTHER USER PROFILE ─────────────────────────────────────────
        async function viewUserProfile(userId) {
            if (userId === window._sbUserId) {
                document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
                document.querySelector('.nav-link[data-page="profile"]')?.classList.add('active');
                document.querySelectorAll('.feed-page,.progress-page,.groups-page,.profile-page').forEach(p=>p.classList.remove('active'));
                document.querySelector('.profile-page')?.classList.add('active');
                return;
            }
            try {
                const [profiles, workouts] = await Promise.all([
                    sb(`profiles?id=eq.${userId}&select=*`),
                    sb(`workouts?user_id=eq.${userId}&order=created_at.desc&select=*`)
                ]);
                const profile = profiles && profiles[0]; if (!profile) return;
                const isFollowing = userFollowing.has(userId);
                const view = document.getElementById('userProfileView');
                if (!view) return;
                document.getElementById('viewUserName').textContent = profile.full_name||'';
                document.getElementById('viewUserUsername').textContent = '@'+(profile.username||'');
                document.getElementById('viewUserBio').textContent = profile.bio||'No bio yet.';
                document.getElementById('viewUserInitials').textContent = profile.initials||'';
                document.getElementById('viewUserWorkoutCount').textContent = (workouts||[]).length;
                document.getElementById('viewUserFollowers').textContent = profile.followers||0;
                document.getElementById('viewUserFollowing').textContent = profile.following||0;
                const followBtn = document.getElementById('viewUserFollowBtn');
                if (followBtn) { followBtn.dataset.uid=userId; followBtn.textContent=isFollowing?'Following':'Follow'; followBtn.style.background=isFollowing?'transparent':'var(--primary)'; followBtn.style.color=isFollowing?'var(--primary)':'#fff'; }
                const wfeed = document.getElementById('viewUserWorkoutFeed');
                if (wfeed) {
                    wfeed.innerHTML = (workouts||[]).map(w => {
                        const photo = w.photo_url ? `<div style="width:100%;padding-bottom:125%;position:relative;overflow:hidden;background:#111;"><img src="${w.photo_url}" loading="lazy" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;"></div>` : '';
                        const caption = w.caption ? `<p style="font-size:14px;color:#ddd;padding:10px 14px 4px;">"${w.caption}"</p>` : '';
                        const exPills = (w.exercises||[]).map(ex=>`<span style="background:rgba(255,255,255,0.06);border-radius:20px;padding:5px 12px;font-family:'Oswald',sans-serif;font-size:12px;color:#ccc;">${ex.name}</span>`).join('');
                        return `<div class="activity-card" style="margin-bottom:16px;">
                            <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;">
                                <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:14px;flex-shrink:0;">${profile.initials||'?'}</div>
                                <div><div style="font-family:'Oswald',sans-serif;font-size:14px;font-weight:600;">${profile.full_name||''}</div><div style="font-size:11px;color:#666;">${new Date(w.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</div></div>
                            </div>
                            <div style="padding:4px 14px 10px;font-family:'Bebas Neue',cursive;font-size:20px;letter-spacing:1.5px;">${w.name.toUpperCase()}</div>
                            ${photo}${caption}
                            <div style="display:flex;flex-wrap:wrap;gap:6px;padding:10px 14px;">${exPills}</div>
                        </div>`;
                    }).join('') || '<div style="text-align:center;padding:40px;color:#555;">No workouts yet</div>';
                }
                document.querySelectorAll('.feed-page,.progress-page,.groups-page,.profile-page').forEach(p=>p.classList.remove('active'));
                view.style.display='block';
                document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
            } catch(e) { console.warn('viewUserProfile error:', e.message); }
        }

        // ── PROFILE EDITING ───────────────────────────────────────────────────
        function openEditProfile() {
            const user = getCurrentUser(); if (!user) return;
            document.getElementById('editProfileName').value = user.full_name||user.fullName||'';
            document.getElementById('editProfileUsername').value = user.username||'';
            document.getElementById('editProfileBio').value = user.bio||'';
            const sheet = document.getElementById('editProfileSheet');
            if (sheet) { sheet.style.display='flex'; requestAnimationFrame(()=>{ sheet.style.background='rgba(0,0,0,0.75)'; document.getElementById('editProfileInner').style.transform='translateY(0)'; }); }
            document.body.style.overflow='hidden';
        }
        function closeEditProfile() {
            const sheet=document.getElementById('editProfileSheet'), inner=document.getElementById('editProfileInner');
            if(sheet) sheet.style.background='rgba(0,0,0,0)'; if(inner) inner.style.transform='translateY(100%)';
            setTimeout(()=>{ if(sheet) sheet.style.display='none'; document.body.style.overflow=''; },280);
        }
        async function saveProfileEdit() {
            const user = getCurrentUser(); if (!user) return;
            const fullName = document.getElementById('editProfileName')?.value.trim();
            const username = document.getElementById('editProfileUsername')?.value.trim().toLowerCase();
            const bio      = document.getElementById('editProfileBio')?.value.trim();
            if (!fullName || !username) { alert('Name and username are required.'); return; }
            const btn = document.getElementById('saveProfileBtn');
            if (btn) { btn.textContent='Saving...'; btn.disabled=true; }
            try {
                const initials = fullName.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
                await sb(`profiles?id=eq.${window._sbUserId}`, { method:'PATCH', body:{ full_name: fullName, username, bio, initials }, prefer:'return=minimal' });
                user.full_name=fullName; user.fullName=fullName; user.username=username; user.bio=bio; user.initials=initials;
                setCurrentUser(user); loadProfileForUser(user);
                closeEditProfile(); showToast('Profile updated!');
            } catch(e) { alert('Error saving profile: '+e.message); }
            finally { if(btn){ btn.textContent='Save'; btn.disabled=false; } }
        }
        function handleAvatarSelect(input) {
            const file=input.files[0]; if (!file) return;
            const reader=new FileReader();
            reader.onload=e=>{ const img=document.getElementById('editAvatarPreview'); if(img){ img.src=e.target.result; img.style.display='block'; document.getElementById('editAvatarInitials').style.display='none'; }};
            reader.readAsDataURL(file);
        }

        // ── FOLLOWERS / FOLLOWING MODALS ──────────────────────────────────────
        function openFollowersModal() { /* simplified - show toast */ showToast('Followers list coming soon!'); }
        function openFollowingModal() { showToast('Following list coming soon!'); }

        // ── PROFILE ACHIEVEMENTS ──────────────────────────────────────────────
        function refreshAchievements(user) {
            const grid=document.getElementById('achievementsGrid'); if(!grid) return;
            const workouts=user.workouts||[], count=workouts.length;
            const totalMinutes=workouts.reduce((s,w)=>s+(parseInt(w.duration)||0),0);
            const allExNames=new Set(workouts.flatMap(w=>(w.exercises||[]).map(e=>e.name.toLowerCase())));
            function hasWorkoutsInWeek(n){const weeks={};workouts.forEach(w=>{const d=new Date(w.created_at||w.date);const k=`${d.getFullYear()}-W${Math.floor((d-new Date(d.getFullYear(),0,1))/604800000)}`;weeks[k]=(weeks[k]||0)+1;});return Object.values(weeks).some(v=>v>=n);}
            function hasWeeklyStreak(weeks){if(!workouts.length) return false;const wns=[...new Set(workouts.map(w=>{const d=new Date(w.created_at||w.date);return `${d.getFullYear()}-W${Math.floor((d-new Date(d.getFullYear(),0,1))/604800000)}`;}))].sort();let streak=1,best=1;for(let i=1;i<wns.length;i++){const p=wns[i-1].split('-W'),c=wns[i].split('-W');const diff=(parseInt(c[1])-parseInt(p[1]))+(parseInt(c[0])-parseInt(p[0]))*52;streak=diff===1?streak+1:1;best=Math.max(best,streak);}return best>=weeks;}
            const all=[
                {icon:'🥇',title:'First Rep',desc:'Log your first workout',earned:count>=1},
                {icon:'🔟',title:'10 Workout Club',desc:'Log 10 workouts',earned:count>=10},
                {icon:'🏆',title:'25 Workout Club',desc:'Log 25 workouts',earned:count>=25},
                {icon:'💯',title:'100 Workout Club',desc:'Log 100 workouts',earned:count>=100},
                {icon:'⏱️',title:'Hour Grinder',desc:'Log 60+ min workout',earned:workouts.some(w=>(w.duration||0)>=60)},
                {icon:'🕗',title:'Time Warrior',desc:'1,000 total minutes',earned:totalMinutes>=1000},
                {icon:'💪',title:'Variety Pack',desc:'5 different exercises',earned:allExNames.size>=5},
                {icon:'🔥',title:'On Fire',desc:'3 workouts in one week',earned:hasWorkoutsInWeek(3)},
                {icon:'⚡',title:'Consistent',desc:'2 weeks in a row',earned:hasWeeklyStreak(2)},
                {icon:'🦾',title:'Iron Habit',desc:'4 weeks in a row',earned:hasWeeklyStreak(4)},
            ];
            const earned=all.filter(a=>a.earned), locked=all.filter(a=>!a.earned);
            grid.innerHTML=(earned.length?`<div style="grid-column:1/-1;font-family:'Bebas Neue',cursive;font-size:18px;letter-spacing:2px;color:var(--primary);padding:10px 0 5px;">EARNED (${earned.length})</div>`+earned.map(a=>`<div class="achievement-card" style="border-color:var(--primary);"><div class="achievement-icon">${a.icon}</div><div class="achievement-title">${a.title}</div><div class="achievement-description">${a.desc}</div></div>`).join(''):'')+(locked.length?`<div style="grid-column:1/-1;font-family:'Bebas Neue',cursive;font-size:18px;letter-spacing:2px;color:#555;padding:20px 0 5px;">LOCKED (${locked.length})</div>`+locked.map(a=>`<div class="achievement-card" style="opacity:0.35;filter:grayscale(1);"><div class="achievement-icon">🔒</div><div class="achievement-title" style="color:#666;">${a.title}</div><div class="achievement-description">${a.desc}</div></div>`).join(''):'');
        }

        function refreshProfileWorkouts(user) {
            const feed=document.getElementById('profileWorkoutFeed'); if(!feed) return;
            const workouts=user.workouts||[];
            if(workouts.length===0){feed.innerHTML=`<div style="text-align:center;padding:60px 20px;color:#999;"><div style="font-size:48px;margin-bottom:15px;">🏋️</div><h3 style="font-family:'Bebas Neue',cursive;font-size:28px;color:var(--primary);margin-bottom:10px;">No Workouts Yet</h3><p>Hit the + button to log your first workout!</p></div>`;return;}
            feed.innerHTML=workouts.map(w=>{
                const exList=(w.exercises||[]).map(ex=>`<div class="exercise-item"><span class="exercise-name">${ex.name}</span><span class="exercise-details">${ex.sets||'?'} × ${ex.reps||'?'}${ex.weight?' @ '+ex.weight+' lbs':''}</span></div>`).join('')||'<div class="exercise-item"><span class="exercise-name">No exercises recorded</span></div>';
                const captionHTML=w.caption?`<p class="workout-caption">"${w.caption}"</p>`:'';
                const photoHTML=w.photo_url?`<div style="width:100%;padding-bottom:125%;position:relative;overflow:hidden;background:#111;"><img src="${w.photo_url}" loading="lazy" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;"></div>`:'';
                const dateStr=new Date(w.created_at||w.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
                return `<div class="activity-card" data-workout-id="${w.id}">
                    <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;position:relative;">
                        <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:14px;flex-shrink:0;overflow:hidden;">
                            ${user.avatar_url?`<img src="${user.avatar_url}" loading="lazy" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`:(user.initials||'?')}
                        </div>
                        <div style="flex:1;min-width:0;"><div style="font-family:'Oswald',sans-serif;font-size:14px;font-weight:600;">${user.full_name||user.fullName||''}</div><div style="font-size:11px;color:#666;">${dateStr}</div></div>
                        <button onclick="toggleWorkoutMenu('${w.id}',this)" style="background:none;border:none;color:#555;font-size:22px;cursor:pointer;padding:4px 6px;border-radius:6px;line-height:1;-webkit-tap-highlight-color:transparent;">⋯</button>
                        <div id="wMenu_${w.id}" style="display:none;position:absolute;right:10px;top:46px;background:#1e1e1e;border:1px solid #333;border-radius:12px;min-width:170px;z-index:200;box-shadow:0 8px 24px rgba(0,0,0,0.7);overflow:hidden;">
                            <button onclick="openEditWorkout('${w.id}')" style="width:100%;padding:13px 16px;background:none;border:none;border-bottom:1px solid #2a2a2a;color:#fff;font-family:'Oswald',sans-serif;font-size:14px;text-align:left;cursor:pointer;" onmouseover="this.style.background='rgba(255,107,53,0.1)'" onmouseout="this.style.background='none'">✏️ Edit Workout</button>
                            <button onclick="confirmDeleteWorkout('${w.id}')" style="width:100%;padding:13px 16px;background:none;border:none;color:#f87171;font-family:'Oswald',sans-serif;font-size:14px;text-align:left;cursor:pointer;" onmouseover="this.style.background='rgba(248,113,113,0.1)'" onmouseout="this.style.background='none'">🗑 Delete Post</button>
                        </div>
                    </div>
                    <h2 class="workout-title">${w.name.toUpperCase()}</h2>
                    ${photoHTML}${captionHTML}
                    <div class="workout-details">
                        <button class="details-toggle" onclick="toggleDetails(this)"><span>View Workout Details</span><span class="details-toggle-icon">▼</span></button>
                        <div class="workout-details-content">
                            <div class="workout-stats">
                                <div class="workout-stat"><div class="workout-stat-value">${w.exercises?.length||0}</div><div class="workout-stat-label">Exercises</div></div>
                                <div class="workout-stat"><div class="workout-stat-value">${w.duration||'—'}</div><div class="workout-stat-label">Minutes</div></div>
                            </div>
                            <div class="exercise-list">${exList}</div>
                        </div>
                    </div>
                    <div class="activity-actions">
                        <button class="action-btn" onclick="handleRespect(this)"><span class="action-icon">👊</span><span>0 Respect</span></button>
                        <button class="action-btn"><span class="action-icon">💬</span><span>0 Comments</span></button>
                    </div>
                </div>`;
            }).join('');
        }

        // ── WORKOUT MENU (3-dot) ──────────────────────────────────────────────
        function toggleWorkoutMenu(workoutId, btn) {
            const menu=document.getElementById('wMenu_'+workoutId);
            const isOpen=menu&&menu.style.display!=='none';
            document.querySelectorAll('[id^="wMenu_"]').forEach(m=>m.style.display='none');
            if(menu&&!isOpen) menu.style.display='block';
            const close=e=>{ if(!btn.contains(e.target)&&(!menu||!menu.contains(e.target))){ menu&&(menu.style.display='none'); document.removeEventListener('click',close,true); }};
            if(!isOpen) setTimeout(()=>document.addEventListener('click',close,true),10);
        }

        async function openEditWorkout(workoutId) {
            const menu=document.getElementById('wMenu_'+workoutId); if(menu) menu.style.display='none';
            const user=getCurrentUser();
            let w=user?.workouts?.find(x=>x.id===workoutId);
            if(!w){ try{ const rows=await sb(`workouts?id=eq.${workoutId}&select=*`); w=rows&&rows[0]; }catch(e){ console.warn(e.message); } }
            if(!w){ showToast('Could not load workout'); return; }
            _editingWorkoutId=workoutId;
            document.getElementById('editWorkoutName').value=w.name||'';
            document.getElementById('editWorkoutCaption').value=w.caption||'';
            document.getElementById('editWorkoutDuration').value=w.duration||'';
            const ec=document.getElementById('editExerciseContainer'); ec.innerHTML='';
            (w.exercises||[]).forEach(ex=>addEditExercise(ex));
            if(!w.exercises||w.exercises.length===0) addEditExercise();
            const img=document.getElementById('editPreviewImage'), inner=document.getElementById('editPhotoZoneInner'), rm=document.getElementById('editRemovePhoto');
            if(w.photo_url){ img.src=w.photo_url; img.style.display='block'; if(inner)inner.style.display='none'; if(rm)rm.style.display='flex'; }
            else{ img.src=''; img.style.display='none'; if(inner)inner.style.display='block'; if(rm)rm.style.display='none'; }
            document.getElementById('editWorkoutModal').style.display='flex';
            document.body.style.overflow='hidden';
        }

        let _editingWorkoutId=null;
        function closeEditModal(){ document.getElementById('editWorkoutModal').style.display='none'; document.body.style.overflow=''; _editingWorkoutId=null; }

        function addEditExercise(ex){
            const ec=document.getElementById('editExerciseContainer');
            const row=document.createElement('div'); row.className='ex-edit-row';
            row.style.cssText='background:#1a1a1a;border-radius:10px;padding:12px;border:1px solid #2a2a2a;margin-bottom:8px;';
            row.innerHTML=`<div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="font-family:'Oswald',sans-serif;font-size:12px;color:#666;text-transform:uppercase;letter-spacing:1px;">Exercise</span><button type="button" onclick="this.closest('.ex-edit-row').remove()" style="background:none;border:none;color:#555;font-size:16px;cursor:pointer;padding:0;">✕</button></div>
            <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:8px;">
                <input type="text" placeholder="Exercise name" value="${ex?.name||''}" style="padding:10px;background:#252525;border:1px solid #333;border-radius:8px;color:#fff;font-family:'Oswald',sans-serif;font-size:13px;outline:none;">
                <input type="number" placeholder="Sets" value="${ex?.sets||''}" style="padding:10px;background:#252525;border:1px solid #333;border-radius:8px;color:#fff;font-family:'Oswald',sans-serif;font-size:13px;outline:none;text-align:center;">
                <input type="number" placeholder="Reps" value="${ex?.reps||''}" style="padding:10px;background:#252525;border:1px solid #333;border-radius:8px;color:#fff;font-family:'Oswald',sans-serif;font-size:13px;outline:none;text-align:center;">
                <input type="number" placeholder="lbs" value="${ex?.weight||''}" style="padding:10px;background:#252525;border:1px solid #333;border-radius:8px;color:#fff;font-family:'Oswald',sans-serif;font-size:13px;outline:none;text-align:center;">
            </div>`;
            ec.appendChild(row);
        }

        function handleEditPhotoSelect(input){ const file=input.files[0]; if(!file) return; const r=new FileReader(); r.onload=e=>{ const img=document.getElementById('editPreviewImage'),inner=document.getElementById('editPhotoZoneInner'),rm=document.getElementById('editRemovePhoto'); img.src=e.target.result; img.style.display='block'; if(inner)inner.style.display='none'; if(rm)rm.style.display='flex'; }; r.readAsDataURL(file); }
        function removeEditPhoto(){ const img=document.getElementById('editPreviewImage'),inner=document.getElementById('editPhotoZoneInner'),rm=document.getElementById('editRemovePhoto'),inp=document.getElementById('editPhotoInput'); if(img){img.src='';img.style.display='none';} if(inner)inner.style.display='block'; if(rm)rm.style.display='none'; if(inp)inp.value=''; }

        async function saveEditWorkout(){
            if(!_editingWorkoutId) return;
            const name=document.getElementById('editWorkoutName')?.value.trim();
            const caption=document.getElementById('editWorkoutCaption')?.value.trim()||null;
            const duration=parseInt(document.getElementById('editWorkoutDuration')?.value)||0;
            const img=document.getElementById('editPreviewImage');
            const photo_url=(img?.src&&img.style.display!=='none')?img.src:null;
            const exercises=[];
            document.querySelectorAll('#editExerciseContainer .ex-edit-row').forEach(row=>{
                const inputs=row.querySelectorAll('input');
                const n=inputs[0]?.value.trim(); if(n) exercises.push({name:n,sets:inputs[1]?.value||'',reps:inputs[2]?.value||'',weight:inputs[3]?.value||''});
            });
            if(!name){alert('Please enter a workout name.');return;}
            const btn=document.getElementById('saveEditBtn'); if(btn){btn.textContent='Saving...';btn.disabled=true;}
            try{
                await sb(`workouts?id=eq.${_editingWorkoutId}`,{method:'PATCH',body:{name,caption,duration,exercises,photo_url},prefer:'return=minimal'});
                const user=getCurrentUser();
                if(user&&user.workouts){ const idx=user.workouts.findIndex(w=>w.id===_editingWorkoutId); if(idx>-1) user.workouts[idx]={...user.workouts[idx],name,caption,duration,exercises,photo_url}; setCurrentUser(user); refreshProfileWorkouts(user); refreshProfileStats(user); }
                await loadFeedFromSupabase();
                closeEditModal(); showToast('Workout updated!');
            }catch(e){alert('Error saving: '+e.message);}
            finally{if(btn){btn.textContent='Save Changes';btn.disabled=false;}}
        }

        function confirmDeleteWorkout(workoutId){
            const sheet=document.createElement('div'); sheet.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:5000;display:flex;align-items:flex-end;justify-content:center;';
            sheet.innerHTML=`<div style="background:var(--iron);border-radius:20px 20px 0 0;border-top:3px solid #f87171;padding:24px 20px calc(30px + env(safe-area-inset-bottom));width:100%;max-width:600px;">
                <div style="font-family:'Bebas Neue',cursive;font-size:24px;letter-spacing:2px;color:#f87171;margin-bottom:8px;">Delete Workout?</div>
                <p style="font-family:'Oswald',sans-serif;font-size:14px;color:#888;margin-bottom:20px;">This will permanently remove the post from your profile and the feed.</p>
                <div style="display:flex;gap:10px;">
                    <button onclick="this.closest('div[style*="position:fixed"]').remove()" style="flex:1;padding:14px;background:rgba(255,255,255,0.05);border:1px solid #333;border-radius:12px;color:#888;font-family:'Oswald',sans-serif;font-size:15px;cursor:pointer;text-transform:uppercase;">Cancel</button>
                    <button onclick="executeDeleteWorkout('${workoutId}',this.closest('div[style*="position:fixed"]'))" style="flex:2;padding:14px;background:#f87171;border:none;border-radius:12px;color:#fff;font-family:'Oswald',sans-serif;font-size:15px;font-weight:600;cursor:pointer;text-transform:uppercase;letter-spacing:1px;">Delete</button>
                </div>
            </div>`;
            document.body.appendChild(sheet);
        }

        async function executeDeleteWorkout(workoutId,sheet){
            if(sheet) sheet.remove();
            try{
                await sb(`workouts?id=eq.${workoutId}`,{method:'DELETE'});
                const user=getCurrentUser();
                if(user&&user.workouts){ user.workouts=user.workouts.filter(w=>w.id!==workoutId); setCurrentUser(user); refreshProfileWorkouts(user); refreshProfileStats(user); refreshAchievements(user); }
                document.querySelectorAll(`[data-workout-id="${workoutId}"]`).forEach(c=>{ c.style.transition='opacity 0.3s,transform 0.3s'; c.style.opacity='0'; c.style.transform='scale(0.95)'; setTimeout(()=>c.remove(),300); });
                showToast('Post deleted');
            }catch(e){ alert('Delete failed: '+e.message); }
        }

        function toggleDetails(button){ button.classList.toggle('active'); const c=button.nextElementSibling; c.classList.toggle('active'); }
        function handleRespect(btn){ const s=btn.querySelector('span:last-child'); const n=parseInt(s.textContent)+1; s.textContent=n+' Respect'; btn.style.color='var(--primary)'; }

        function loadProfileGroups(){ const g=document.getElementById('profileGroupsGrid'); if(!g) return; g.innerHTML='<div style="color:#555;text-align:center;padding:40px;font-family:Oswald,sans-serif;">Groups loading...</div>'; }

        async function loadAdminGroupsForModal(){ /* removed — group selection now via + picker */ }


                // ── GROUPS SYSTEM ─────────────────────────────────────────────────────
        let currentGroupData = null; // group object currently being viewed

        // UI toggles
        function showCreateGroupPanel() {
            document.getElementById('createGroupPanel').style.display = 'block';
            document.getElementById('joinGroupPanel').style.display = 'none';
        }
        function hideCreateGroupPanel() {
            document.getElementById('createGroupPanel').style.display = 'none';
        }
        function showJoinGroupPanel() {
            document.getElementById('joinGroupPanel').style.display = 'block';
            document.getElementById('createGroupPanel').style.display = 'none';
            document.getElementById('searchGroupResult').innerHTML = '';
        }
        function hideJoinGroupPanel() {
            document.getElementById('joinGroupPanel').style.display = 'none';
        }
        function openEditGroupPanel() {
            const g = currentGroupData;
            if (!g) return;
            document.getElementById('editGroupName').value = g.name || '';
            document.getElementById('editGroupDesc').value = g.description || '';
            // Load existing cover photo into preview
            const editImg = document.getElementById('editCoverPreview');
            const editPlaceholder = document.getElementById('editCoverPlaceholder');
            const editRemove = document.getElementById('editCoverRemove');
            if (g.cover_url) {
                editImg.src = g.cover_url; editImg.style.display = 'block';
                if (editPlaceholder) editPlaceholder.style.display = 'none';
                if (editRemove) editRemove.style.display = 'flex';
            } else {
                editImg.style.display = 'none';
                if (editPlaceholder) editPlaceholder.style.display = 'block';
                if (editRemove) editRemove.style.display = 'none';
            }
            document.getElementById('editGroupPanel').style.display = 'block';
            document.getElementById('postChallengePanel').style.display = 'none';
            // Scroll to edit panel
            document.getElementById('editGroupPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function toggleJoinCode() {
            const priv = document.getElementById('newGroupPrivacy').value === 'private';
            document.getElementById('joinCodeRow').style.display = priv ? 'block' : 'none';
        }
        function addChallengeExercise() {
            const c = document.getElementById('challengeExerciseContainer');
            const div = document.createElement('div');
            div.className = 'exercise-inputs';
            div.innerHTML = `<input type="text" placeholder="Exercise name"><input type="number" placeholder="Sets"><input type="number" placeholder="Reps"><input type="text" placeholder="Notes (optional)">`;
            c.appendChild(div);
        }

        // Load groups page
        let _groupsCache = null; // cache groups list to avoid re-fetching on every tab switch

        async function loadGroupsPage() {
            const user = getCurrentUser();
            if (!user) return;
            try {
                // Get groups the user is a member of
                const memberships = await sb(`group_members?user_id=eq.${window._sbUserId}&select=group_id,role,groups(id,group_id,name,description,privacy,creator_id,created_at)`);
                const grid = document.getElementById('myGroupsGrid');
                const empty = document.getElementById('myGroupsEmpty');
                if (!memberships || memberships.length === 0) {
                    grid.innerHTML = '';
                    empty.style.display = 'block';
                    return;
                }
                empty.style.display = 'none';
                grid.innerHTML = memberships.map(m => {
                    const g = m.groups;
                    const isCreator = g.creator_id === window._sbUserId;
                    const coverStyle = g.cover_url
                        ? `background-image:url('${g.cover_url}');background-size:cover;background-position:center;`
                        : 'background:linear-gradient(135deg,var(--primary),var(--accent));';
                    return `<div class="group-card" onclick="openGroupDetail('${g.id}')">
                        <div class="group-header-banner" style="${coverStyle}position:relative;min-height:110px;">
                            ${g.cover_url ? '<div style="position:absolute;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,0.15),rgba(0,0,0,0.65));border-radius:12px 12px 0 0;"></div>' : ''}
                            <div style="position:relative;">
                                <h3 class="group-name" style="${g.cover_url ? 'text-shadow:0 2px 6px rgba(0,0,0,0.5);' : ''}">${g.name}</h3>
                                <div class="group-members-count" style="${g.cover_url ? 'color:rgba(255,255,255,0.85);' : ''}">${g.privacy === 'private' ? '🔒 Private' : '🌐 Public'} · ID: ${g.group_id}</div>
                            </div>
                        </div>
                        <div class="group-body">
                            <p class="group-description">${g.description || 'No description yet.'}</p>
                            <div style="margin-top:10px;">
                                ${isCreator ? '<span style="background:var(--primary);color:#fff;padding:3px 10px;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;border-radius:4px;">ADMIN</span>' : '<span style="background:#333;color:#999;padding:3px 10px;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;border-radius:4px;">MEMBER</span>'}
                            </div>
                            <button class="view-group-btn" style="margin-top:15px;">View Group →</button>
                        </div>
                    </div>`;
                }).join('');
            } catch(e) { console.warn('loadGroupsPage error:', e.message); }
        }

        // ── COVER PHOTO HELPERS ────────────────────────────────────────────────
        function previewGroupCover(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.getElementById('groupCoverPreview');
                const placeholder = document.getElementById('groupCoverPlaceholder');
                const remove = document.getElementById('groupCoverRemove');
                img.src = e.target.result; img.style.display = 'block';
                if (placeholder) placeholder.style.display = 'none';
                if (remove) remove.style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }
        function removeGroupCover() {
            document.getElementById('groupCoverInput').value = '';
            document.getElementById('groupCoverPreview').style.display = 'none';
            document.getElementById('groupCoverPreview').src = '';
            document.getElementById('groupCoverPlaceholder').style.display = 'block';
            document.getElementById('groupCoverRemove').style.display = 'none';
        }
        function previewEditCover(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.getElementById('editCoverPreview');
                const placeholder = document.getElementById('editCoverPlaceholder');
                const remove = document.getElementById('editCoverRemove');
                img.src = e.target.result; img.style.display = 'block';
                if (placeholder) placeholder.style.display = 'none';
                if (remove) remove.style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }
        function removeEditCover() {
            document.getElementById('editCoverInput').value = '';
            document.getElementById('editCoverPreview').style.display = 'none';
            document.getElementById('editCoverPreview').src = '';
            document.getElementById('editCoverPlaceholder').style.display = 'block';
            document.getElementById('editCoverRemove').style.display = 'none';
        }

        // Create group
        async function handleCreateGroup() {
            const name    = document.getElementById('newGroupName').value.trim();
            const groupId = document.getElementById('newGroupId').value.trim().toLowerCase();
            const desc    = document.getElementById('newGroupDesc').value.trim();
            const privacy = document.getElementById('newGroupPrivacy').value;
            const code    = document.getElementById('newGroupCode').value.trim().toUpperCase();

            if (!name || !groupId) { alert('Group name and ID are required.'); return; }
            if (privacy === 'private' && !code) { alert('Please set a join code for private groups.'); return; }

            // Get cover photo as base64 if provided
            const coverImg = document.getElementById('groupCoverPreview');
            const coverPhoto = coverImg && coverImg.style.display !== 'none' ? coverImg.src : null;

            try {
                const existing = await sb(`groups?group_id=eq.${groupId}&select=id`);
                if (existing && existing.length > 0) { alert('That Group ID is already taken. Choose another.'); return; }

                const group = {
                    group_id: groupId,
                    name,
                    description: desc,
                    privacy,
                    join_code: privacy === 'private' ? code : null,
                    creator_id: window._sbUserId,
                    cover_url: coverPhoto || null
                };
                const saved = await sb('groups', { method: 'POST', body: group });
                const newGroup = saved[0];

                await sb('group_members', { method: 'POST', body: { group_id: newGroup.id, user_id: window._sbUserId, role: 'creator' } });

                hideCreateGroupPanel();
                document.getElementById('newGroupName').value = '';
                document.getElementById('newGroupId').value = '';
                document.getElementById('newGroupDesc').value = '';
                document.getElementById('newGroupCode').value = '';
                removeGroupCover();

                await loadGroupsPage();
                openGroupDetail(newGroup.id);
            } catch(e) { alert('Error creating group: ' + e.message); }
        }

        // Save group edits (admin only)
        async function handleSaveGroupEdit() {
            if (!currentGroupData) return;
            const name = document.getElementById('editGroupName').value.trim();
            const desc = document.getElementById('editGroupDesc').value.trim();
            if (!name) { alert('Group name is required.'); return; }

            const editImg = document.getElementById('editCoverPreview');
            const coverPhoto = editImg && editImg.style.display !== 'none' ? editImg.src : currentGroupData.cover_url || null;

            try {
                await sb(`groups?id=eq.${currentGroupData.id}`, {
                    method: 'PATCH',
                    body: { name, description: desc, cover_url: coverPhoto },
                    prefer: 'return=minimal'
                });
                currentGroupData.name = name;
                currentGroupData.description = desc;
                currentGroupData.cover_url = coverPhoto;
                document.getElementById('editGroupPanel').style.display = 'none';
                // Re-render header
                document.getElementById('groupDetailTitle').textContent = name;
                document.getElementById('groupDetailDesc').textContent = desc;
                if (coverPhoto) {
                    document.getElementById('groupCoverImg').src = coverPhoto;
                    document.getElementById('groupCoverImg').style.display = 'block';
                }
                // Show success toast
                const toast = document.createElement('div');
                toast.style.cssText = 'position:fixed;bottom:110px;left:50%;transform:translateX(-50%);background:#4ade80;color:#000;padding:12px 24px;border-radius:30px;font-family:Oswald,sans-serif;font-size:14px;font-weight:600;letter-spacing:1px;z-index:9999;text-transform:uppercase;white-space:nowrap;box-shadow:0 4px 20px rgba(74,222,128,0.3);';
                toast.textContent = '✓ Group updated!';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
                await loadGroupsPage();
            } catch(e) { alert('Error saving group: ' + e.message); }
        }

        // Search for group to join
        async function handleSearchGroup() {
            const searchId = document.getElementById('searchGroupId').value.trim().toLowerCase();
            const result = document.getElementById('searchGroupResult');
            if (!searchId) { result.innerHTML = '<p style="color:#ff6b35;">Please enter a Group ID.</p>'; return; }

            try {
                const groups = await sb(`groups?group_id=eq.${searchId}&select=*`);
                if (!groups || groups.length === 0) {
                    result.innerHTML = '<p style="color:#ff6b35;">No group found with that ID.</p>'; return;
                }
                const g = groups[0];
                // Check if already member
                const mem = await sb(`group_members?group_id=eq.${g.id}&user_id=eq.${window._sbUserId}&select=id`);
                const isMember = mem && mem.length > 0;

                result.innerHTML = `
                    <div style="background:var(--iron);border-left:4px solid var(--primary);padding:20px;margin-top:10px;">
                        <div style="font-family:'Bebas Neue',cursive;font-size:24px;color:var(--white);margin-bottom:5px;">${g.name}</div>
                        <div style="font-size:13px;color:#999;margin-bottom:10px;">${g.privacy === 'private' ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:1em;height:1em;display:inline-block;vertical-align:-0.1em;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Private Group' : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:1em;height:1em;display:inline-block;vertical-align:-0.1em;"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg> Public Group'} · ID: ${g.group_id}</div>
                        <p style="color:#ccc;font-size:14px;margin-bottom:15px;">${g.description || ''}</p>
                        ${isMember
                            ? '<span style="color:#4ade80;font-size:14px;font-weight:600;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:1em;height:1em;display:inline-block;vertical-align:-0.1em;color:#4ade80;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> You are already a member</span>'
                            : g.privacy === 'private'
                                ? `<div style="display:flex;gap:10px;align-items:center;margin-top:10px;">
                                    <input id="joinCodeInput" type="text" placeholder="Enter join code" style="padding:12px;background:var(--steel);border:2px solid #333;color:#fff;font-family:'Oswald',sans-serif;font-size:14px;flex:1;text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()">
                                    <button class="submit-btn" style="margin:0;padding:12px 25px;width:auto;" onclick="handleJoinGroup('${g.id}','${g.group_id}',true)">Join</button>
                                   </div>`
                                : `<button class="submit-btn" style="margin:0;padding:12px 30px;width:auto;" onclick="handleJoinGroup('${g.id}','${g.group_id}',false)">Join Group</button>`
                        }
                    </div>`;
            } catch(e) { result.innerHTML = `<p style="color:#ff6b35;">Error: ${e.message}</p>`; }
        }

        async function handleJoinGroup(groupUUID, groupId, isPrivate) {
            if (isPrivate) {
                const enteredCode = document.getElementById('joinCodeInput')?.value.trim().toUpperCase();
                const groups = await sb(`groups?id=eq.${groupUUID}&select=join_code`);
                if (!groups || groups[0].join_code !== enteredCode) {
                    alert('Incorrect join code.'); return;
                }
            }
            try {
                await sb('group_members', { method: 'POST', body: { group_id: groupUUID, user_id: window._sbUserId, role: 'member' } });
                hideJoinGroupPanel();
                await loadGroupsPage();
                openGroupDetail(groupUUID);
            } catch(e) { alert('Error joining group: ' + e.message); }
        }

        // Open group detail view
        async function openGroupDetail(groupUUID) {
            document.getElementById('groupsListView').style.display = 'none';
            document.getElementById('groupDetailView').style.display = 'block';

            try {
                const groups = await sb(`groups?id=eq.${groupUUID}&select=*`);
                const g = groups[0];
                currentGroupData = g;

                // Members fetched in parallel with challenges below
                const memberCount = members.length;
                const isCreator = g.creator_id === window._sbUserId;

                // Render cover photo
                const coverImg = document.getElementById('groupCoverImg');
                const coverBg  = document.getElementById('groupCoverBg');
                if (g.cover_url) {
                    coverImg.src = g.cover_url;
                    coverImg.style.display = 'block';
                    if (coverBg) coverBg.style.background = 'transparent';
                } else {
                    coverImg.style.display = 'none';
                    if (coverBg) coverBg.style.background = 'linear-gradient(135deg,var(--steel),var(--iron))';
                }

                document.getElementById('groupDetailTitle').textContent = g.name;
                document.getElementById('groupDetailDesc').textContent = g.description || '';
                document.getElementById('groupDetailInfo').innerHTML = `
                    <span style="display:inline-flex;align-items:center;gap:5px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="width:13px;height:13px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>${memberCount} member${memberCount !== 1 ? 's' : ''}</span>
                    <span style="display:inline-flex;align-items:center;gap:5px;">${g.privacy === 'private' ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="width:13px;height:13px;"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Private' : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="width:13px;height:13px;"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10z"/></svg>Public'}</span>
                    <span style="color:rgba(255,255,255,0.5);">ID: ${g.group_id}</span>
                    ${isCreator && g.privacy === 'private' ? `<span style="color:rgba(255,255,255,0.7);">Code: <strong style="color:var(--primary)">${g.join_code}</strong></span>` : ''}`;

                const actions = document.getElementById('groupDetailActions');
                if (isCreator) {
                    actions.innerHTML = `
                        <button class="post-workout-btn" style="padding:10px 20px;font-size:13px;"
                            data-gid="${g.id}" data-gname="${g.name.replace(/"/g,'&quot;')}"
                            onclick="startGroupLogFromDetail(this.dataset.gid,this.dataset.gname)">+ Post Workout</button>
                        <button style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);color:#fff;padding:10px 18px;font-family:'Oswald',sans-serif;font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:1px;cursor:pointer;border-radius:8px;backdrop-filter:blur(4px);" onclick="openEditGroupPanel()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="width:14px;height:14px;display:inline;margin-right:5px;vertical-align:-1px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Edit
                        </button>
                        <button style="background:transparent;border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.5);padding:10px 18px;font-family:'Oswald',sans-serif;font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:1px;cursor:pointer;border-radius:8px;" onclick="handleDeleteGroup('${g.id}')">Delete</button>`;
                } else {
                    actions.innerHTML = `<button style="background:transparent;border:1px solid rgba(255,255,255,0.3);color:rgba(255,255,255,0.7);padding:10px 20px;font-family:'Oswald',sans-serif;font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:1px;cursor:pointer;border-radius:8px;" onclick="handleLeaveGroup('${g.id}')">Leave Group</button>`;
                }

                await loadGroupChallenges(groupUUID, members, isCreator);
            } catch(e) { console.warn('openGroupDetail error:', e.message); }
        }

        async function loadGroupChallenges(groupUUID, members, isCreator) {
            const feed = document.getElementById('groupChallengesFeed');
            try {
                // Already have members from openGroupDetail — fetch challenges only
                const challenges = await sb(`group_challenges?group_id=eq.${groupUUID}&order=created_at.desc&select=*`);
                if (!challenges || challenges.length === 0) {
                    feed.innerHTML = `<div style="text-align:center;padding:60px 20px;color:#999;">
                        <div style="font-size:48px;margin-bottom:15px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:1em;height:1em;display:inline-block;vertical-align:-0.1em;"><rect x="2" y="10" width="4" height="4" rx="1"/><rect x="18" y="10" width="4" height="4" rx="1"/><rect x="7" y="8" width="2" height="8" rx="1"/><rect x="15" y="8" width="2" height="8" rx="1"/><line x1="9" y1="12" x2="15" y2="12" stroke-width="2.5"/></svg></div>
                        <h3 style="font-family:'Bebas Neue',cursive;font-size:28px;color:var(--primary);margin-bottom:10px;">NO CHALLENGES YET</h3>
                        <p>${isCreator ? 'Post the first workout challenge above!' : 'Waiting for the group creator to post a challenge.'}</p>
                    </div>`; return;
                }

                // Get all completions for this group's challenges
                const challengeIds = challenges.map(c => c.id);
                const completions = await sb(`group_completions?challenge_id=in.(${challengeIds.join(',')})&select=*,profiles(full_name,initials)`);

                feed.innerHTML = challenges.map(ch => {
                    const chCompletions = completions.filter(c => c.challenge_id === ch.id);
                    const myCompletion = chCompletions.find(c => c.user_id === window._sbUserId);
                    const exList = (ch.exercises || []).map(ex =>
                        `<div class="exercise-item">
                            <span class="exercise-name">${ex.name}</span>
                            <span class="exercise-details">${ex.sets||'?'} × ${ex.reps||'?'}${ex.notes ? ' · ' + ex.notes : ''}</span>
                        </div>`).join('');

                    const completionItems = chCompletions.map(c => {
                        const photoHTML = c.photo_url
                            ? `<div style="width:100%;padding-bottom:75%;position:relative;overflow:hidden;border-radius:8px;background:#111;margin-top:10px;">
                                <img src="${c.photo_url}" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;">
                               </div>` : '';
                        const commentHTML = c.comment
                            ? `<div style="font-size:13px;color:#ccc;margin-top:8px;font-family:'Oswald',sans-serif;line-height:1.5;">"${c.comment}"</div>` : '';
                        const hasExtra = c.photo_url || c.comment;
                        return `<div style="background:var(--iron);border-radius:10px;padding:12px 14px;border:1px solid #2a2a2a;${hasExtra ? '' : ''}">
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div style="width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));
                                    display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:13px;flex-shrink:0;">
                                    ${c.profiles?.initials || '?'}
                                </div>
                                <div style="flex:1;min-width:0;">
                                    <div style="font-family:'Oswald',sans-serif;font-size:14px;font-weight:600;">${c.profiles?.full_name || 'Unknown'}</div>
                                    <div style="font-size:11px;color:#555;">${new Date(c.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</div>
                                </div>
                                <svg viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2.5" stroke-linecap="round" style="width:18px;height:18px;flex-shrink:0;">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                            </div>
                            ${photoHTML}${commentHTML}
                        </div>`;
                    }).join('');

                    const dateStr = new Date(ch.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
                    return `<div class="group-workout-card">
                        <div class="workout-posted-by">
                            <div class="posted-by-label">Posted ${dateStr}</div>
                            <div class="posted-by-name">${ch.title}</div>
                        </div>
                        ${ch.description ? `<p class="workout-challenge-description">${ch.description}</p>` : ''}
                        <div class="workout-challenge-exercises"><div class="exercise-list">${exList || '<div class="exercise-item"><span class="exercise-name">No exercises listed</span></div>'}</div></div>
                        <div class="completions-section">
                            <div class="completions-header">
                                <div class="completions-title">Completions (${chCompletions.length})</div>
                                ${!myCompletion
                                    ? `<button class="complete-workout-btn" onclick="openCompleteSheet('${ch.id}')">✓ Mark Complete</button>`
                                    : `<button class="complete-workout-btn completed" disabled>Completed ✓</button>`
                                }
                            </div>
                            <div style="display:flex;flex-direction:column;gap:10px;margin-top:12px;">${completionItems || '<p style="color:#666;font-size:13px;padding:10px 0;">No completions yet — be the first!</p>'}</div>
                        </div>
                        ${isCreator ? `<div style="padding:10px 30px;border-top:1px solid #333;"><button onclick="handleDeleteChallenge('${ch.id}')" style="background:transparent;border:none;color:#555;font-family:'Oswald',sans-serif;font-size:13px;cursor:pointer;text-transform:uppercase;letter-spacing:1px;">Delete Challenge</button></div>` : ''}
                    </div>`;
                }).join('');
            } catch(e) { feed.innerHTML = `<p style="color:#ff6b35;padding:20px;">Error loading challenges: ${e.message}</p>`; }
        }

        // Post workout challenge
        async function handlePostChallenge() {
            const title = document.getElementById('challengeTitle').value.trim();
            const desc  = document.getElementById('challengeDesc').value.trim();
            if (!title) { alert('Please enter a challenge title.'); return; }

            const exercises = [];
            document.querySelectorAll('#challengeExerciseContainer .exercise-inputs').forEach(row => {
                const inputs = row.querySelectorAll('input');
                const name = inputs[0]?.value.trim();
                if (name) exercises.push({ name, sets: inputs[1]?.value || '', reps: inputs[2]?.value || '', notes: inputs[3]?.value || '' });
            });

            try {
                await sb('group_challenges', { method: 'POST', body: {
                    group_id: currentGroupData.id,
                    creator_id: window._sbUserId,
                    title,
                    description: desc || null,
                    exercises
                }});
                document.getElementById('postChallengePanel').style.display = 'none';
                document.getElementById('challengeTitle').value = '';
                document.getElementById('challengeDesc').value = '';
                document.getElementById('challengeExerciseContainer').innerHTML = `<div class="exercise-inputs"><input type="text" placeholder="Exercise name"><input type="number" placeholder="Sets"><input type="number" placeholder="Reps"><input type="text" placeholder="Notes (optional)"></div>`;
                const members = await sb(`group_members?group_id=eq.${currentGroupData.id}&select=user_id,role,profiles(full_name,initials)`);
                await loadGroupChallenges(currentGroupData.id, members, true);
            } catch(e) { alert('Error posting challenge: ' + e.message); }
        }

        // ── Complete challenge sheet ─────────────────────────────────────────
        let _completingChallengeId = null;

        function openCompleteSheet(challengeId) {
            _completingChallengeId = challengeId;
            // Reset sheet state
            const img = document.getElementById('completePreviewImg');
            const inner = document.getElementById('completePhotoInner');
            const removeBtn = document.getElementById('completeRemovePhoto');
            if (img) { img.src = ''; img.style.display = 'none'; }
            if (inner) inner.style.display = 'block';
            if (removeBtn) removeBtn.style.display = 'none';
            const photoInput = document.getElementById('completePhotoInput');
            if (photoInput) photoInput.value = '';
            const commentInput = document.getElementById('completeCommentInput');
            if (commentInput) commentInput.value = '';

            const sheet = document.getElementById('completeSheet');
            sheet.style.display = 'flex';
            requestAnimationFrame(() => {
                sheet.style.background = 'rgba(0,0,0,0.75)';
                document.getElementById('completeSheetInner').style.transform = 'translateY(0)';
            });
            document.body.style.overflow = 'hidden';
        }

        function closeCompleteSheet() {
            const sheet = document.getElementById('completeSheet');
            const inner = document.getElementById('completeSheetInner');
            sheet.style.background = 'rgba(0,0,0,0)';
            inner.style.transform = 'translateY(100%)';
            setTimeout(() => { sheet.style.display = 'none'; document.body.style.overflow = ''; }, 280);
            _completingChallengeId = null;
        }

        function handleCompletePhotoSelect(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.getElementById('completePreviewImg');
                const inner = document.getElementById('completePhotoInner');
                const removeBtn = document.getElementById('completeRemovePhoto');
                img.src = e.target.result; img.style.display = 'block';
                if (inner) inner.style.display = 'none';
                if (removeBtn) removeBtn.style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }

        function removeCompletePhoto() {
            const img = document.getElementById('completePreviewImg');
            const inner = document.getElementById('completePhotoInner');
            const removeBtn = document.getElementById('completeRemovePhoto');
            const input = document.getElementById('completePhotoInput');
            if (img) { img.src = ''; img.style.display = 'none'; }
            if (inner) inner.style.display = 'block';
            if (removeBtn) removeBtn.style.display = 'none';
            if (input) input.value = '';
        }

        async function submitCompletion() {
            if (!_completingChallengeId) return;
            const comment = document.getElementById('completeCommentInput')?.value.trim() || null;
            const img = document.getElementById('completePreviewImg');
            const photoUrl = (img?.src && img.style.display !== 'none') ? img.src : null;

            const submitBtn = document.getElementById('completeSubmitBtn');
            submitBtn.textContent = 'Posting...'; submitBtn.disabled = true;

            try {
                await sb('group_completions', { method: 'POST', body: {
                    challenge_id: _completingChallengeId,
                    user_id: window._sbUserId,
                    group_id: currentGroupData.id,
                    photo_url: photoUrl,
                    comment: comment
                }});
                closeCompleteSheet();
                showToast('Workout completed! 💪');
                // Reload challenges to show new completion
                const members = await sb(`group_members?group_id=eq.${currentGroupData.id}&select=user_id,role,profiles(full_name,initials)`);
                await loadGroupChallenges(currentGroupData.id, members, currentGroupData.creator_id === window._sbUserId);
            } catch(e) {
                alert('Error posting completion: ' + e.message);
                submitBtn.textContent = 'Post Completion'; submitBtn.disabled = false;
            }
        }

        async function handleDeleteChallenge(challengeId) {
            if (!confirm('Delete this challenge?')) return;
            try {
                await sb(`group_challenges?id=eq.${challengeId}`, { method: 'DELETE', prefer: 'return=minimal' });
                const members = await sb(`group_members?group_id=eq.${currentGroupData.id}&select=user_id,role,profiles(full_name,initials)`);
                await loadGroupChallenges(currentGroupData.id, members, true);
            } catch(e) { alert('Error: ' + e.message); }
        }

        async function handleLeaveGroup(groupUUID) {
            if (!confirm('Leave this group?')) return;
            try {
                await sb(`group_members?group_id=eq.${groupUUID}&user_id=eq.${window._sbUserId}`, { method: 'DELETE', prefer: 'return=minimal' });
                closeGroupDetail();
                await loadGroupsPage();
            } catch(e) { alert('Error: ' + e.message); }
        }

        async function handleDeleteGroup(groupUUID) {
            if (!confirm('Permanently delete this group and all its challenges? This cannot be undone.')) return;
            try {
                await sb(`groups?id=eq.${groupUUID}`, { method: 'DELETE', prefer: 'return=minimal' });
                closeGroupDetail();
                await loadGroupsPage();
            } catch(e) { alert('Error: ' + e.message); }
        }

        function closeGroupDetail() {
            document.getElementById('groupDetailView').style.display = 'none';
            document.getElementById('groupsListView').style.display = 'block';
            document.getElementById('postChallengePanel').style.display = 'none';
            currentGroupData = null;
        }


        // ── PROGRESS PAGE — REAL DATA ────────────────────────────────────────
        let progressChart = null;
        let progressExerciseData = {}; // { 'Bench Press': [{date, weight, sets, reps}] }

        function buildProgressFromWorkouts(workouts) {
            const map = {};
            workouts.forEach(w => {
                const rawDate = w.created_at || w.date || w.logged_at || new Date().toISOString();
                const date = new Date(rawDate);
                (w.exercises || []).forEach(ex => {
                    const weight = parseFloat(ex.weight);
                    if (!ex.name || !weight || isNaN(weight)) return;
                    const key = ex.name.trim();
                    if (!map[key]) map[key] = [];
                    map[key].push({
                        date,
                        dateLabel: date.toLocaleDateString('en-US', { month:'short', day:'numeric' }),
                        weight,
                        sets: ex.sets || '?',
                        reps: ex.reps || '?',
                        volume: weight * (parseInt(ex.sets)||1) * (parseInt(ex.reps)||1)
                    });
                });
            });
            // Sort each exercise by date ascending
            Object.keys(map).forEach(k => map[k].sort((a,b) => a.date - b.date));
            return map;
        }

        async function loadProgressPage() {
            const user = getCurrentUser();
            if (!user) return;

            // Fetch fresh workouts
            let workouts = user.workouts || [];
            if (window._sbUserId) {
                try {
                    const fresh = await sb(`workouts?user_id=eq.${window._sbUserId}&order=created_at.asc&select=*`);
                    if (fresh) { workouts = fresh; user.workouts = fresh; setCurrentUser(user); }
                } catch(e) { console.warn('Progress fetch:', e.message); }
            }

            // ── Overview stats ───────────────────────────────────────────────
            const totalWorkouts = workouts.length;

            // Minutes this week (Mon–Sun)
            const now = new Date();
            const weekStart = new Date(now);
            weekStart.setHours(0,0,0,0);
            weekStart.setDate(now.getDate() - ((now.getDay() + 6) % 7)); // Monday
            const weekMins = workouts
                .filter(w => new Date(w.created_at || w.date) >= weekStart)
                .reduce((s, w) => s + (parseInt(w.duration) || 0), 0);

            // Streak: consecutive calendar days (today counting) with ≥1 workout
            const dayKeys = new Set(workouts.map(w => {
                const d = new Date(w.created_at || w.date);
                return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
            }));
            let streak = 0;
            const check = new Date(); check.setHours(0,0,0,0);
            // If no workout today, still count streak from yesterday
            const todayKey = `${check.getFullYear()}-${check.getMonth()}-${check.getDate()}`;
            if (!dayKeys.has(todayKey)) check.setDate(check.getDate() - 1);
            while (true) {
                const k = `${check.getFullYear()}-${check.getMonth()}-${check.getDate()}`;
                if (!dayKeys.has(k)) break;
                streak++;
                check.setDate(check.getDate() - 1);
            }

            const pgTW = document.getElementById('pgTotalWorkouts');
            const pgWM = document.getElementById('pgWeekMins');
            const pgSt = document.getElementById('pgStreak');
            if (pgTW) pgTW.textContent = totalWorkouts;
            if (pgWM) pgWM.textContent = weekMins;
            if (pgSt) pgSt.textContent = streak;

            // ── Lift dropdown ────────────────────────────────────────────────
            progressExerciseData = buildProgressFromWorkouts(workouts);
            const exercises = Object.keys(progressExerciseData).sort();

            const dropdown = document.getElementById('liftDropdown');
            const emptyState = document.getElementById('progressEmptyState');
            const liftDetail = document.getElementById('liftDetailSection');

            if (exercises.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                if (liftDetail) liftDetail.style.display = 'none';
                if (dropdown) dropdown.innerHTML = '<option value="">— Log workouts with weights to track lifts —</option>';
                return;
            }
            if (emptyState) emptyState.style.display = 'none';

            // Populate dropdown (keep selection if re-loading)
            const prev = dropdown ? dropdown.value : '';
            if (dropdown) {
                dropdown.innerHTML = '<option value="">— Choose a lift —</option>' +
                    exercises.map(n => `<option value="${n.replace(/"/g,'&quot;')}"${n===prev?' selected':''}>${n}</option>`).join('');
            }

            // Auto-show previously selected or first lift
            const toShow = (prev && exercises.includes(prev)) ? prev : null;
            if (toShow) {
                if (liftDetail) liftDetail.style.display = 'block';
                renderProgressChart(toShow);
            } else {
                if (liftDetail) liftDetail.style.display = 'none';
            }
        }

        function onLiftDropdownChange(val) {
            const liftDetail = document.getElementById('liftDetailSection');
            if (!val) { if (liftDetail) liftDetail.style.display = 'none'; return; }
            if (liftDetail) liftDetail.style.display = 'block';
            renderProgressChart(val);
        }

        function renderProgressChart(exerciseName) {
            const entries = progressExerciseData[exerciseName];
            if (!entries || entries.length === 0) return;

            const pr      = Math.max(...entries.map(e => e.weight));
            const first   = entries[0].weight;
            const diff    = pr - first;
            const diffStr = (diff >= 0 ? '+' : '') + diff + ' lbs';

            // Update title + badge
            const titleEl = document.getElementById('chartTitle');
            const badgeEl = document.getElementById('chartPrBadge');
            if (titleEl) titleEl.textContent = exerciseName;
            if (badgeEl) badgeEl.textContent = `PR: ${pr} lbs`;

            // Update stat boxes
            const el = id => document.getElementById(id);
            if (el('currentPR'))    el('currentPR').textContent    = pr + ' lbs';
            if (el('totalIncrease')) el('totalIncrease').textContent = diffStr;
            if (el('sessionsLogged')) el('sessionsLogged').textContent = entries.length;

            // ── Chart ────────────────────────────────────────────────────────
            const canvas = document.getElementById('progressChart');
            if (!canvas) return;
            if (window.progressChart) { window.progressChart.destroy(); window.progressChart = null; }

            const wrapper = canvas.parentElement;
            const w = wrapper.clientWidth || window.innerWidth - 60 || 320;
            const h = 220;
            canvas.width = w; canvas.height = h;
            canvas.style.width = '100%'; canvas.style.height = '100%';

            const ctx = canvas.getContext('2d');
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, 'rgba(255,107,53,0.3)');
            grad.addColorStop(0.7, 'rgba(255,107,53,0.05)');
            grad.addColorStop(1, 'rgba(255,107,53,0)');

            const chartLabels = entries.length === 1
                ? [entries[0].dateLabel, entries[0].dateLabel]
                : entries.map(e => e.dateLabel);
            const chartData = entries.length === 1
                ? [entries[0].weight, entries[0].weight]
                : entries.map(e => e.weight);
            const pointColors = (entries.length === 1 ? [entries[0]] : entries)
                .map(e => e.weight === pr ? '#ffb347' : '#ff6b35');
            const pointRadii = (entries.length === 1 ? [entries[0]] : entries)
                .map(e => e.weight === pr ? 8 : 5);

            window.progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartData,
                        borderColor: '#ff6b35',
                        backgroundColor: grad,
                        borderWidth: 2.5,
                        fill: true,
                        tension: 0.35,
                        pointRadius: pointRadii,
                        pointBackgroundColor: pointColors,
                        pointBorderColor: '#1a1a1a',
                        pointBorderWidth: 2,
                        pointHoverRadius: 10,
                        pointHoverBackgroundColor: '#ffb347',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 500, easing: 'easeInOutQuart' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1a1a1a',
                            titleColor: '#ff6b35',
                            bodyColor: '#eee',
                            borderColor: '#333',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: false,
                            titleFont: { family: 'Oswald', size: 13, weight: '600' },
                            bodyFont: { family: 'Roboto Mono', size: 12 },
                            callbacks: {
                                title: items => chartLabels[items[0].dataIndex],
                                label: c => `  ${c.parsed.y} lbs`,
                                afterLabel: c => {
                                    const e = entries[Math.min(c.dataIndex, entries.length-1)];
                                    const vol = e.weight * (parseInt(e.sets)||1) * (parseInt(e.reps)||1);
                                    const lines = [`  ${e.sets} sets × ${e.reps} reps`, `  Vol: ${vol.toLocaleString()} lbs`];
                                    if (e.weight === pr) lines.push('  🏆 Personal Record!');
                                    return lines;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255,255,255,0.06)' },
                            border: { color: 'rgba(255,255,255,0.08)', dash: [4,4] },
                            ticks: { color: '#666', font: { family: 'Roboto Mono', size: 10 }, padding: 6, callback: v => v + ' lbs' }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.03)' },
                            border: { color: 'rgba(255,255,255,0.08)' },
                            ticks: { color: '#666', font: { family: 'Roboto Mono', size: 10 }, padding: 6, maxRotation: 40 }
                        }
                    },
                    interaction: { intersect: false, mode: 'index' }
                }
            });

            // ── History table (newest first, no "Exercise" column — already selected) ──
            const tbody = document.getElementById('historyTableBody');
            if (tbody) {
                const rows = [...entries].reverse();
                tbody.innerHTML = rows.map((e, i) => {
                    const prev = rows[i + 1];
                    let trend = '<span style="color:#444;">—</span>';
                    if (prev) {
                        const d = e.weight - prev.weight;
                        if (d > 0) trend = `<span style="color:#4ade80;">↑ +${d}</span>`;
                        else if (d < 0) trend = `<span style="color:#f87171;">↓ ${d}</span>`;
                        else trend = `<span style="color:#555;">→</span>`;
                    }
                    const vol = e.weight * (parseInt(e.sets)||1) * (parseInt(e.reps)||1);
                    const isPR = e.weight === pr;
                    return `<tr style="${isPR ? 'background:rgba(255,179,71,0.07);' : ''}">
                        <td style="white-space:nowrap;">${e.dateLabel}${isPR ? ' <span style="background:var(--primary);color:#fff;font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px;margin-left:4px;vertical-align:middle;">PR</span>' : ''}</td>
                        <td style="color:#fff;font-weight:600;">${e.weight} lbs</td>
                        <td>${e.sets}×${e.reps}</td>
                        <td style="color:#888;">${vol.toLocaleString()}</td>
                    </tr>`;
                }).join('');
            }
        }


        // ── LIKES & COMMENTS ──────────────────────────────────────────────────
        async function toggleLike(workoutId, btn) {
            if (!window._sbUserId) return;
            const hasLiked = btn.dataset.liked === 'true';
            // Optimistic UI update immediately
            const newLiked = !hasLiked;
            btn.dataset.liked = String(newLiked);
            updateLikeBtn(btn, newLiked);

            try {
                if (hasLiked) {
                    await sb(`workout_likes?workout_id=eq.${workoutId}&user_id=eq.${window._sbUserId}`, { method: 'DELETE' });
                } else {
                    await sb('workout_likes', { method: 'POST', body: { workout_id: workoutId, user_id: window._sbUserId } });
                }
                // Sync real count
                // Optimistic UI already updated — no refetch needed
                const count = likes?.length || 0;
                // Update ALL like buttons for this workout (feed + profile + detail modal)
                document.querySelectorAll(`[data-workout-id="${workoutId}"] .like-btn, .like-btn[data-wid="${workoutId}"]`).forEach(b => {
                    b.dataset.liked = String(newLiked);
                    updateLikeBtn(b, newLiked, count);
                });
                // Also update the one that was clicked directly
                updateLikeBtn(btn, newLiked, count);
            } catch(e) {
                // Revert on error
                btn.dataset.liked = String(hasLiked);
                updateLikeBtn(btn, hasLiked);
                console.warn('Like error:', e.message);
            }
        }

        function updateLikeBtn(btn, liked, count) {
            const icon = btn.querySelector('.like-icon');
            const label = btn.querySelector('.like-label');
            if (icon) icon.textContent = liked ? '❤️' : '🤍';
            if (label && count !== undefined) label.textContent = count + (count === 1 ? ' Like' : ' Likes');
            btn.style.color = liked ? 'var(--primary)' : '#777';
        }

        async function openComments(workoutId) {
            const modal = document.getElementById('commentsModal');
            if (!modal) {
                // Create modal if it doesn't exist
                const modalHTML = `
                    <div class="modal" id="commentsModal">
                        <div class="modal-content" style="max-width:700px;">
                            <button class="modal-close" onclick="closeCommentsModal()">×</button>
                            <h2 style="margin-bottom:20px;">Comments</h2>
                            <div id="commentsContent" style="max-height:400px;overflow-y:auto;margin-bottom:20px;"></div>
                            <div style="display:flex;gap:10px;">
                                <textarea id="commentInput" rows="2" placeholder="Add a comment..." style="flex:1;padding:12px;background:var(--iron);border:2px solid #333;color:#fff;font-family:'Oswald',sans-serif;font-size:14px;resize:vertical;"></textarea>
                                <button onclick="postComment('${workoutId}')" style="background:var(--primary);color:#fff;border:none;padding:12px 25px;font-family:'Oswald',sans-serif;font-size:14px;text-transform:uppercase;cursor:pointer;align-self:flex-end;">Post</button>
                            </div>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            document.getElementById('commentsModal').classList.add('active');
            document.getElementById('commentsModal').dataset.workoutId = workoutId;
            loadComments(workoutId);
        }

        function closeCommentsModal() {
            document.getElementById('commentsModal').classList.remove('active');
            document.getElementById('commentInput').value = '';
        }

        async function loadComments(workoutId) {
            const content = document.getElementById('commentsContent');
            content.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">Loading...</div>';
            
            try {
                const comments = await sb(`workout_comments?workout_id=eq.${workoutId}&order=created_at.desc&select=*,profiles(full_name,username,initials,avatar_url)`);
                
                if (!comments || comments.length === 0) {
                    content.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">No comments yet. Be the first!</div>';
                    return;
                }
                
                content.innerHTML = comments.map(c => {
                    const profile = c.profiles;
                    const avatarHTML = profile?.avatar_url 
                        ? `<img src="${profile.avatar_url}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" alt="">`
                        : (profile?.initials || '?');
                    const timeAgo = getTimeAgo(new Date(c.created_at));
                    const canDelete = c.user_id === window._sbUserId;
                    
                    return `<div style="display:flex;gap:12px;padding:15px;border-bottom:1px solid #333;">
                        <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:16px;flex-shrink:0;overflow:hidden;">${avatarHTML}</div>
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:5px;">
                                <span style="font-family:'Oswald',sans-serif;font-weight:600;font-size:14px;">${profile?.full_name || 'Unknown'}</span>
                                <span style="color:#666;font-size:12px;">${timeAgo}</span>
                                ${canDelete ? `<button onclick="deleteComment('${c.id}','${workoutId}')" style="margin-left:auto;background:transparent;border:none;color:#666;cursor:pointer;font-size:12px;">Delete</button>` : ''}
                            </div>
                            <div style="color:#ccc;font-size:14px;line-height:1.5;">${c.comment_text}</div>
                        </div>
                    </div>`;
                }).join('');
                
            } catch(e) {
                content.innerHTML = '<div style="text-align:center;padding:20px;color:#ff6b35;">Error loading comments</div>';
            }
        }

        async function postComment(workoutId) {
            const input = document.getElementById('commentInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            try {
                await sb('workout_comments', {
                    method: 'POST',
                    body: {
                        workout_id: workoutId,
                        user_id: window._sbUserId,
                        comment_text: text
                    }
                });
                
                input.value = '';
                loadComments(workoutId);
                
                // Update comment count on card
                const card = document.querySelector(`[data-workout-id="${workoutId}"]`);
                if (card) {
                    const comments = await sb(`workout_comments?workout_id=eq.${workoutId}&select=id`);
                    const count = comments?.length || 0;
                    const btn = card.querySelector('.action-btn:nth-child(2) span:last-child');
                    if (btn) btn.textContent = `${count} ${count===1?'Comment':'Comments'}`;
                }
                
            } catch(e) {
                alert('Error posting comment: ' + e.message);
            }
        }

        async function deleteComment(commentId, workoutId) {
            if (!confirm('Delete this comment?')) return;
            
            try {
                await sb(`workout_comments?id=eq.${commentId}`, { method: 'DELETE' });
                loadComments(workoutId);
                
                // Update count
                const card = document.querySelector(`[data-workout-id="${workoutId}"]`);
                if (card) {
                    const comments = await sb(`workout_comments?workout_id=eq.${workoutId}&select=id`);
                    const count = comments?.length || 0;
                    const btn = card.querySelector('.action-btn:nth-child(2) span:last-child');
                    if (btn) btn.textContent = `${count} ${count===1?'Comment':'Comments'}`;
                }
            } catch(e) {
                alert('Error deleting comment');
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        // ── NAVIGATE ─────────────────────────────────────────────────────────
        function handleNav(page, btn) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            btn.classList.add('active');
            ['feed-page','progress-page','groups-page','profile-page'].forEach(cls => {
                const el = document.querySelector('.' + cls);
                if (el) el.classList.remove('active');
            });
            if (page === 'feed') {
                const fp = document.querySelector('.feed-page');
                if (fp) fp.classList.add('active');
                loadFeedFromSupabase();
            } else if (page === 'progress') {
                const pp = document.querySelector('.progress-page');
                if (pp) pp.classList.add('active');
                setTimeout(() => loadProgressPage(), 100);
            } else if (page === 'groups') {
                const gp = document.querySelector('.groups-page');
                if (gp) gp.classList.add('active');
                if (typeof closeGroupDetail === 'function') closeGroupDetail();
                if (typeof loadGroupsPage === 'function') loadGroupsPage();
            } else if (page === 'profile') {
                const prp = document.querySelector('.profile-page');
                if (prp) prp.classList.add('active');
                if (typeof refreshFollowCounts === 'function') refreshFollowCounts();
            }
        }

        function navigateToFeed() {
            const sp = document.getElementById('signupPage');
            const lp = document.getElementById('loginPage');
            if (sp) { sp.classList.remove('active'); sp.style.display = 'none'; }
            if (lp) { lp.classList.remove('active'); lp.style.display = 'none'; }
            document.querySelectorAll('.feed-page,.progress-page,.groups-page,.profile-page').forEach(p => p.classList.remove('active'));
            const fp = document.querySelector('.feed-page');
            if (fp) fp.classList.add('active');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const feedLink = document.querySelector('.nav-link[data-page="feed"]');
            if (feedLink) feedLink.classList.add('active');
        }
    
        // ── WORKOUT DETAIL + COMMENTS (Instagram style) ──────────────────────
        let wdChartInstance = null;
        window._wdWorkoutId = null;

        function openWorkoutDetail(workoutId, commentBtn) {
            // find workout data from the card
            const card = document.querySelector(`[data-workout-id="${workoutId}"]`);
            const viewBtn = card ? card.querySelector('[data-workout]') : null;
            if (viewBtn) {
                openWorkoutModal(viewBtn, workoutId, commentBtn);
            }
        }

        function openWorkoutModal(btn, overrideId, commentBtn) {
            const w = JSON.parse(btn.getAttribute('data-workout').replace(/&quot;/g,'"').replace(/&#39;/g,"'"));
            const workoutId = overrideId || w.id;
            window._wdWorkoutId = workoutId;
            const exercises = w.exercises || [];

            // Populate header
            document.getElementById('wdTitle').textContent = w.name.toUpperCase();
            const dateStr = new Date(w.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
            document.getElementById('wdMeta').textContent = dateStr + (w.duration ? ' · ' + w.duration + ' min' : '');

            // Like button state — read from the card
            const card = document.querySelector(`[data-workout-id="${workoutId}"]`);
            const cardLikeBtn = card ? card.querySelector('.like-btn') : null;
            const wdLikeBtn = document.getElementById('wdLikeBtn');
            if (cardLikeBtn && wdLikeBtn) {
                const liked = cardLikeBtn.dataset.liked === 'true';
                wdLikeBtn.dataset.liked = String(liked);
                wdLikeBtn.dataset.wid = workoutId;
                updateLikeBtn(wdLikeBtn, liked,
                    parseInt(cardLikeBtn.querySelector('.like-label')?.textContent) || 0);
            }

            // Exercise rows
            const total_vol = exercises.reduce((s,ex) => s+(parseFloat(ex.weight)||0)*(parseInt(ex.sets)||1)*(parseInt(ex.reps)||1), 0);
            document.getElementById('wdExercises').innerHTML = exercises.length ? exercises.map((ex, i) => {
                const vol = (parseFloat(ex.weight)||0)*(parseInt(ex.sets)||1)*(parseInt(ex.reps)||1);
                const isPR = (w.prExercises||[]).includes(ex.name);
                return `<div style="display:flex;align-items:center;gap:12px;padding:13px 16px;${i>0?'border-top:1px solid #1e1e1e;':''}">
                    <div style="width:30px;height:30px;border-radius:8px;background:rgba(255,107,53,0.1);border:1px solid rgba(255,107,53,0.2);
                        display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:13px;color:var(--primary);flex-shrink:0;">${i+1}</div>
                    <div style="flex:1;min-width:0;">
                        <div style="font-family:'Oswald',sans-serif;font-size:14px;font-weight:600;">
                            ${ex.name}${isPR?' <span style="background:var(--accent);color:#000;font-size:9px;font-weight:700;padding:1px 5px;border-radius:3px;vertical-align:middle;">PR</span>':''}
                        </div>
                        <div style="font-family:'Roboto Mono',monospace;font-size:12px;color:#666;margin-top:2px;">
                            ${ex.sets||'?'} sets × ${ex.reps||'?'} reps${ex.weight?' @ <span style="color:var(--primary);">'+ex.weight+' lb</span>':''}
                        </div>
                    </div>
                    <div style="text-align:right;flex-shrink:0;">
                        <div style="font-family:'Bebas Neue',cursive;font-size:15px;color:#fff;">${vol ? vol.toLocaleString() : '—'}</div>
                        <div style="font-size:9px;color:#555;text-transform:uppercase;">vol lbs</div>
                    </div>
                </div>`;
            }).join('') : '<div style="padding:16px;color:#555;text-align:center;font-family:Oswald,sans-serif;font-size:13px;">No exercises logged</div>';

            // Stats
            const maxWeight = exercises.length ? Math.max(...exercises.map(ex=>parseFloat(ex.weight)||0)) : 0;
            document.getElementById('wdStats').innerHTML = [
                { label:'Exercises', val: exercises.length },
                { label:'Total Vol', val: total_vol ? Math.round(total_vol/100)/10+'k lbs' : '—' },
                { label:'Top Weight', val: maxWeight ? maxWeight+' lbs' : '—' }
            ].map(s => `<div style="background:var(--steel);border:1px solid #2a2a2a;border-radius:10px;padding:12px;text-align:center;">
                <div style="font-family:'Bebas Neue',cursive;font-size:20px;color:var(--primary);">${s.val}</div>
                <div style="font-size:9px;color:#555;text-transform:uppercase;letter-spacing:0.5px;margin-top:2px;">${s.label}</div>
            </div>`).join('');

            // Show modal with slide-up animation
            const modal = document.getElementById('workoutDetailModal');
            const pane  = document.getElementById('wdPane');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            // Reset scroll position
            pane.scrollTop = 0;
            // Clear comment input
            document.getElementById('wdCommentInput').value = '';
            // Animate in
            requestAnimationFrame(() => {
                modal.style.background = 'rgba(0,0,0,0.6)';
                pane.style.transform = 'translateY(0)';
            });

            // Build bar chart
            setTimeout(() => {
                if (wdChartInstance) { wdChartInstance.destroy(); wdChartInstance = null; }
                const canvas = document.getElementById('wdChart');
                const wrap   = document.getElementById('wdChartWrap');
                const w2 = wrap.clientWidth || (window.innerWidth - 64);
                canvas.width  = w2;
                canvas.height = 180;
                const ctx = canvas.getContext('2d');
                const labels = exercises.map(ex => ex.name.length > 10 ? ex.name.slice(0,10)+'…' : ex.name);
                const data   = exercises.map(ex => parseFloat(ex.weight)||0);
                const clrs   = exercises.map(ex => (w.prExercises||[]).includes(ex.name) ? '#ffb347' : '#ff6b35');
                wdChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ data, backgroundColor: clrs.map(c=>c+'28'), borderColor: clrs, borderWidth: 2, borderRadius: 6, borderSkipped: false }] },
                    options: { responsive:false, plugins: { legend:{display:false}, tooltip:{backgroundColor:'#1e1e1e',titleColor:'#ff6b35',bodyColor:'#fff',borderColor:'#ff6b35',borderWidth:1,callbacks:{label:c=>c.parsed.y+' lbs'}} },
                        scales: { y:{beginAtZero:true,grid:{color:'rgba(255,255,255,0.04)'},border:{color:'#2a2a2a'},ticks:{color:'#555',font:{size:10},callback:v=>v+'lb'}}, x:{grid:{display:false},border:{color:'#2a2a2a'},ticks:{color:'#ccc',font:{size:11,family:'Oswald'}}} } }
                });
            }, 80);

            // Load comments
            loadWdComments(workoutId);
        }

        function closeWorkoutModal() {
            const modal = document.getElementById('workoutDetailModal');
            const pane  = document.getElementById('wdPane');
            modal.style.background = 'rgba(0,0,0,0)';
            pane.style.transform = 'translateY(100%)';
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }, 350);
            if (wdChartInstance) { wdChartInstance.destroy(); wdChartInstance = null; }
        }

        async function loadWdComments(workoutId) {
            const el = document.getElementById('wdComments');
            el.innerHTML = '<div style="padding:20px;color:#555;font-family:Oswald,sans-serif;font-size:13px;text-align:center;">Loading...</div>';
            try {
                const comments = await sb(`workout_comments?workout_id=eq.${workoutId}&order=created_at.asc&select=*,profiles(full_name,username,initials,avatar_url)`);
                if (!comments || comments.length === 0) {
                    el.innerHTML = '<div style="padding:20px;color:#444;font-family:Oswald,sans-serif;font-size:13px;text-align:center;">No comments yet — be the first!</div>';
                    return;
                }
                el.innerHTML = comments.map(c => {
                    const p = c.profiles;
                    const avatar = p?.avatar_url
                        ? `<img src="${p.avatar_url}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" alt="">`
                        : (p?.initials || '?');
                    const timeAgo = getTimeAgo(new Date(c.created_at));
                    const canDel = c.user_id === window._sbUserId;
                    return `<div style="display:flex;gap:10px;padding:12px 0;border-bottom:1px solid #1a1a1a;align-items:flex-start;">
                        <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));
                            display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:13px;flex-shrink:0;overflow:hidden;">${avatar}</div>
                        <div style="flex:1;min-width:0;">
                            <div style="display:flex;align-items:baseline;gap:8px;flex-wrap:wrap;">
                                <span style="font-family:'Oswald',sans-serif;font-size:13px;font-weight:600;color:#fff;">${p?.full_name||'Unknown'}</span>
                                <span style="font-size:11px;color:#444;">${timeAgo}</span>
                                ${canDel?`<button onclick="deleteWdComment('${c.id}')" style="margin-left:auto;background:none;border:none;color:#333;cursor:pointer;font-size:11px;font-family:'Oswald',sans-serif;">Delete</button>`:''}
                            </div>
                            <div style="color:#ccc;font-size:14px;line-height:1.5;margin-top:3px;">${c.comment_text}</div>
                        </div>
                    </div>`;
                }).join('');
            } catch(e) {
                el.innerHTML = '<div style="padding:16px;color:#444;font-size:13px;text-align:center;">Comments unavailable</div>';
            }
        }

        async function postWorkoutComment() {
            const input = document.getElementById('wdCommentInput');
            const text = input.value.trim();
            if (!text || !window._wdWorkoutId || !window._sbUserId) return;
            input.value = '';
            input.style.height = 'auto';
            try {
                await sb('workout_comments', { method:'POST', body:{ workout_id: window._wdWorkoutId, user_id: window._sbUserId, comment_text: text }});
                loadWdComments(window._wdWorkoutId);
                // Sync comment count on cards
                // Increment comment count locally — no extra round-trip
                const count = countRes?.length || 0;
                document.querySelectorAll(`.comment-label-${window._wdWorkoutId}`).forEach(el => {
                    el.textContent = count + (count===1?' Comment':' Comments');
                });
            } catch(e) { console.warn('Comment error:', e.message); }
        }

        async function deleteWdComment(commentId) {
            if (!confirm('Delete comment?')) return;
            try {
                await sb(`workout_comments?id=eq.${commentId}`, { method:'DELETE' });
                loadWdComments(window._wdWorkoutId);
            } catch(e) {}
        }

        </script>



    <!-- ── LOG PICKER SHEET ──────────────────────────────────────────────── -->
    <div id="logPickerSheet" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,0);z-index:3500;align-items:flex-end;justify-content:center;transition:background 0.28s;">
        <!-- Backdrop tap to close -->
        <div onclick="closeLogPicker()" style="position:absolute;top:0;left:0;width:100%;height:100%;"></div>
        <div id="logPickerInner" style="position:relative;width:100%;max-width:600px;background:var(--iron);
            border-radius:20px 20px 0 0;border-top:3px solid var(--primary);padding:0 0 40px;
            transform:translateY(100%);transition:transform 0.28s cubic-bezier(0.32,0.72,0,1);max-height:88vh;overflow-y:auto;">

            <!-- Handle + close -->
            <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px 12px;">
                <div style="width:36px;height:4px;background:#333;border-radius:2px;margin:0 auto;"></div>
                <button onclick="closeLogPicker()" style="position:absolute;right:16px;top:12px;
                    background:rgba(255,255,255,0.06);border:none;color:#fff;width:30px;height:30px;
                    border-radius:50%;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;">✕</button>
            </div>

            <div style="padding:4px 20px 0;">
                <div style="font-family:'Bebas Neue',cursive;font-size:28px;letter-spacing:2px;color:#fff;margin-bottom:4px;">What are you logging?</div>
                <div style="font-family:'Oswald',sans-serif;font-size:13px;color:#555;margin-bottom:20px;">Choose where this workout gets posted</div>

                <!-- ── Personal workout ── -->
                <button onclick="startPersonalLog()"
                    style="display:flex;align-items:center;gap:16px;width:100%;padding:16px;
                    background:rgba(255,107,53,0.06);border:1.5px solid rgba(255,107,53,0.3);border-radius:14px;
                    color:#fff;cursor:pointer;text-align:left;margin-bottom:12px;transition:all 0.2s;"
                    onmouseover="this.style.borderColor='var(--primary)';this.style.background='rgba(255,107,53,0.12)'"
                    onmouseout="this.style.borderColor='rgba(255,107,53,0.3)';this.style.background='rgba(255,107,53,0.06)'">
                    <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--accent));
                        display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;">&#x1F4AA;</div>
                    <div style="flex:1;">
                        <div style="font-family:'Bebas Neue',cursive;font-size:20px;letter-spacing:1px;margin-bottom:2px;">Personal Workout</div>
                        <div style="font-family:'Oswald',sans-serif;font-size:12px;color:#888;">Log to your profile &amp; the public feed</div>
                    </div>
                    <div style="color:var(--primary);font-size:22px;flex-shrink:0;">›</div>
                </button>

                <!-- ── Group post ── -->
                <div style="font-family:'Oswald',sans-serif;font-size:11px;text-transform:uppercase;letter-spacing:1px;
                    color:#555;margin-bottom:10px;padding-left:2px;">Post Workout to a Group</div>
                <div id="pickerGroupList"></div>

                <!-- No groups placeholder — shown by JS when list is empty -->
                <div style="padding:4px 0 4px;">
                    <button onclick="handleNav('groups',document.querySelector('[data-page=groups]'));closeLogPicker()"
                        style="display:flex;align-items:center;gap:12px;width:100%;padding:14px 16px;
                        background:rgba(255,255,255,0.03);border:1.5px dashed #2a2a2a;border-radius:12px;
                        color:#555;cursor:pointer;text-align:left;transition:all 0.2s;"
                        onmouseover="this.style.borderColor='#444';this.style.color='#888'"
                        onmouseout="this.style.borderColor='#2a2a2a';this.style.color='#555'">
                        <div style="width:38px;height:38px;border-radius:8px;background:rgba(255,255,255,0.04);
                            display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">＋</div>
                        <span style="font-family:'Oswald',sans-serif;font-size:13px;text-transform:uppercase;letter-spacing:1px;">Create or join a group</span>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- ── COMPLETE WORKOUT SHEET ──────────────────────────────────────────── -->
    <div id="completeSheet" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,0);z-index:4000;align-items:flex-end;justify-content:center;
        transition:background 0.28s;">
        <!-- Backdrop -->
        <div onclick="closeCompleteSheet()" style="position:absolute;top:0;left:0;width:100%;height:100%;"></div>
        <div id="completeSheetInner" style="position:relative;width:100%;max-width:600px;background:var(--iron);
            border-radius:20px 20px 0 0;border-top:3px solid var(--primary);
            transform:translateY(100%);transition:transform 0.28s cubic-bezier(0.32,0.72,0,1);
            max-height:88vh;overflow-y:auto;">

            <!-- Handle + header -->
            <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px 12px;
                position:sticky;top:0;background:var(--iron);z-index:10;border-bottom:1px solid #2a2a2a;">
                <div>
                    <div style="font-family:'Bebas Neue',cursive;font-size:26px;letter-spacing:2px;color:var(--primary);line-height:1;">
                        Workout Complete! 💪
                    </div>
                    <div style="font-family:'Oswald',sans-serif;font-size:12px;color:#555;text-transform:uppercase;letter-spacing:1px;margin-top:2px;">
                        Share your effort with the group
                    </div>
                </div>
                <button onclick="closeCompleteSheet()"
                    style="background:rgba(255,255,255,0.06);border:none;color:#fff;width:32px;height:32px;
                    border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;
                    justify-content:center;flex-shrink:0;">✕</button>
            </div>

            <div style="padding:16px 20px calc(30px + env(safe-area-inset-bottom));display:flex;flex-direction:column;gap:14px;">

                <!-- Photo upload -->
                <div>
                    <label style="display:block;font-size:11px;font-weight:600;text-transform:uppercase;
                        letter-spacing:1px;color:#666;margin-bottom:8px;">Add a Photo <span style="color:#444;">(optional)</span></label>
                    <div id="completePhotoZone" onclick="document.getElementById('completePhotoInput').click()"
                        style="border:1.5px dashed rgba(255,107,53,0.3);border-radius:12px;padding:22px;
                        text-align:center;background:rgba(255,107,53,0.03);cursor:pointer;position:relative;
                        transition:border-color 0.2s;"
                        onmouseover="this.style.borderColor='var(--primary)'"
                        onmouseout="this.style.borderColor='rgba(255,107,53,0.3)'">
                        <div id="completePhotoInner">
                            <div style="font-size:28px;margin-bottom:4px;">📸</div>
                            <div style="font-family:'Oswald',sans-serif;font-size:11px;color:#555;
                                text-transform:uppercase;letter-spacing:1px;">Tap to add photo</div>
                        </div>
                        <img id="completePreviewImg" style="display:none;width:100%;border-radius:10px;
                            max-height:280px;object-fit:cover;" alt="">
                        <button type="button" id="completeRemovePhoto"
                            onclick="event.stopPropagation();removeCompletePhoto()"
                            style="display:none;position:absolute;top:10px;right:10px;
                            background:rgba(0,0,0,0.7);border:none;color:#fff;width:28px;height:28px;
                            border-radius:50%;font-size:15px;cursor:pointer;align-items:center;
                            justify-content:center;">✕</button>
                    </div>
                    <input type="file" id="completePhotoInput" accept="image/*" style="display:none;"
                        onchange="handleCompletePhotoSelect(this)">
                </div>

                <!-- Comment -->
                <div>
                    <label style="display:block;font-size:11px;font-weight:600;text-transform:uppercase;
                        letter-spacing:1px;color:#666;margin-bottom:8px;">Leave a Comment <span style="color:#444;">(optional)</span></label>
                    <textarea id="completeCommentInput" rows="3"
                        placeholder="How was the workout? Any PRs? 🔥"
                        style="width:100%;padding:13px 15px;background:#1e1e1e;border:1.5px solid #2a2a2a;
                        border-radius:10px;color:#fff;font-family:'Oswald',sans-serif;font-size:15px;
                        outline:none;resize:none;box-sizing:border-box;transition:border-color 0.2s;"
                        onfocus="this.style.borderColor='var(--primary)'"
                        onblur="this.style.borderColor='#2a2a2a'"></textarea>
                </div>

                <!-- Buttons -->
                <div style="display:flex;gap:10px;">
                    <button onclick="closeCompleteSheet()"
                        style="flex:1;padding:14px;background:rgba(255,255,255,0.05);border:1px solid #333;
                        border-radius:12px;color:#888;font-family:'Oswald',sans-serif;font-size:15px;
                        font-weight:600;cursor:pointer;text-transform:uppercase;letter-spacing:1px;">
                        Cancel
                    </button>
                    <button id="completeSubmitBtn" onclick="submitCompletion()"
                        style="flex:2;padding:14px;background:var(--primary);border:none;border-radius:12px;
                        color:#fff;font-family:'Oswald',sans-serif;font-size:15px;font-weight:600;
                        cursor:pointer;text-transform:uppercase;letter-spacing:2px;transition:all 0.2s;">
                        Post Completion
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ── EDIT WORKOUT MODAL ─────────────────────────────────────────────── -->
    <div id="editWorkoutModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,0.85);z-index:4000;align-items:flex-end;justify-content:center;">
        <div style="width:100%;max-width:600px;background:var(--iron);border-radius:20px 20px 0 0;
            border-top:3px solid var(--primary);max-height:92vh;overflow-y:auto;position:relative;">

            <!-- Header -->
            <div style="position:sticky;top:0;background:var(--iron);z-index:10;
                display:flex;align-items:center;justify-content:space-between;padding:18px 20px;
                border-bottom:1px solid #2a2a2a;">
                <h2 style="font-family:'Bebas Neue',cursive;font-size:28px;letter-spacing:2px;color:var(--primary);margin:0;">Edit Workout</h2>
                <button onclick="closeEditModal()" style="background:rgba(255,255,255,0.08);border:none;color:#fff;
                    width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer;
                    display:flex;align-items:center;justify-content:center;">✕</button>
            </div>

            <div style="padding:16px 20px 40px;display:flex;flex-direction:column;gap:16px;">

                <!-- Name -->
                <div>
                    <label style="display:block;font-size:11px;font-weight:600;text-transform:uppercase;
                        letter-spacing:1px;color:#666;margin-bottom:7px;">Workout Name</label>
                    <input id="editWorkoutName" type="text" placeholder="e.g., Push Day · Chest & Triceps"
                        style="width:100%;padding:13px 15px;background:#1e1e1e;border:1.5px solid #2a2a2a;
                        border-radius:10px;color:#fff;font-family:'Oswald',sans-serif;font-size:15px;
                        outline:none;box-sizing:border-box;transition:border-color 0.2s;"
                        onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#2a2a2a'">
                </div>

                <!-- Duration -->
                <div>
                    <label style="display:block;font-size:11px;font-weight:600;text-transform:uppercase;
                        letter-spacing:1px;color:#666;margin-bottom:7px;">Duration (minutes)</label>
                    <input id="editWorkoutDuration" type="number" placeholder="60"
                        style="width:100%;padding:13px 15px;background:#1e1e1e;border:1.5px solid #2a2a2a;
                        border-radius:10px;color:#fff;font-family:'Oswald',sans-serif;font-size:15px;
                        outline:none;box-sizing:border-box;transition:border-color 0.2s;"
                        onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#2a2a2a'">
                </div>

                <!-- Caption -->
                <div>
                    <label style="display:block;font-size:11px;font-weight:600;text-transform:uppercase;
                        letter-spacing:1px;color:#666;margin-bottom:7px;">Caption (Optional)</label>
                    <textarea id="editWorkoutCaption" rows="2" placeholder="How did the session feel?"
                        style="width:100%;padding:13px 15px;background:#1e1e1e;border:1.5px solid #2a2a2a;
                        border-radius:10px;color:#fff;font-family:'Oswald',sans-serif;font-size:15px;
                        outline:none;resize:none;box-sizing:border-box;transition:border-color 0.2s;"
                        onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#2a2a2a'"></textarea>
                </div>

                <!-- Photo -->
                <div>
                    <label style="display:block;font-size:11px;font-weight:600;text-transform:uppercase;
                        letter-spacing:1px;color:#666;margin-bottom:7px;">Photo</label>
                    <div id="editPhotoZone" onclick="document.getElementById('editPhotoInput').click()"
                        style="border:1.5px dashed rgba(255,107,53,0.3);border-radius:12px;padding:24px;
                        text-align:center;background:rgba(255,107,53,0.03);cursor:pointer;
                        position:relative;transition:border-color 0.2s;"
                        onmouseover="this.style.borderColor='var(--primary)'"
                        onmouseout="this.style.borderColor='rgba(255,107,53,0.3)'">
                        <div id="editPhotoZoneInner">
                            <div style="font-size:28px;margin-bottom:6px;">📸</div>
                            <div style="font-family:'Oswald',sans-serif;font-size:11px;color:#555;
                                text-transform:uppercase;letter-spacing:1px;">Tap to change photo</div>
                        </div>
                        <img id="editPreviewImage" style="display:none;width:100%;border-radius:10px;
                            max-height:260px;object-fit:cover;" alt="">
                        <button type="button" id="editRemovePhoto"
                            onclick="event.stopPropagation();removeEditPhoto()"
                            style="display:none;position:absolute;top:10px;right:10px;
                            background:rgba(0,0,0,0.75);border:none;color:#fff;width:28px;height:28px;
                            border-radius:50%;font-size:15px;cursor:pointer;align-items:center;justify-content:center;">✕</button>
                    </div>
                    <input type="file" id="editPhotoInput" accept="image/*" style="display:none;"
                        onchange="handleEditPhotoSelect(this)">
                </div>

                <!-- Exercises -->
                <div>
                    <label style="display:block;font-size:11px;font-weight:600;text-transform:uppercase;
                        letter-spacing:1px;color:#666;margin-bottom:10px;">Exercises</label>
                    <div id="editExerciseContainer"></div>
                    <button type="button" onclick="addEditExercise()"
                        style="width:100%;margin-top:8px;padding:11px;background:transparent;
                        border:1.5px dashed #333;border-radius:10px;color:#555;
                        font-family:'Oswald',sans-serif;font-size:13px;font-weight:600;
                        text-transform:uppercase;letter-spacing:1px;cursor:pointer;transition:all 0.2s;"
                        onmouseover="this.style.borderColor='var(--primary)';this.style.color='var(--primary)'"
                        onmouseout="this.style.borderColor='#333';this.style.color='#555'">
                        + Add Exercise
                    </button>
                </div>

                <!-- Save / Cancel -->
                <div style="display:flex;gap:10px;padding-top:4px;">
                    <button onclick="closeEditModal()"
                        style="flex:1;padding:14px;background:rgba(255,255,255,0.05);border:1px solid #333;
                        border-radius:12px;color:#888;font-family:'Oswald',sans-serif;font-size:15px;
                        font-weight:600;cursor:pointer;text-transform:uppercase;letter-spacing:1px;">
                        Cancel
                    </button>
                    <button id="editSaveBtn" onclick="saveEditWorkout()"
                        style="flex:2;padding:14px;background:var(--primary);border:none;border-radius:12px;
                        color:#fff;font-family:'Oswald',sans-serif;font-size:15px;font-weight:600;
                        cursor:pointer;text-transform:uppercase;letter-spacing:2px;transition:all 0.2s;">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Workout Detail + Comments Modal -->
    <div id="workoutDetailModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
        z-index:3000;background:rgba(0,0,0,0);transition:background 0.3s;">
        <div id="wdPane" style="position:absolute;top:0;left:0;right:0;bottom:0;overflow-y:auto;
            -webkit-overflow-scrolling:touch;
            background:var(--black);transform:translateY(100%);transition:transform 0.35s cubic-bezier(0.32,0.72,0,1);">
            <div style="max-width:600px;margin:0 auto;">

                <!-- Header — scrolls with content, padded for status bar -->
                <div style="display:flex;align-items:center;gap:10px;
                    padding:calc(env(safe-area-inset-top) + 16px) 16px 14px;
                    border-bottom:1px solid #1e1e1e;">
                    <button onclick="closeWorkoutModal()"
                        style="background:rgba(255,255,255,0.1);border:none;color:#fff;
                        width:36px;height:36px;border-radius:50%;font-size:20px;cursor:pointer;
                        display:flex;align-items:center;justify-content:center;flex-shrink:0;
                        -webkit-tap-highlight-color:rgba(255,107,53,0.2);">←</button>
                    <div style="flex:1;min-width:0;">
                        <div id="wdTitle" style="font-family:'Bebas Neue',cursive;font-size:22px;letter-spacing:1px;
                            color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2;"></div>
                        <div id="wdMeta" style="font-size:11px;color:#555;margin-top:1px;"></div>
                    </div>
                    <button class="like-btn" id="wdLikeBtn" onclick="toggleLike(window._wdWorkoutId,this)"
                        data-liked="false" data-wid=""
                        style="flex-shrink:0;background:none;border:none;cursor:pointer;
                        display:flex;align-items:center;gap:5px;color:#777;padding:8px;
                        -webkit-tap-highlight-color:rgba(255,107,53,0.2);">
                        <span class="like-icon" style="font-size:22px;">&#x1F90D;</span>
                        <span class="like-label" style="font-family:'Oswald',sans-serif;font-size:13px;font-weight:600;">0</span>
                    </button>
                </div>

                <!-- Chart -->
                <div style="padding:14px 16px 6px;">
                    <div style="background:var(--steel);border-radius:12px;padding:14px;border:1px solid #2a2a2a;">
                        <div style="font-family:'Oswald',sans-serif;font-size:10px;text-transform:uppercase;
                            letter-spacing:1px;color:#555;margin-bottom:10px;">Weight per Exercise (lbs)</div>
                        <div id="wdChartWrap" style="position:relative;height:180px;">
                            <canvas id="wdChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div id="wdStats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:6px 16px;"></div>

                <!-- Exercises -->
                <div style="margin:6px 16px 0;background:var(--steel);border-radius:12px;overflow:hidden;border:1px solid #2a2a2a;">
                    <div style="padding:10px 16px;border-bottom:1px solid #1e1e1e;font-family:'Oswald',sans-serif;
                        font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#555;">Exercise Breakdown</div>
                    <div id="wdExercises"></div>
                </div>

                <!-- Comments -->
                <div style="padding:16px 16px 0;">
                    <div style="font-family:'Oswald',sans-serif;font-size:10px;text-transform:uppercase;
                        letter-spacing:1px;color:#555;margin-bottom:10px;">Comments</div>
                    <div id="wdComments"></div>
                </div>

                <!-- Comment input — padded for home indicator -->
                <div style="padding:12px 16px calc(24px + env(safe-area-inset-bottom));">
                    <div style="display:flex;align-items:flex-end;background:#1a1a1a;border-radius:12px;
                        border:1px solid #2a2a2a;overflow:hidden;">
                        <textarea id="wdCommentInput" rows="1" placeholder="Add a comment..."
                            style="flex:1;padding:12px 14px;background:transparent;border:none;color:#fff;
                            font-family:'Oswald',sans-serif;font-size:16px;resize:none;outline:none;
                            max-height:100px;overflow-y:auto;"
                            oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px'"
                            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();postWorkoutComment();}"></textarea>
                        <button onclick="postWorkoutComment()"
                            style="background:var(--primary);border:none;color:#fff;padding:13px 20px;
                            font-family:'Oswald',sans-serif;font-size:14px;font-weight:600;text-transform:uppercase;
                            letter-spacing:1px;cursor:pointer;align-self:stretch;flex-shrink:0;">Post</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

</body>
</html>
