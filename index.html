<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SplitShare - Track Your Strength</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Bebas+Neue&family=Roboto+Mono:wght@400;500&display=swap" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Bebas+Neue&family=Roboto+Mono:wght@400;500&display=swap"></noscript>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <style>
        :root {
            --black: #0a0a0a;
            --white: #fafafa;
            --iron: #1a1a1a;
            --steel: #2a2a2a;
            --primary: #ff6b35;
            --primary-dark: #ff5722;
            --primary-light: #ff8c61;
            --accent: #ffb347;
            --highlight: #ffd89b;
            --sweat: #ff9966;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

        body {
            font-family: 'Oswald', sans-serif;
            background: var(--black);
            color: var(--white);
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, var(--iron) 1px, transparent 1px),
                linear-gradient(180deg, var(--iron) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.3;
            z-index: 0;
            animation: gridPulse 4s ease-in-out infinite;
        }

        @keyframes gridPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.15; }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            padding: 20px 0;
            border-bottom: 3px solid var(--primary);
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .header-content {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo {
            font-family: 'Bebas Neue', cursive;
            font-size: 42px;
            letter-spacing: 4px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 107, 53, 0.3);
        }

        /* Bottom Navigation Bar */
        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--iron);
            border-top: 2px solid var(--primary);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 12px 0 calc(12px + env(safe-area-inset-bottom));
            z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
        }

        nav a {
            color: #999;
            text-decoration: none;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            flex: 1;
            max-width: 100px;
        }

        nav a::before {
            display: none;
        }

        nav a svg {
            transition: all 0.3s ease;
            color: #888;
            fill: #888;
            opacity: 0.8;
        }

        nav a:hover svg {
            color: var(--primary);
            fill: var(--primary);
            opacity: 1;
        }

        nav a:hover {
            color: var(--primary);
        }

        nav a.active {
            color: var(--primary);
        }

        nav a.active svg {
            color: var(--primary);
            fill: var(--primary);
            opacity: 1;
            filter: drop-shadow(0 0 6px rgba(255, 107, 53, 0.5));
        }

        nav a::after {
            display: none;
        }

        /* Center Log Button */
        .log-btn-container {
            position: relative;
            flex: 0 0 auto;
            margin: 0 10px;
        }

        .log-btn {
            background: var(--primary);
            color: var(--white);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 4px solid var(--iron);
            font-family: 'Oswald', sans-serif;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            overflow: visible;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
            margin-top: -28px;
        }

        .log-btn span {
            position: relative;
            z-index: 1;
        }

        .log-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.6);
        }

        .log-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .log-btn:hover::before {
            width: 100%;
            height: 100%;
        }

        /* Add bottom padding to main content to account for fixed nav */
        main {
            padding-bottom: 140px;
        }

        /* Hero Stats */
        .hero-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 30px 0;
            animation: fadeInUp 0.8s ease-out 0.2s backwards;
        }

        @keyframes fadeInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .stat-card {
            background: linear-gradient(135deg, var(--steel), var(--iron));
            padding: 20px;
            border-left: 4px solid var(--primary);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 107, 53, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            color: var(--white);
            line-height: 1;
        }

        .stat-unit {
            font-size: 16px;
            color: var(--primary);
            margin-left: 5px;
        }

        /* Feed Section */
        .feed-section {
            margin: 20px 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            animation: fadeInUp 1s ease-out 0.4s backwards;
        }

        .section-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 42px;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .filter-tabs {
            display: flex;
            gap: 15px;
        }

        .filter-tab {
            background: transparent;
            color: #999;
            border: 2px solid #333;
            padding: 10px 25px;
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-tab.active,
        .filter-tab:hover {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        /* Activity Cards */
        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .activity-card {
            background: var(--steel);
            border: 1px solid #333;
            padding: 0;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 1.2s ease-out backwards;
            transition: all 0.3s ease;
        }

        .activity-card:nth-child(1) { animation-delay: 0.5s; }
        .activity-card:nth-child(2) { animation-delay: 0.6s; }
        .activity-card:nth-child(3) { animation-delay: 0.7s; }
        .activity-card:nth-child(4) { animation-delay: 0.8s; }

        .activity-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .activity-card:hover::before {
            transform: scaleY(1);
        }

        .activity-card:hover {
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .activity-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px 30px;
            background: rgba(0, 0, 0, 0.3);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            font-weight: 700;
        }

        .activity-user-info h3 {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .activity-time {
            font-size: 13px;
            color: #999;
            font-family: 'Roboto Mono', monospace;
        }

        .workout-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 2px;
            padding: 0 30px;
            margin: 20px 0 10px 0;
            color: var(--white);
        }

        .workout-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        .workout-stat {
            text-align: center;
            padding: 12px;
            background: rgba(255, 107, 53, 0.05);
            border: 1px solid rgba(255, 107, 53, 0.2);
        }

        .workout-stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--primary);
        }

        .workout-stat-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 3px;
        }

        .exercise-list {
            margin: 15px 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .exercise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: var(--iron);
            border-left: 3px solid var(--sweat);
            font-family: 'Roboto Mono', monospace;
        }

        .exercise-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--white);
        }

        .exercise-details {
            color: var(--sweat);
            font-size: 13px;
        }

        .activity-actions {
            display: flex;
            gap: 30px;
            padding: 20px 30px;
            border-top: 1px solid #333;
        }

        .action-btn {
            background: transparent;
            border: none;
            color: #999;
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn:hover {
            color: var(--primary);
        }

        .action-icon {
            font-size: 18px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: flex-start;
            justify-content: center;
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
            padding: 20px 0 100px 0;
        }

        .modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--steel);
            padding: 40px;
            width: 90%;
            max-width: 700px;
            border: 2px solid var(--primary);
            position: relative;
            animation: slideUp 0.4s ease-out;
            margin: auto;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            color: var(--white);
            font-size: 30px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--primary);
        }

        .modal h2 {
            font-family: 'Bebas Neue', cursive;
            font-size: 42px;
            letter-spacing: 3px;
            margin-bottom: 30px;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            color: #ccc;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            background: var(--iron);
            border: 2px solid #333;
            color: var(--white);
            font-family: 'Oswald', sans-serif;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .exercise-inputs {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .add-exercise-btn {
            background: transparent;
            color: var(--sweat);
            border: 2px dashed var(--sweat);
            padding: 12px;
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .add-exercise-btn:hover {
            background: var(--sweat);
            color: var(--black);
        }

        .submit-btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 18px 50px;
            font-family: 'Oswald', sans-serif;
            font-size: 18px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }

        /* Photo Upload Styling */
        .photo-upload-zone {
            border: 2px dashed rgba(255, 107, 53, 0.3);
            padding: 30px;
            text-align: center;
            background: rgba(255, 107, 53, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .photo-upload-zone:hover {
            border-color: var(--primary);
            background: rgba(255, 107, 53, 0.1);
        }

        .photo-upload-zone.has-image {
            padding: 0;
            border-style: solid;
        }

        .upload-icon {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .upload-text {
            color: #999;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #photoInput {
            display: none;
        }

        .preview-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            display: none;
        }

        .preview-image.active {
            display: block;
        }

        .remove-photo {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            color: var(--white);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .remove-photo.active {
            display: flex;
        }

        .remove-photo:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        /* Workout Photo in Activity Cards */
        .workout-photo {
            width: 100%;
            aspect-ratio: 3 / 4;
            object-fit: cover;
            display: block;
            margin: 0;
            border: none;
        }

        .workout-caption {
            font-size: 18px;
            line-height: 1.6;
            color: #fff;
            padding: 20px 30px;
            font-style: normal;
            font-weight: 400;
        }

        /* Workout Details Section */
        .workout-details {
            padding: 25px 30px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid #333;
        }

        .details-toggle {
            background: transparent;
            border: none;
            color: var(--primary);
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            transition: color 0.3s ease;
        }

        .details-toggle:hover {
            color: var(--primary-light);
        }

        .details-toggle-icon {
            transition: transform 0.3s ease;
        }

        .details-toggle.active .details-toggle-icon {
            transform: rotate(180deg);
        }

        .workout-details-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .workout-details-content.active {
            max-height: 1000px;
        }

        /* Exercise row dropdown styles */
        .ex-name-select, .ex-name-custom {
            transition: border-color 0.2s ease;
        }
        .ex-name-select:focus, .ex-name-custom:focus {
            outline: none;
            border-color: var(--primary) !important;
        }
        .ex-name-select option { background: var(--iron); }

        @media (max-width: 600px) {
            .exercise-inputs {
                grid-template-columns: 1fr 1fr 1fr auto !important;
                grid-template-rows: auto auto;
            }
            .exercise-inputs > div:first-child {
                grid-column: 1 / -1;
            }
        }

        /* Step indicator text */
        #stepLabel { transition: all 0.3s ease; }

        /* ── SIMPLIFIED FEED CARD ─────────────────────────────────── */
        .card-exercises-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 0 18px 14px;
        }
        .ex-pill {
            background: rgba(255,107,53,0.1);
            border: 1px solid rgba(255,107,53,0.25);
            color: #ccc;
            font-family: 'Roboto Mono', monospace;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            white-space: nowrap;
        }
        .ex-pill.pr { background: rgba(255,179,71,0.15); border-color: rgba(255,179,71,0.4); color: #ffb347; }
        .card-meta-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 18px 16px;
            gap: 12px;
        }
        .card-duration {
            font-family: 'Roboto Mono', monospace;
            font-size: 12px;
            color: #555;
        }
        .view-workout-btn {
            background: transparent;
            border: 1.5px solid rgba(255,107,53,0.4);
            color: var(--primary);
            font-family: 'Oswald', sans-serif;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 7px 16px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .view-workout-btn:hover {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        /* ── WORKOUT DETAIL MODAL ──────────────────────────────────── */
        #workoutDetailModal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1998;
            background: rgba(0,0,0,0.88);
            align-items: flex-end;
            justify-content: center;
        }
        #workoutDetailModal.active { display: flex; }
        .detail-sheet {
            background: #111;
            width: 100%;
            max-width: 680px;
            max-height: 88vh;
            overflow-y: auto;
            border-radius: 20px 20px 0 0;
            border-top: 2px solid var(--primary);
            padding: 0 0 calc(20px + env(safe-area-inset-bottom));
            animation: slideUp 0.35s cubic-bezier(0.32,0.72,0,1);
            -webkit-overflow-scrolling: touch;
        }
        .detail-drag-handle {
            width: 36px; height: 4px;
            background: #333; border-radius: 2px;
            margin: 12px auto 0;
        }
        .detail-header {
            padding: 18px 20px 0;
        }
        .detail-workout-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 26px;
            letter-spacing: 2px;
            color: #fff;
            margin-bottom: 4px;
        }
        .detail-meta {
            font-family: 'Roboto Mono', monospace;
            font-size: 11px;
            color: #555;
            margin-bottom: 18px;
        }
        .detail-section-label {
            font-family: 'Oswald', sans-serif;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #444;
            padding: 0 20px;
            margin-bottom: 10px;
        }
        .detail-chart-wrap {
            padding: 0 16px;
            margin-bottom: 20px;
        }
        .detail-ex-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .detail-ex-table th {
            font-family: 'Oswald', sans-serif;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
            padding: 8px 20px;
            text-align: left;
            border-bottom: 1px solid #1e1e1e;
        }
        .detail-ex-table td {
            padding: 11px 20px;
            font-family: 'Roboto Mono', monospace;
            font-size: 13px;
            color: #ccc;
            border-bottom: 1px solid #1a1a1a;
        }
        .detail-ex-table tr:last-child td { border-bottom: none; }
        .detail-ex-table td:first-child { color: #fff; font-weight: 500; font-family: 'Oswald', sans-serif; font-size: 14px; letter-spacing: 0.5px; }

        /* ── FEED SEARCH BAR ──────────────────────────────────────── */
        .feed-search-wrap {
            position: relative;
            margin-bottom: 16px;
        }
        .feed-search-input {
            width: 100%;
            padding: 13px 18px 13px 44px;
            background: var(--steel);
            border: 1.5px solid #2a2a2a;
            border-radius: 12px;
            color: #fff;
            font-family: 'Oswald', sans-serif;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s ease;
        }
        .feed-search-input::placeholder { color: #444; }
        .feed-search-input:focus { border-color: var(--primary); }
        .feed-search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #444;
            pointer-events: none;
            font-size: 18px;
        }
        .search-dropdown {
            position: absolute;
            top: calc(100% + 6px);
            left: 0; right: 0;
            background: #161616;
            border: 1.5px solid #2a2a2a;
            border-radius: 12px;
            overflow: hidden;
            z-index: 500;
            box-shadow: 0 12px 40px rgba(0,0,0,0.7);
            display: none;
        }
        .search-dropdown.open { display: block; }
        .search-result-item {
            display: flex;
            align-items: center;
            gap: 13px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.15s ease;
            border-bottom: 1px solid #1e1e1e;
            text-decoration: none;
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: rgba(255,107,53,0.08); }
        .search-result-avatar {
            width: 38px; height: 38px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex; align-items: center; justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            flex-shrink: 0;
            overflow: hidden;
        }
        .search-result-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .search-result-name {
            font-family: 'Oswald', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            letter-spacing: 0.5px;
        }
        .search-result-username {
            font-family: 'Roboto Mono', monospace;
            font-size: 11px;
            color: #555;
            margin-top: 1px;
        }
        .search-no-results {
            padding: 16px;
            text-align: center;
            color: #444;
            font-family: 'Oswald', sans-serif;
            font-size: 13px;
            letter-spacing: 1px;
        }

        /* ── DETAIL SHEET COMMENTS ────────────────────────────────── */
        .detail-comment {
            display: flex;
            gap: 10px;
            padding: 12px 16px;
            border-bottom: 1px solid #161616;
        }
        .detail-comment-avatar {
            width: 30px; height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg,var(--primary),var(--accent));
            display: flex; align-items: center; justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 12px;
            flex-shrink: 0;
            overflow: hidden;
        }
        .detail-comment-avatar img { width:100%;height:100%;object-fit:cover; }
        .detail-comment-name { font-family:'Oswald',sans-serif; font-size:12px; font-weight:600; color:#fff; margin-bottom:2px; }
        .detail-comment-text { font-size:13px; color:#bbb; line-height:1.4; }
        .detail-comment-time { font-family:'Roboto Mono',monospace; font-size:10px; color:#444; margin-top:3px; }
        .detail-comment-input-wrap {
            position: sticky;
            bottom: 0;
            background: #111;
            border-top: 1px solid #1e1e1e;
            padding: 12px 16px calc(12px + env(safe-area-inset-bottom));
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .detail-comment-input {
            flex: 1;
            background: #1a1a1a;
            border: 1.5px solid #2a2a2a;
            border-radius: 20px;
            color: #fff;
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            padding: 10px 16px;
            outline: none;
            transition: border-color 0.2s;
        }
        .detail-comment-input:focus { border-color: var(--primary); }
        .detail-comment-input::placeholder { color: #444; }
        .detail-comment-send {
            background: var(--primary);
            border: none;
            width: 36px; height: 36px;
            border-radius: 50%;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            transition: background 0.2s;
        }
        .detail-comment-send:hover { background: var(--primary-dark); }

        /* Responsive */
        @media (max-width: 1024px) {
            .hero-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .workout-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .logo {
                font-size: 32px;
            }

            nav a {
                font-size: 10px;
                padding: 5px 8px;
                max-width: 80px;
            }

            nav a::before {
                font-size: 20px;
            }

            .log-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
                margin-top: -25px;
            }

            .hero-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 28px;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }

            .workout-stats {
                grid-template-columns: 1fr;
            }

            .exercise-inputs {
                grid-template-columns: 1fr;
            }
        }

        /* Progress Page Styles */
        .progress-page {
            display: none;
        }

        .progress-page.active {
            display: block;
        }

        .feed-page.active {
            display: block;
        }

        .feed-page {
            display: none;
        }

        .progress-header {
            margin: 60px 0 40px 0;
            animation: fadeInUp 0.6s ease-out;
        }

        .progress-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 48px;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .progress-subtitle {
            color: #999;
            font-size: 16px;
            letter-spacing: 1px;
        }

        .exercise-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
            animation: fadeInUp 0.8s ease-out 0.2s backwards;
        }

        .exercise-btn {
            background: var(--steel);
            border: 2px solid #333;
            color: var(--white);
            padding: 20px;
            font-family: 'Oswald', sans-serif;
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .exercise-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .exercise-btn:hover::before,
        .exercise-btn.active::before {
            transform: scaleY(1);
        }

        .exercise-btn:hover,
        .exercise-btn.active {
            border-color: var(--primary);
            background: rgba(255, 107, 53, 0.1);
        }

        .chart-container {
            background: var(--steel);
            border: 1px solid #333;
            padding: 40px;
            margin-bottom: 30px;
            animation: fadeInUp 1s ease-out 0.4s backwards;
        }

        .chart-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            letter-spacing: 2px;
            margin-bottom: 30px;
            color: var(--primary);
        }

        .chart-wrapper {
            position: relative;
            height: 450px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
        }

        .chart-canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .pr-badge {
            display: inline-block;
            background: var(--primary);
            color: var(--white);
            padding: 5px 12px;
            font-size: 12px;
            font-weight: 700;
            border-radius: 3px;
            margin-left: 10px;
            letter-spacing: 1px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 30px;
        }

        .stat-box {
            background: rgba(255, 107, 53, 0.05);
            border: 1px solid rgba(255, 107, 53, 0.2);
            padding: 20px;
            text-align: center;
        }

        .stat-box-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-box-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: var(--primary);
        }

        .workout-history {
            margin-top: 40px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table thead {
            background: rgba(0, 0, 0, 0.3);
        }

        .history-table th {
            padding: 15px;
            text-align: left;
            font-family: 'Oswald', sans-serif;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .history-table td {
            padding: 15px;
            border-bottom: 1px solid #333;
            font-family: 'Roboto Mono', monospace;
            font-size: 14px;
        }

        .history-table tbody tr {
            transition: background 0.3s ease;
        }

        .history-table tbody tr:hover {
            background: rgba(255, 107, 53, 0.05);
        }

        .trend-up {
            color: #4ade80;
        }

        .trend-down {
            color: #f87171;
        }

        .trend-neutral {
            color: #999;
        }

        /* Groups Page Styles */
        .groups-page {
            display: none;
        }

        .groups-page.active {
            display: block;
        }

        .groups-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 60px 0 40px 0;
            animation: fadeInUp 0.6s ease-out;
        }

        .create-group-btn {
            background: var(--primary);
            color: var(--white);
            padding: 15px 35px;
            border: none;
            font-family: 'Oswald', sans-serif;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .create-group-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }

        .group-card {
            background: var(--steel);
            border: 1px solid #333;
            padding: 0;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .group-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .group-header-banner {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            padding: 30px;
            position: relative;
        }

        .group-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 2px;
            color: var(--white);
            margin-bottom: 5px;
        }

        .group-members-count {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Roboto Mono', monospace;
        }

        .group-body {
            padding: 25px;
        }

        .group-description {
            color: #ccc;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .group-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .group-stat {
            text-align: center;
            padding: 12px;
            background: rgba(255, 107, 53, 0.05);
            border: 1px solid rgba(255, 107, 53, 0.2);
        }

        .group-stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--primary);
        }

        .group-stat-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .view-group-btn {
            width: 100%;
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 12px;
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-group-btn:hover {
            background: var(--primary);
            color: var(--white);
        }

        /* Group Detail View */
        .group-detail {
            display: none;
        }

        .group-detail.active {
            display: block;
        }

        .group-detail-header {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            padding: 40px;
            margin-bottom: 30px;
            animation: fadeInUp 0.6s ease-out;
        }

        .back-to-groups {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s ease;
        }

        .back-to-groups:hover {
            color: var(--white);
        }

        .group-detail-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 48px;
            letter-spacing: 3px;
            margin-bottom: 10px;
        }

        .group-detail-info {
            display: flex;
            gap: 30px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        .post-workout-btn {
            background: var(--white);
            color: var(--primary);
            padding: 15px 40px;
            border: none;
            font-family: 'Oswald', sans-serif;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .post-workout-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 107, 53, 0.3);
        }

        .group-workout-feed {
            animation: fadeInUp 0.8s ease-out 0.2s backwards;
        }

        .group-workout-card {
            background: var(--steel);
            border: 1px solid #333;
            padding: 0;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .group-workout-card:hover {
            border-color: var(--primary);
        }

        .workout-posted-by {
            padding: 20px 30px;
            background: rgba(255, 107, 53, 0.1);
            border-bottom: 2px solid var(--primary);
        }

        .posted-by-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .posted-by-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--primary);
        }

        .workout-challenge-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 2px;
            padding: 20px 30px 10px 30px;
        }

        .workout-challenge-description {
            padding: 0 30px 20px 30px;
            color: #ccc;
            font-size: 15px;
            line-height: 1.6;
        }

        .workout-challenge-exercises {
            padding: 0 30px 20px 30px;
        }

        .completions-section {
            padding: 25px 30px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid #333;
        }

        .completions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .completions-title {
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #999;
        }

        .complete-workout-btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 10px 25px;
            font-family: 'Oswald', sans-serif;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .complete-workout-btn:hover {
            background: var(--primary-dark);
        }

        .complete-workout-btn.completed {
            background: #4ade80;
        }

        .completions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .completion-item {
            background: var(--iron);
            padding: 15px;
            border-left: 3px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .completion-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            flex-shrink: 0;
        }

        .completion-info {
            flex: 1;
        }

        .completion-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .completion-time {
            font-size: 11px;
            color: #999;
            font-family: 'Roboto Mono', monospace;
        }

        .completion-status {
            font-size: 20px;
        }

        .completion-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border: 2px solid var(--primary);
            cursor: pointer;
        }

        /* Auth Pages (Login/Signup) */
        .auth-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--black);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .auth-page.active {
            display: flex;
        }

        .auth-container {
            max-width: 450px;
            width: 90%;
            animation: slideUp 0.5s ease-out;
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-logo-text {
            font-family: 'Bebas Neue', cursive;
            font-size: 56px;
            letter-spacing: 4px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-tagline {
            color: #999;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 10px;
        }

        .auth-form {
            background: var(--steel);
            padding: 40px;
            border: 2px solid var(--primary);
        }

        .auth-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            letter-spacing: 2px;
            color: var(--primary);
            margin-bottom: 30px;
        }

        .auth-input-group {
            margin-bottom: 20px;
        }

        .auth-input-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            color: #ccc;
        }

        .auth-input-group input {
            width: 100%;
            padding: 15px;
            background: var(--iron);
            border: 2px solid #333;
            color: var(--white);
            font-family: 'Oswald', sans-serif;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .auth-input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-submit-btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 18px;
            font-family: 'Oswald', sans-serif;
            font-size: 18px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .auth-submit-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .auth-switch {
            text-align: center;
            margin-top: 25px;
            color: #999;
            font-size: 14px;
        }

        .auth-switch-link {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
            font-weight: 600;
        }

        .auth-switch-link:hover {
            color: var(--primary-light);
        }

        /* Profile Page */
        .profile-page {
            display: none;
        }

        .profile-page.active {
            display: block;
        }

        .profile-header {
            background: linear-gradient(135deg, var(--steel), var(--iron));
            padding: 40px 40px 30px;
            margin-bottom: 30px;
            margin-left: -20px;
            margin-right: -20px;
            border-bottom: 3px solid var(--primary);
            animation: fadeInUp 0.6s ease-out;
        }

        .profile-top {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 30px;
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 48px;
            border: 4px solid var(--primary);
            flex-shrink: 0;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 42px;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }

        .profile-username {
            color: var(--primary);
            font-size: 18px;
            font-family: 'Roboto Mono', monospace;
            margin-bottom: 15px;
        }

        .profile-bio {
            color: #ccc;
            line-height: 1.6;
            font-size: 15px;
            margin-bottom: 20px;
        }

        .profile-stats-row {
            display: flex;
            gap: 30px;
        }

        .profile-stat-item {
            text-align: center;
        }

        .profile-stat-number {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: var(--primary);
        }

        .profile-stat-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .profile-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .edit-profile-btn, .logout-btn {
            padding: 12px 30px;
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .edit-profile-btn {
            background: var(--primary);
            color: var(--white);
        }

        .edit-profile-btn:hover {
            background: var(--primary-dark);
        }

        .logout-btn {
            background: transparent;
            border: 2px solid #666;
            color: #999;
        }

        .logout-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .profile-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #333;
            margin-bottom: 30px;
            margin-left: -20px;
            margin-right: -20px;
            padding-left: 10px;
        }

        .profile-tab {
            background: transparent;
            border: none;
            color: #999;
            padding: 15px 30px;
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .profile-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .profile-tab:hover {
            color: var(--primary);
        }

        .profile-content {
            animation: fadeInUp 0.8s ease-out 0.2s backwards;
        }

        .profile-tab-content {
            display: none;
        }

        .profile-tab-content.active {
            display: block;
        }

        .profile-achievements {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .achievement-card {
            background: var(--steel);
            border: 1px solid #333;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .achievement-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .achievement-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .achievement-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .achievement-description {
            font-size: 13px;
            color: #999;
        }

        .no-auth-message {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .no-auth-message h2 {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .login-prompt-btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 15px 40px;
            font-family: 'Oswald', sans-serif;
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .login-prompt-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }



    </style>
</head>
<body>
    <div class="bg-grid"></div>
    
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">SPLITSHARE</div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Hero Stats -->
        <!-- Feed Page -->
        <div class="feed-page active">
            <!-- Feed Section -->
        <section class="feed-section">

            <!-- Search bar -->
            <div class="feed-search-wrap" id="feedSearchWrap">
                <span class="feed-search-icon">🔍</span>
                <input
                    class="feed-search-input"
                    id="feedSearchInput"
                    type="text"
                    placeholder="Search people…"
                    autocomplete="off"
                    oninput="onFeedSearch(this.value)"
                    onfocus="if(this.value.trim()) openSearchDropdown()"
                >
                <div class="search-dropdown" id="searchDropdown"></div>
            </div>

            <div class="section-header" style="margin-top:0;margin-bottom:14px;">
                <div class="filter-tabs">
                    <button class="filter-tab active">Following</button>
                    <button class="filter-tab">Everyone</button>
                    <button class="filter-tab">My Workouts</button>
                </div>
            </div>

            <div class="activity-feed" id="mainFeed">
                <div id="feedEmptyState" style="text-align:center;padding:60px 20px;color:#999;display:none;">
                    <div style="font-size:64px;margin-bottom:15px;">🏋️</div>
                    <h3 style="font-family:'Bebas Neue',cursive;font-size:32px;color:var(--primary);margin-bottom:10px;">NO WORKOUTS YET</h3>
                    <p>Be the first to log a workout below!</p>
                </div>
            </div>
        </section>
        </div>
        <!-- End Feed Page -->

        <!-- Progress Page -->
        <div class="progress-page">

            <!-- Overview Stats -->
            <div style="padding:16px 0 10px;">
                <h1 style="font-family:'Bebas Neue',cursive;font-size:30px;letter-spacing:2px;color:#fff;margin-bottom:14px;">Progress</h1>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
                    <div style="background:var(--steel);border-radius:12px;padding:14px 10px;text-align:center;border:1px solid #2a2a2a;">
                        <div id="pgTotalWorkouts" style="font-family:'Bebas Neue',cursive;font-size:32px;color:var(--primary);line-height:1;">0</div>
                        <div style="font-family:'Oswald',sans-serif;font-size:10px;color:#666;text-transform:uppercase;letter-spacing:0.5px;margin-top:4px;">Total<br>Workouts</div>
                    </div>
                    <div style="background:var(--steel);border-radius:12px;padding:14px 10px;text-align:center;border:1px solid #2a2a2a;">
                        <div id="pgWeekMins" style="font-family:'Bebas Neue',cursive;font-size:32px;color:var(--primary);line-height:1;">0</div>
                        <div style="font-family:'Oswald',sans-serif;font-size:10px;color:#666;text-transform:uppercase;letter-spacing:0.5px;margin-top:4px;">Mins This<br>Week</div>
                    </div>
                    <div style="background:var(--steel);border-radius:12px;padding:14px 10px;text-align:center;border:1px solid #2a2a2a;position:relative;overflow:hidden;">
                        <div style="position:absolute;top:6px;right:8px;font-size:14px;">🔥</div>
                        <div id="pgStreak" style="font-family:'Bebas Neue',cursive;font-size:32px;color:var(--primary);line-height:1;">0</div>
                        <div style="font-family:'Oswald',sans-serif;font-size:10px;color:#666;text-transform:uppercase;letter-spacing:0.5px;margin-top:4px;">Day<br>Streak</div>
                    </div>
                </div>
            </div>

            <!-- Lift Selector Dropdown -->
            <div style="margin-bottom:14px;">
                <label style="display:block;font-family:'Oswald',sans-serif;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:#555;margin-bottom:8px;">Select a Lift</label>
                <div style="position:relative;">
                    <select id="liftDropdown" onchange="onLiftDropdownChange(this.value)"
                        style="width:100%;padding:13px 40px 13px 16px;background:#1a1a1a;border:1.5px solid #2a2a2a;border-radius:10px;color:#fff;font-family:'Oswald',sans-serif;font-size:15px;font-weight:600;outline:none;appearance:none;cursor:pointer;"
                        onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#2a2a2a'">
                        <option value="">— Choose a lift —</option>
                    </select>
                    <svg style="position:absolute;right:14px;top:50%;transform:translateY(-50%);pointer-events:none;width:16px;height:16px;stroke:var(--primary);" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
            </div>

            <!-- Chart + Stats -->
            <div id="liftDetailSection" style="display:none;">
                <div style="background:var(--steel);border-radius:12px;padding:16px 14px;margin-bottom:12px;border:1px solid #2a2a2a;">
                    <div id="chartTitle" style="font-family:'Bebas Neue',cursive;font-size:22px;letter-spacing:1.5px;color:#fff;margin-bottom:2px;"></div>
                    <div id="chartPrBadge" style="display:inline-block;background:var(--primary);color:#fff;font-family:'Oswald',sans-serif;font-size:11px;font-weight:700;padding:2px 10px;border-radius:20px;margin-bottom:12px;letter-spacing:1px;"></div>
                    <div style="position:relative;width:100%;height:220px;background:rgba(0,0,0,0.2);border-radius:8px;">
                        <canvas id="progressChart" style="position:absolute;top:0;left:0;width:100%!important;height:100%!important;"></canvas>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;">
                    <div style="background:var(--steel);border-radius:12px;padding:14px 10px;text-align:center;border:1px solid #2a2a2a;">
                        <div style="font-family:'Oswald',sans-serif;font-size:10px;color:#555;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Current PR</div>
                        <div id="currentPR" style="font-family:'Bebas Neue',cursive;font-size:26px;color:var(--primary);line-height:1;">—</div>
                    </div>
                    <div style="background:var(--steel);border-radius:12px;padding:14px 10px;text-align:center;border:1px solid #2a2a2a;">
                        <div style="font-family:'Oswald',sans-serif;font-size:10px;color:#555;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Total Increase</div>
                        <div id="totalIncrease" style="font-family:'Bebas Neue',cursive;font-size:26px;color:var(--primary);line-height:1;">—</div>
                    </div>
                    <div style="background:var(--steel);border-radius:12px;padding:14px 10px;text-align:center;border:1px solid #2a2a2a;">
                        <div style="font-family:'Oswald',sans-serif;font-size:10px;color:#555;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Sessions</div>
                        <div id="sessionsLogged" style="font-family:'Bebas Neue',cursive;font-size:26px;color:var(--primary);line-height:1;">—</div>
                    </div>
                </div>
                <div style="background:var(--steel);border-radius:12px;overflow:hidden;border:1px solid #2a2a2a;margin-bottom:160px;">
                    <div style="padding:12px 16px;border-bottom:1px solid #2a2a2a;font-family:'Bebas Neue',cursive;font-size:18px;letter-spacing:1.5px;color:#fff;">Exercise History</div>
                    <div style="-webkit-overflow-scrolling:touch;">
                        <table class="history-table" style="width:100%;">
                            <thead style="position:sticky;top:0;z-index:1;background:var(--steel);"><tr><th>Date</th><th>Weight</th><th>Sets × Reps</th><th>Volume</th><th>Trend</th></tr></thead>
                            <tbody id="historyTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Empty state -->
            <div id="progressEmptyState" style="display:none;text-align:center;padding:50px 20px;">
                <div style="font-size:48px;margin-bottom:14px;">📊</div>
                <div style="font-family:'Bebas Neue',cursive;font-size:26px;color:var(--primary);margin-bottom:8px;">No Lifts Tracked Yet</div>
                <p style="font-family:'Oswald',sans-serif;font-size:14px;color:#555;">Log workouts with weights and they'll appear here</p>
            </div>

        </div>
        <!-- End Progress Page -->

        <!-- My Groups Page -->
        <div class="groups-page">
            <div class="groups-header">
                <div>
                    <h1 class="progress-title">My Groups</h1>
                    <p class="progress-subtitle">Train together, achieve together</p>
                </div>
                <button class="create-group-btn" onclick="openCreateGroupModal()">+ Create Group</button>
            </div>

            <!-- Dynamic groups grid — rendered by JS -->
            <div class="groups-grid" id="groupsGrid">
                <div id="groupsEmptyState" style="grid-column:1/-1;text-align:center;padding:80px 20px;color:#999;">
                    <div style="font-size:56px;margin-bottom:16px;">👥</div>
                    <h3 style="font-family:'Bebas Neue',cursive;font-size:32px;color:var(--primary);margin-bottom:10px;">No Groups Yet</h3>
                    <p style="font-size:15px;margin-bottom:24px;">Create a group or ask a friend to invite you</p>
                    <button onclick="openCreateGroupModal()" style="background:var(--primary);color:#fff;border:none;padding:14px 36px;font-family:'Oswald',sans-serif;font-size:16px;font-weight:600;letter-spacing:2px;text-transform:uppercase;cursor:pointer;">+ Create Group</button>
                </div>
            </div>

            <!-- Group Detail View — rendered by JS -->
            <div class="group-detail" id="groupDetail">
                <div class="group-detail-header" id="groupDetailHeader">
                    <button class="back-to-groups" onclick="closeGroup()">← Back to Groups</button>
                    <h2 class="group-detail-title" id="groupDetailTitle">Group</h2>
                    <div class="group-detail-info" id="groupDetailInfo"></div>
                </div>
                <div class="group-workout-feed" id="groupWorkoutFeed"></div>
            </div>
        </div>
        <!-- End My Groups Page -->

        <!-- Profile Page -->
        <div class="profile-page">
            <div class="profile-header">
                <div class="profile-top">
                    <div class="profile-avatar-large" id="profileAvatarWrap" style="position:relative;overflow:hidden;cursor:pointer;" onclick="openEditProfileModal()">
                        <img id="profileAvatarImg" src="" alt="" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;border-radius:50%;">
                        <span id="profileInitials">MK</span>
                        <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.55);text-align:center;padding:5px 0;font-size:10px;letter-spacing:1px;color:#fff;font-family:'Oswald',sans-serif;">EDIT</div>
                    </div>
                    <div class="profile-info">
                        <h1 class="profile-name" id="profileName">Marcus King</h1>
                        <div class="profile-username" id="profileUsername">@marcusking</div>
                        <p class="profile-bio" id="profileBio">Powerlifter | 5 AM Grind | Chasing 500lb deadlift 💪</p>
                        <div class="profile-stats-row">
                            <div class="profile-stat-item">
                                <div class="profile-stat-number" id="profileWorkoutCount">0</div>
                                <div class="profile-stat-label">Workouts</div>
                            </div>
                            <div class="profile-stat-item">
                                <div class="profile-stat-number" id="profileFollowers">0</div>
                                <div class="profile-stat-label">Followers</div>
                            </div>
                            <div class="profile-stat-item">
                                <div class="profile-stat-number" id="profileFollowing">0</div>
                                <div class="profile-stat-label">Following</div>
                            </div>
                        </div>
                        <div class="profile-actions">
                            <button class="edit-profile-btn" onclick="openEditProfileModal()">Edit Profile</button>
                            <button class="logout-btn" onclick="logout()">Logout</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="profile-tabs">
                <button class="profile-tab active" onclick="switchProfileTab('workouts')">Workouts</button>
                <button class="profile-tab" onclick="switchProfileTab('achievements')">Achievements</button>
                <button class="profile-tab" onclick="switchProfileTab('stats')">Stats</button>
            </div>

            <div class="profile-content">
                <!-- Workouts Tab -->
                <div class="profile-tab-content active" id="workouts-tab">
                    <div id="profileWorkoutFeed" class="activity-feed"></div>
                </div>

                <!-- Achievements Tab -->
                <div class="profile-tab-content" id="achievements-tab">
                    <div class="profile-achievements" id="achievementsGrid"></div>
                </div>

                <!-- Stats Tab -->
                <div class="profile-tab-content" id="stats-tab">
                    <div class="chart-container">
                        <h2 class="chart-title">My Workout Stats</h2>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-box-label">Total Workouts</div>
                                <div class="stat-box-value" id="statTotalWorkouts">0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-box-label">Total Exercises</div>
                                <div class="stat-box-value" id="statTotalExercises">0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-box-label">Total Minutes</div>
                                <div class="stat-box-value" id="statTotalMinutes">0</div>
                            </div>
                        </div>
                        <div id="recentWorkoutsList" style="margin-top:30px;"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Profile Page -->

    </main>

    <!-- Bottom Navigation -->
    <nav>
        <a href="#" class="nav-link active" data-page="feed">
            <svg viewBox="0 0 24 24" fill="currentColor" stroke="none" width="24" height="24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span>Feed</span>
        </a>
        <a href="#" class="nav-link" data-page="progress">
            <svg viewBox="0 0 24 24" fill="currentColor" stroke="none" width="24" height="24"><path d="M5 12h2v9H5zm4-5h2v14H9zm4-4h2v18h-2zm4 9h2v9h-2z"/></svg>
            <span>Progress</span>
        </a>
        <div class="log-btn-container">
            <button class="log-btn" onclick="openActionPicker()">
                <span>+</span>
            </button>
        </div>

        <!-- Action Picker Sheet -->
        <div id="actionPicker" style="display:none;position:fixed;bottom:0;left:0;right:0;z-index:1999;background:rgba(0,0,0,0.7);" onclick="if(event.target===this)closeActionPicker()">
            <div style="background:var(--iron);border-top:2px solid var(--primary);padding:24px 20px calc(24px + env(safe-area-inset-bottom));animation:slideUp 0.3s ease-out;">
                <div style="font-family:'Bebas Neue',cursive;font-size:22px;letter-spacing:2px;color:var(--primary);margin-bottom:18px;text-align:center;">What are you logging?</div>
                <div style="display:flex;flex-direction:column;gap:12px;">
                    <button onclick="closeActionPicker();openModal();" style="background:var(--steel);border:2px solid #444;color:var(--white);padding:18px 24px;font-family:'Oswald',sans-serif;font-size:17px;font-weight:600;letter-spacing:1px;text-transform:uppercase;cursor:pointer;text-align:left;display:flex;align-items:center;gap:14px;transition:border-color 0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='#444'">
                        <svg viewBox="0 0 24 24" fill="var(--primary)" width="26" height="26"><path d="M20 6h-2.18c.07-.44.18-.88.18-1.35C18 2.53 15.48 1 13.35 1c-1.3 0-2.67.52-3.54 1.39L9 3.2 8.19 2.39C7.32 1.52 5.95 1 4.65 1 2.52 1 0 2.53 0 4.65c0 .47.1.91.18 1.35H0v2h24v-2h-.18zm-11.78 0c-.02-.07-.22-.73-.22-1.35C8 3.43 9.43 3 10.65 3c.58 0 1.35.23 1.82.7L13.8 5H8.22zM16 3c1.22 0 2.65.43 2.65 1.65 0 .62-.2 1.28-.22 1.35H11l1.33-1.3C12.8 4.23 13.57 3 14.15 3zM0 20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2v-1H0v1zm0-8h24v5H0z"/></svg>
                        <div>
                            <div>Personal Workout</div>
                            <div style="font-size:12px;color:#999;font-weight:400;text-transform:none;letter-spacing:0;margin-top:2px;">Log a workout for yourself</div>
                        </div>
                    </button>
                    <button onclick="closeActionPicker();openGroupWorkoutModal();" style="background:var(--steel);border:2px solid #444;color:var(--white);padding:18px 24px;font-family:'Oswald',sans-serif;font-size:17px;font-weight:600;letter-spacing:1px;text-transform:uppercase;cursor:pointer;text-align:left;display:flex;align-items:center;gap:14px;transition:border-color 0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='#444'">
                        <svg viewBox="0 0 24 24" fill="var(--primary)" width="26" height="26"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                        <div>
                            <div>Group Workout</div>
                            <div style="font-size:12px;color:#999;font-weight:400;text-transform:none;letter-spacing:0;margin-top:2px;">Post a workout challenge to a group</div>
                        </div>
                    </button>
                </div>
                <button onclick="closeActionPicker()" style="background:transparent;border:none;color:#666;font-family:'Oswald',sans-serif;font-size:14px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;width:100%;margin-top:16px;padding:10px;">Cancel</button>
            </div>
        </div>
        <a href="#" class="nav-link" data-page="groups">
            <svg viewBox="0 0 24 24" fill="currentColor" stroke="none" width="24" height="24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
            <span>Groups</span>
        </a>
        <a href="#" class="nav-link" data-page="profile">
            <svg viewBox="0 0 24 24" fill="currentColor" stroke="none" width="24" height="24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span>Profile</span>
        </a>
    </nav>

    <!-- Log Workout Modal -->
    <div class="modal" id="workoutModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">×</button>

            <!-- Step indicator -->
            <div style="display:flex;align-items:center;gap:0;margin-bottom:28px;">
                <div id="stepDot1" style="width:32px;height:32px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:16px;flex-shrink:0;">1</div>
                <div id="stepLine" style="flex:1;height:3px;background:var(--primary);opacity:0.25;margin:0 8px;transition:opacity 0.3s;"></div>
                <div id="stepDot2" style="width:32px;height:32px;border-radius:50%;background:#333;border:2px solid #444;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:16px;color:#666;flex-shrink:0;transition:all 0.3s;">2</div>
                <div style="margin-left:14px;font-family:'Bebas Neue',cursive;font-size:18px;letter-spacing:2px;color:var(--primary);" id="stepLabel">EXERCISES</div>
            </div>

            <!-- ── STEP 1: Name, Type, Exercises ── -->
            <div id="logStep1">
                <h2 style="margin-bottom:24px;">Log Workout</h2>

                <div class="form-group">
                    <label>Workout Name</label>
                    <input id="workoutName" type="text" placeholder="e.g., PUSH DAY — CHEST & TRIS">
                </div>

                <div class="form-group">
                    <label>Workout Type</label>
                    <select id="workoutType">
                        <option value="">Select type</option>
                        <option value="push">Push (Chest, Shoulders, Triceps)</option>
                        <option value="pull">Pull (Back, Biceps)</option>
                        <option value="legs">Legs</option>
                        <option value="upper">Upper Body</option>
                        <option value="lower">Lower Body</option>
                        <option value="full">Full Body</option>
                        <option value="cardio">Cardio</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Duration (minutes)</label>
                    <input id="workoutDuration" type="number" placeholder="60" min="1">
                </div>

                <div class="form-group">
                    <label>Exercises</label>
                    <div id="exerciseContainer"></div>
                    <button type="button" class="add-exercise-btn" onclick="addExercise()" style="width:100%;margin-top:8px;">+ Add Exercise</button>
                </div>

                <button type="button" class="submit-btn" onclick="goToStep2()" style="margin-top:8px;">
                    Continue →
                </button>
            </div>

            <!-- ── STEP 2: Photo, Caption, Post to Group ── -->
            <div id="logStep2" style="display:none;">
                <h2 style="margin-bottom:24px;">Share It</h2>

                <div class="form-group">
                    <label>Add Photo (Optional)</label>
                    <div class="photo-upload-zone" id="photoZone" onclick="document.getElementById('photoInput').click()">
                        <div class="upload-icon">📸</div>
                        <div class="upload-text">Tap to add a workout photo</div>
                        <img id="previewImage" class="preview-image" alt="Workout preview">
                        <button type="button" class="remove-photo" id="removePhoto">×</button>
                    </div>
                    <input type="file" id="photoInput" accept="image/*">
                </div>

                <div class="form-group">
                    <label>Caption (Optional)</label>
                    <textarea id="captionInput" rows="2" placeholder="Feeling strong today! 💪"></textarea>
                </div>

                <div class="form-group">
                    <label>Also Post to a Group? (Optional)</label>
                    <select id="postToGroupSelect" style="width:100%;padding:15px;background:var(--iron);border:2px solid #333;color:var(--white);font-family:'Oswald',sans-serif;font-size:16px;">
                        <option value="">— No, just my feed —</option>
                    </select>
                </div>

                <div style="display:flex;gap:12px;margin-top:8px;">
                    <button type="button" onclick="goToStep1()" style="background:transparent;border:2px solid #444;color:#999;padding:16px 20px;font-family:'Oswald',sans-serif;font-size:14px;font-weight:600;letter-spacing:1px;text-transform:uppercase;cursor:pointer;flex-shrink:0;">← Back</button>
                    <button type="button" class="submit-btn" onclick="handleLogWorkout()" style="margin-top:0;flex:1;">Post Workout 🔥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Workout Detail Modal (bottom sheet) -->
    <div id="workoutDetailModal" onclick="if(event.target===this)closeWorkoutDetail()">
        <div class="detail-sheet">
            <div class="detail-drag-handle"></div>
            <div class="detail-header">
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <div>
                        <div class="detail-workout-name" id="detailWorkoutName"></div>
                        <div class="detail-meta" id="detailWorkoutMeta"></div>
                    </div>
                    <button onclick="closeWorkoutDetail()" style="background:transparent;border:none;color:#555;font-size:24px;cursor:pointer;padding:0 4px;line-height:1;">×</button>
                </div>
            </div>
            <div class="detail-section-label" id="detailChartLabel">Exercise Breakdown</div>
            <div class="detail-chart-wrap" id="detailChartWrap">
                <canvas id="detailBarChart" style="width:100%;height:190px;"></canvas>
            </div>
            <div class="detail-section-label">Sets & Reps</div>
            <table class="detail-ex-table" id="detailExTable">
                <thead><tr><th>Exercise</th><th>Sets</th><th>Reps</th><th>Weight</th><th>Vol</th></tr></thead>
                <tbody id="detailExBody"></tbody>
            </table>
            <!-- Likes row -->
            <div style="display:flex;align-items:center;gap:20px;padding:14px 20px;border-top:1px solid #1e1e1e;">
                <button id="detailLikeBtn" onclick="toggleDetailLike()" style="background:transparent;border:none;cursor:pointer;display:flex;align-items:center;gap:7px;font-family:'Oswald',sans-serif;font-size:14px;font-weight:600;color:#666;letter-spacing:1px;padding:0;transition:color 0.2s;">
                    <span id="detailLikeIcon" style="font-size:18px;">👊</span>
                    <span id="detailLikeCount">0 Respect</span>
                </button>
            </div>
            <!-- Comments -->
            <div class="detail-section-label" style="margin-top:4px;">Comments</div>
            <div id="detailCommentsList" style="min-height:40px;"></div>
            <!-- Sticky comment input -->
            <div class="detail-comment-input-wrap">
                <div id="detailCommentAvatar" class="detail-comment-avatar" style="width:30px;height:30px;font-size:12px;"></div>
                <input class="detail-comment-input" id="detailCommentInput" type="text" placeholder="Add a comment…" maxlength="200"
                    onkeydown="if(event.key==='Enter')submitDetailComment()">
                <button class="detail-comment-send" onclick="submitDetailComment()">↑</button>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div class="modal" id="createGroupModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeCreateGroupModal()">×</button>
            <h2>Create Group</h2>
            <form id="createGroupForm">
                <div class="form-group">
                    <label>Group Name</label>
                    <input id="cgName" type="text" placeholder="e.g., Morning Grind Crew">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="cgDesc" rows="3" placeholder="What's this group about? 💪"></textarea>
                </div>
                <button type="button" class="submit-btn" onclick="handleCreateGroup()">Create Group</button>
            </form>
        </div>
    </div>

    <!-- Completion Sheet (bottom sheet) -->
    <div id="completionSheet" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:1999;background:rgba(0,0,0,0.75);" onclick="if(event.target===this)closeCompletionSheet()">
        <div style="position:absolute;bottom:0;left:0;right:0;background:var(--iron);border-top:2px solid var(--primary);padding:28px 24px calc(28px + env(safe-area-inset-bottom));animation:slideUp 0.3s ease-out;max-height:90vh;overflow-y:auto;">
            <div style="font-family:'Bebas Neue',cursive;font-size:26px;letter-spacing:2px;color:var(--primary);margin-bottom:6px;">Workout Complete! 💪</div>
            <div style="color:#999;font-size:13px;letter-spacing:1px;margin-bottom:22px;">Optionally share a photo and comment with the group</div>

            <!-- Photo upload -->
            <div id="csPhotoZone" onclick="document.getElementById('csPhotoInput').click()" style="border:2px dashed rgba(255,107,53,0.35);padding:24px;text-align:center;background:rgba(255,107,53,0.04);cursor:pointer;border-radius:4px;margin-bottom:16px;position:relative;transition:border-color 0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='rgba(255,107,53,0.35)'">
                <div id="csUploadPlaceholder">
                    <div style="font-size:36px;margin-bottom:6px;">📸</div>
                    <div style="color:#999;font-size:13px;text-transform:uppercase;letter-spacing:1px;">Tap to add a photo</div>
                </div>
                <img id="csPhotoPreview" src="" alt="" style="display:none;width:100%;max-height:280px;object-fit:cover;border-radius:4px;">
                <button type="button" id="csRemovePhoto" onclick="event.stopPropagation();clearCompletionPhoto()" style="display:none;position:absolute;top:8px;right:8px;background:var(--primary);color:#fff;border:none;width:30px;height:30px;border-radius:50%;font-size:16px;cursor:pointer;line-height:30px;text-align:center;">×</button>
            </div>
            <input type="file" id="csPhotoInput" accept="image/*" style="display:none;">

            <!-- Comment -->
            <textarea id="csComment" rows="3" placeholder="Leave a comment for the group... (optional)" style="width:100%;padding:14px;background:var(--steel);border:2px solid #333;color:var(--white);font-family:'Oswald',sans-serif;font-size:15px;resize:none;margin-bottom:16px;border-radius:0;" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#333'"></textarea>

            <div style="display:flex;gap:12px;">
                <button onclick="submitCompletion()" style="flex:1;background:var(--primary);color:#fff;border:none;padding:16px;font-family:'Oswald',sans-serif;font-size:16px;font-weight:600;letter-spacing:2px;text-transform:uppercase;cursor:pointer;">Post Completion</button>
                <button onclick="closeCompletionSheet()" style="background:transparent;border:2px solid #444;color:#999;padding:16px 20px;font-family:'Oswald',sans-serif;font-size:14px;font-weight:600;letter-spacing:1px;text-transform:uppercase;cursor:pointer;">Skip</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeEditProfileModal()">×</button>
            <h2>Edit Profile</h2>
            <form id="editProfileForm">

                <!-- Avatar Upload -->
                <div class="form-group" style="text-align:center;">
                    <label>Profile Photo</label>
                    <div id="epAvatarWrap" onclick="document.getElementById('epAvatarInput').click()" style="width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;margin:0 auto 12px;cursor:pointer;position:relative;overflow:hidden;border:3px solid var(--primary);">
                        <img id="epAvatarPreview" src="" alt="" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;border-radius:50%;">
                        <span id="epAvatarInitials" style="font-family:'Bebas Neue',cursive;font-size:36px;">??</span>
                        <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.6);text-align:center;padding:5px 0;font-size:10px;letter-spacing:1px;color:#fff;font-family:'Oswald',sans-serif;">CHANGE</div>
                    </div>
                    <input type="file" id="epAvatarInput" accept="image/*" style="display:none;">
                    <p style="font-size:12px;color:#666;letter-spacing:1px;">Click photo to change</p>
                </div>

                <div class="form-group">
                    <label>Full Name</label>
                    <input id="epName" type="text" placeholder="Your full name">
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input id="epUsername" type="text" placeholder="username">
                </div>
                <div class="form-group">
                    <label>Bio</label>
                    <textarea id="epBio" rows="3" placeholder="Tell the world what you lift for 💪"></textarea>
                </div>
                <button type="button" class="submit-btn" onclick="handleSaveProfile()">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Group Workout Modal -->
    <div class="modal" id="groupWorkoutModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeGroupWorkoutModal()">×</button>
            <h2 style="color:var(--primary);">Post Group Workout</h2>
            <form id="groupWorkoutForm">
                <div class="form-group">
                    <label>Workout Name</label>
                    <input id="gwName" type="text" placeholder="e.g., MONDAY PUSH DAY CHALLENGE" required>
                </div>

                <div class="form-group">
                    <label>Post To Group</label>
                    <select id="gwGroupSelect" required style="width:100%;padding:15px;background:var(--iron);border:2px solid #333;color:var(--white);font-family:'Oswald',sans-serif;font-size:16px;">
                        <option value="">— Select a group —</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Description / Instructions</label>
                    <textarea id="gwDescription" rows="3" placeholder="Tell your group what to do and how to crush it! 💪"></textarea>
                </div>

                <div class="form-group">
                    <label>Add Photo (Optional)</label>
                    <div class="photo-upload-zone" id="gwPhotoZone" onclick="document.getElementById('gwPhotoInput').click()">
                        <div class="upload-icon">📸</div>
                        <div class="upload-text">Click to upload workout photo</div>
                        <img id="gwPreviewImage" class="preview-image" alt="Workout preview">
                        <button type="button" class="remove-photo" id="gwRemovePhoto">×</button>
                    </div>
                    <input type="file" id="gwPhotoInput" accept="image/*" style="display:none;">
                </div>

                <div class="form-group">
                    <label>Exercises</label>
                    <div id="gwExerciseContainer">
                        <div class="exercise-inputs">
                            <input type="text" placeholder="Exercise name">
                            <input type="number" placeholder="Sets">
                            <input type="number" placeholder="Reps">
                            <input type="number" placeholder="Weight (lbs)">
                        </div>
                    </div>
                    <button type="button" class="add-exercise-btn" onclick="addGroupExercise()">+ Add Exercise</button>
                </div>

                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="gwNotes" rows="2" placeholder="Any tips, targets, or motivation..."></textarea>
                </div>

                <button type="button" class="submit-btn" onclick="handlePostGroupWorkout()">Post to Group</button>
            </form>
        </div>
    </div>

    <!-- Signup Page -->
    <div class="auth-page" id="signupPage">
        <div class="auth-container">
            <div class="auth-logo">
                <div class="auth-logo-text">SPLITSHARE</div>
                <div class="auth-tagline">Track Your Strength</div>
            </div>
            <div class="auth-form">
                <h2 class="auth-title">Create Account</h2>
                <div class="auth-error" id="signupError" style="display:none; color:#ff6b35; font-size:14px; margin-bottom:15px; padding:10px; background:rgba(255,107,53,0.1); border-left:3px solid #ff6b35;"></div>
                <form id="signupForm" onsubmit="return false;">
                    <div class="auth-input-group">
                        <label>Full Name</label>
                        <input id="signupName" type="text" placeholder="Marcus King">
                    </div>
                    <div class="auth-input-group">
                        <label>Username</label>
                        <input id="signupUsername" type="text" placeholder="marcusking">
                    </div>
                    <div class="auth-input-group">
                        <label>Email</label>
                        <input id="signupEmail" type="email" placeholder="marcus@example.com">
                    </div>
                    <div class="auth-input-group">
                        <label>Password</label>
                        <input id="signupPassword" type="password" placeholder="Min. 6 characters">
                    </div>
                    <button type="button" class="auth-submit-btn" onclick="handleSignup()">Create Account</button>
                </form>
                <div class="auth-switch">
                    Already have an account? <span class="auth-switch-link" onclick="showLogin()">Log in</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div class="auth-page" id="loginPage">
        <div class="auth-container">
            <div class="auth-logo">
                <div class="auth-logo-text">SPLITSHARE</div>
                <div class="auth-tagline">Track Your Strength</div>
            </div>
            <div class="auth-form">
                <h2 class="auth-title">Welcome Back</h2>
                <div class="auth-error" id="loginError" style="display:none; color:#ff6b35; font-size:14px; margin-bottom:15px; padding:10px; background:rgba(255,107,53,0.1); border-left:3px solid #ff6b35;"></div>
                <form id="loginForm" onsubmit="return false;">
                    <div class="auth-input-group">
                        <label>Email Address</label>
                        <input id="loginIdentifier" type="email" placeholder="marcus@example.com">
                    </div>
                    <div class="auth-input-group">
                        <label>Password</label>
                        <input id="loginPassword" type="password" placeholder="••••••••">
                    </div>
                    <button type="button" class="auth-submit-btn" onclick="handleLogin()">Log In</button>
                </form>
                <div class="auth-switch">
                    Don't have an account? <span class="auth-switch-link" onclick="showSignup()">Sign up</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Navigation System
        const navLinks = document.querySelectorAll('.nav-link');
        const feedPage = document.querySelector('.feed-page');
        const progressPage = document.querySelector('.progress-page');
        const groupsPage = document.querySelector('.groups-page');
        const profilePage = document.querySelector('.profile-page');

        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = this.dataset.page;
                
                // Update active nav link
                navLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                // Hide all pages
                if (feedPage) feedPage.classList.remove('active');
                if (progressPage) progressPage.classList.remove('active');
                if (groupsPage) groupsPage.classList.remove('active');
                if (profilePage) profilePage.classList.remove('active');
                
                // Show selected page
                if (page === 'feed' && feedPage) {
                    feedPage.classList.add('active');
                } else if (page === 'progress' && progressPage) {
                    progressPage.classList.add('active');
                    setTimeout(() => { loadProgressPage(); }, 100);
                } else if (page === 'groups' && groupsPage) {
                    groupsPage.classList.add('active');
                    closeGroup();
                    loadUserGroups();
                } else if (page === 'profile' && profilePage) {
                    profilePage.classList.add('active');
                }
            });
        });

        // Groups functionality
        // ── GROUPS ───────────────────────────────────────────────────────────
        window._userGroups   = [];   // [{id, name, description, created_at, member_count, workout_count}]
        window._currentGroup = null; // currently open group object
        window._completionTargetBtn = null; // the Mark Complete button being acted on

        async function loadUserGroups() {
            const grid = document.getElementById('groupsGrid');
            const empty = document.getElementById('groupsEmptyState');
            if (!grid) return;
            try {
                const groups = await sb(`groups?order=created_at.desc&select=*`);
                window._userGroups = groups || [];
                renderGroupsGrid();
            } catch(e) {
                console.warn('Failed to load groups:', e.message);
                renderGroupsGrid();
            }
        }

        function renderGroupsGrid() {
            const grid  = document.getElementById('groupsGrid');
            const empty = document.getElementById('groupsEmptyState');
            if (!grid) return;
            // Remove old cards (keep empty state node)
            Array.from(grid.children).forEach(c => { if (c.id !== 'groupsEmptyState') c.remove(); });
            const groups = window._userGroups;
            if (!groups || groups.length === 0) {
                if (empty) empty.style.display = 'block';
                return;
            }
            if (empty) empty.style.display = 'none';
            groups.forEach(g => {
                const card = document.createElement('div');
                card.className = 'group-card';
                card.onclick = () => openGroup(g.id);
                card.innerHTML = `
                    <div class="group-header-banner">
                        <h3 class="group-name">${g.name}</h3>
                        <div class="group-members-count">👥 ${g.member_count || 1} member${(g.member_count||1)===1?'':'s'}</div>
                    </div>
                    <div class="group-body">
                        <p class="group-description">${g.description || ''}</p>
                        <div class="group-stats">
                            <div class="group-stat"><div class="group-stat-value">${g.workout_count || 0}</div><div class="group-stat-label">Workouts</div></div>
                            <div class="group-stat"><div class="group-stat-value">${g.member_count || 1}</div><div class="group-stat-label">Members</div></div>
                        </div>
                        <button class="view-group-btn">View Group</button>
                    </div>`;
                grid.appendChild(card);
            });
        }

        async function openGroup(groupId) {
            const groupsGrid   = document.getElementById('groupsGrid');
            const groupsHeader = document.querySelector('.groups-header');
            const groupDetail  = document.getElementById('groupDetail');
            if (groupsGrid)   groupsGrid.style.display   = 'none';
            if (groupsHeader) groupsHeader.style.display = 'none';
            if (groupDetail)  groupDetail.classList.add('active');

            const g = window._userGroups.find(x => x.id === groupId) || { id: groupId, name: 'Group' };
            window._currentGroup = g;

            const titleEl = document.getElementById('groupDetailTitle');
            const infoEl  = document.getElementById('groupDetailInfo');
            if (titleEl) titleEl.textContent = g.name;
            if (infoEl)  infoEl.innerHTML = `
                <span>👥 ${g.member_count || 1} member${(g.member_count||1)===1?'':'s'}</span>
                <span>📅 Created ${g.created_at ? new Date(g.created_at).toLocaleDateString('en-US',{month:'short',year:'numeric'}) : 'Recently'}</span>`;

            await loadGroupWorkouts(groupId);
        }

        function closeGroup() {
            const groupsGrid   = document.getElementById('groupsGrid');
            const groupsHeader = document.querySelector('.groups-header');
            const groupDetail  = document.getElementById('groupDetail');
            if (groupsGrid)   groupsGrid.style.display   = 'grid';
            if (groupsHeader) groupsHeader.style.display = 'flex';
            if (groupDetail)  groupDetail.classList.remove('active');
            window._currentGroup = null;
        }

        async function loadGroupWorkouts(groupId) {
            const feed = document.getElementById('groupWorkoutFeed');
            if (!feed) return;
            feed.innerHTML = `<div style="text-align:center;padding:40px;color:#666;font-family:'Oswald',sans-serif;font-size:15px;letter-spacing:1px;">Loading workouts...</div>`;
            try {
                const workouts = await sb(`group_workouts?group_id=eq.${groupId}&order=created_at.desc&select=*,profiles(full_name,initials)`);
                renderGroupWorkouts(feed, workouts || [], groupId);
            } catch(e) {
                renderGroupWorkouts(feed, [], groupId);
            }
        }

        function renderGroupWorkouts(feed, workouts, groupId) {
            if (!feed) return;
            if (workouts.length === 0) {
                feed.innerHTML = `
                    <div style="text-align:center;padding:80px 20px;color:#999;">
                        <div style="font-size:48px;margin-bottom:16px;">🏋️</div>
                        <h3 style="font-family:'Bebas Neue',cursive;font-size:28px;color:var(--primary);margin-bottom:10px;">No Workouts Yet</h3>
                        <p>Hit the + button and post a Group Workout to get started!</p>
                    </div>`;
                return;
            }
            feed.innerHTML = '';
            workouts.forEach(w => {
                const poster = w.profiles?.full_name || 'Someone';
                const initials = w.profiles?.initials || poster.slice(0,2).toUpperCase();
                const exHTML = (w.exercises||[]).map(ex =>
                    `<div class="exercise-item"><span class="exercise-name">${ex.name}</span><span class="exercise-details">${ex.sets||'?'} × ${ex.reps||'?'}${ex.weight?' @ '+ex.weight+' lbs':''}</span></div>`
                ).join('') || '';
                const photoHTML = w.photo_url ? `<div style="width:100%;padding-bottom:56%;position:relative;overflow:hidden;"><img src="${w.photo_url}" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;"></div>` : '';
                const descHTML = w.description ? `<p class="workout-challenge-description">${w.description}</p>` : '';

                const card = document.createElement('div');
                card.className = 'group-workout-card';
                card.dataset.workoutId = w.id;
                card.innerHTML = `
                    <div class="workout-posted-by">
                        <div class="posted-by-label">Posted by</div>
                        <div class="posted-by-name">${poster}</div>
                    </div>
                    ${photoHTML}
                    <h3 class="workout-challenge-title">${w.name.toUpperCase()}</h3>
                    ${descHTML}
                    ${exHTML ? `<div class="workout-challenge-exercises"><div class="exercise-list">${exHTML}</div></div>` : ''}
                    <div class="completions-section">
                        <div class="completions-header">
                            <div class="completions-title" id="compTitle-${w.id}">Completions (0)</div>
                            <button class="complete-workout-btn" onclick="promptCompletion(this,'${w.id}')">✓ Mark Complete</button>
                        </div>
                        <div class="completions-list" id="compList-${w.id}" style="display:flex;flex-direction:column;gap:0;"></div>
                    </div>`;
                feed.appendChild(card);
                loadCompletions(w.id);
            });
        }

        async function loadCompletions(workoutId) {
            try {
                const completions = await sb(`group_completions?workout_id=eq.${workoutId}&order=created_at.asc&select=*,profiles(full_name,initials,avatar_url)`);
                renderCompletions(workoutId, completions || []);
            } catch(e) { console.warn('Completions load error:', e.message); }
        }

        function renderCompletions(workoutId, completions) {
            const list  = document.getElementById(`compList-${workoutId}`);
            const title = document.getElementById(`compTitle-${workoutId}`);
            if (!list) return;
            if (title) title.textContent = `Completions (${completions.length})`;
            list.innerHTML = '';
            completions.forEach(c => {
                const name = c.profiles?.full_name || 'Someone';
                const initials = c.profiles?.initials || name.slice(0,2).toUpperCase();
                const avatarUrl = c.profiles?.avatar_url || '';
                const timeStr = c.created_at ? timeAgo(new Date(c.created_at)) : 'Just now';
                const avatarHTML = avatarUrl
                    ? `<img src="${avatarUrl}" style="width:42px;height:42px;border-radius:50%;object-fit:cover;border:2px solid var(--primary);flex-shrink:0;">`
                    : `<div style="width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:18px;flex-shrink:0;">${initials}</div>`;

                const item = document.createElement('div');
                item.style.cssText = 'border-top:1px solid #333;padding:16px 20px;';
                item.innerHTML = `
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:${c.comment||c.photo_url?'12':'0'}px;">
                        ${avatarHTML}
                        <div style="flex:1;">
                            <div style="font-size:15px;font-weight:600;letter-spacing:0.5px;">${name}</div>
                            <div style="font-size:12px;color:#666;font-family:'Roboto Mono',monospace;">${timeStr}</div>
                        </div>
                        <span style="color:#4ade80;font-size:18px;">✅</span>
                    </div>
                    ${c.photo_url ? `<img src="${c.photo_url}" style="width:100%;max-height:300px;object-fit:cover;border-radius:4px;margin-bottom:${c.comment?'10':'0'}px;">` : ''}
                    ${c.comment ? `<div style="background:var(--iron);padding:10px 14px;font-size:14px;color:#ddd;border-left:3px solid var(--primary);font-weight:400;">"${c.comment}"</div>` : ''}`;
                list.appendChild(item);
            });
        }

        // ── COMPLETION SHEET ─────────────────────────────────────────────────
        function promptCompletion(btn, workoutId) {
            if (btn.classList.contains('completed')) return; // already done
            window._completionTargetBtn = btn;
            window._completionWorkoutId = workoutId;
            // Clear previous state
            document.getElementById('csComment').value = '';
            clearCompletionPhoto();
            document.getElementById('completionSheet').style.display = 'block';
        }

        function closeCompletionSheet() {
            document.getElementById('completionSheet').style.display = 'none';
            window._completionTargetBtn = null;
            window._completionWorkoutId = null;
        }

        function clearCompletionPhoto() {
            const input   = document.getElementById('csPhotoInput');
            const preview = document.getElementById('csPhotoPreview');
            const remove  = document.getElementById('csRemovePhoto');
            const placeholder = document.getElementById('csUploadPlaceholder');
            if (input)   input.value = '';
            if (preview) { preview.src = ''; preview.style.display = 'none'; }
            if (remove)  remove.style.display = 'none';
            if (placeholder) placeholder.style.display = 'block';
        }

        // Wire up completion photo input
        (function() {
            const input   = document.getElementById('csPhotoInput');
            const preview = document.getElementById('csPhotoPreview');
            const remove  = document.getElementById('csRemovePhoto');
            const placeholder = document.getElementById('csUploadPlaceholder');
            if (!input) return;
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = ev => {
                    if (preview)     { preview.src = ev.target.result; preview.style.display = 'block'; }
                    if (remove)      remove.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                };
                reader.readAsDataURL(file);
            });
        })();

        async function submitCompletion() {
            const btn       = window._completionTargetBtn;
            const workoutId = window._completionWorkoutId;
            const comment   = document.getElementById('csComment')?.value.trim() || null;
            const preview   = document.getElementById('csPhotoPreview');
            const photoSrc  = (preview?.style.display !== 'none' && preview?.src && preview.src.startsWith('data:')) ? preview.src : null;
            const user      = getCurrentUser();

            if (!workoutId) { closeCompletionSheet(); return; }

            // Mark button as completed
            if (btn) { btn.classList.add('completed'); btn.textContent = '✅ Completed!'; btn.disabled = true; }

            closeCompletionSheet();

            // Save to Supabase
            if (user && window._sbUserId) {
                try {
                    await sb('group_completions', {
                        method: 'POST',
                        body: {
                            workout_id: workoutId,
                            user_id:    window._sbUserId,
                            comment:    comment || null,
                            photo_url:  photoSrc || null
                        }
                    });
                } catch(e) { console.warn('Completion save failed:', e.message); }
            }

            // Optimistically add completion to UI
            const name     = user ? (user.full_name || user.fullName || user.username) : 'You';
            const initials = user ? (user.initials || name.slice(0,2).toUpperCase()) : 'ME';
            const avatarUrl = user?.avatar_url || '';
            const list  = document.getElementById(`compList-${workoutId}`);
            const title = document.getElementById(`compTitle-${workoutId}`);
            if (list) {
                const avatarHTML = avatarUrl
                    ? `<img src="${avatarUrl}" style="width:42px;height:42px;border-radius:50%;object-fit:cover;border:2px solid var(--primary);flex-shrink:0;">`
                    : `<div style="width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:18px;flex-shrink:0;">${initials}</div>`;
                const item = document.createElement('div');
                item.style.cssText = 'border-top:1px solid #333;padding:16px 20px;animation:fadeInUp 0.4s ease-out;';
                item.innerHTML = `
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:${comment||photoSrc?'12':'0'}px;">
                        ${avatarHTML}
                        <div style="flex:1;">
                            <div style="font-size:15px;font-weight:600;letter-spacing:0.5px;">${name}</div>
                            <div style="font-size:12px;color:#666;font-family:'Roboto Mono',monospace;">Just now</div>
                        </div>
                        <span style="color:#4ade80;font-size:18px;">✅</span>
                    </div>
                    ${photoSrc ? `<img src="${photoSrc}" style="width:100%;max-height:300px;object-fit:cover;border-radius:4px;margin-bottom:${comment?'10':'0'}px;">` : ''}
                    ${comment ? `<div style="background:var(--iron);padding:10px 14px;font-size:14px;color:#ddd;border-left:3px solid var(--primary);">"${comment}"</div>` : ''}`;
                list.appendChild(item);
                // Update count
                const existing = list.children.length;
                if (title) title.textContent = `Completions (${existing})`;
            }
        }

        // ── CREATE GROUP ─────────────────────────────────────────────────────
        function openCreateGroupModal() {
            document.getElementById('cgName')?.focus && (document.getElementById('cgName').value = '');
            document.getElementById('cgDesc')?.focus && (document.getElementById('cgDesc').value = '');
            const modal = document.getElementById('createGroupModal');
            if (modal) modal.classList.add('active');
        }

        function closeCreateGroupModal() {
            const modal = document.getElementById('createGroupModal');
            if (modal) modal.classList.remove('active');
        }

        async function handleCreateGroup() {
            const name = document.getElementById('cgName')?.value.trim();
            const desc = document.getElementById('cgDesc')?.value.trim();
            if (!name) { alert('Please enter a group name.'); return; }
            const btn = document.querySelector('#createGroupForm .submit-btn');
            if (btn) { btn.textContent = 'Creating...'; btn.disabled = true; }
            try {
                const user = getCurrentUser();
                const created = await sb('groups', {
                    method: 'POST',
                    body: {
                        name,
                        description: desc || null,
                        created_by:  window._sbUserId || null,
                        member_count: 1,
                        workout_count: 0
                    }
                });
                const newGroup = created?.[0] || { id: Date.now().toString(), name, description: desc, member_count: 1, workout_count: 0, created_at: new Date().toISOString() };
                window._userGroups.unshift(newGroup);
                renderGroupsGrid();
                // Update group dropdowns in workout modals
                populateGroupDropdowns();
                closeCreateGroupModal();
                document.getElementById('cgName').value = '';
                document.getElementById('cgDesc').value = '';
            } catch(e) {
                alert('Failed to create group: ' + e.message);
            } finally {
                if (btn) { btn.textContent = 'Create Group'; btn.disabled = false; }
            }
        }

        function populateGroupDropdowns() {
            const sel = document.getElementById('gwGroupSelect');
            if (!sel) return;
            const groups = window._userGroups;
            sel.innerHTML = '<option value="">— Select a group —</option>' +
                groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
        }

        // Close create group modal on outside click
        document.getElementById('createGroupModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeCreateGroupModal();
        });

        // Exercise Data
        // ── PROGRESS PAGE ─────────────────────────────────────────────────────
        let progressExerciseData = {};

        function buildProgressFromWorkouts(workouts) {
            const map = {};
            workouts.forEach(w => {
                const rawDate = w.created_at || w.date || new Date().toISOString();
                const date = new Date(rawDate);
                (w.exercises || []).forEach(ex => {
                    const weight = parseFloat(ex.weight);
                    if (!ex.name || !weight || isNaN(weight)) return;
                    const key = ex.name.trim();
                    if (!map[key]) map[key] = [];
                    map[key].push({
                        date, dateLabel: date.toLocaleDateString('en-US',{month:'short',day:'numeric'}),
                        weight, sets: ex.sets||'?', reps: ex.reps||'?',
                        volume: weight*(parseInt(ex.sets)||1)*(parseInt(ex.reps)||1)
                    });
                });
            });
            Object.keys(map).forEach(k => map[k].sort((a,b) => a.date - b.date));
            return map;
        }

        async function loadProgressPage() {
            const user = getCurrentUser();
            if (!user) return;
            let workouts = user.workouts || [];
            if (window._sbUserId) {
                try {
                    const fresh = await sb(`workouts?user_id=eq.${window._sbUserId}&order=created_at.asc&select=*`);
                    if (fresh && fresh.length > 0) { workouts = fresh; user.workouts = fresh; setCurrentUser(user); }
                } catch(e) { console.warn('Progress fetch:', e.message); }
            }

            // Overview stats
            const totalWorkouts = workouts.length;
            const now = new Date();
            const weekStart = new Date(now); weekStart.setHours(0,0,0,0);
            weekStart.setDate(now.getDate() - ((now.getDay()+6)%7));
            const weekMins = workouts.filter(w => new Date(w.created_at||w.date) >= weekStart).reduce((s,w) => s+(parseInt(w.duration)||0), 0);

            // Streak
            const dayKeys = new Set(workouts.map(w => { const d=new Date(w.created_at||w.date); return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`; }));
            let streak=0; const check=new Date(); check.setHours(0,0,0,0);
            const todayKey=`${check.getFullYear()}-${check.getMonth()}-${check.getDate()}`;
            if (!dayKeys.has(todayKey)) check.setDate(check.getDate()-1);
            while(true){ const k=`${check.getFullYear()}-${check.getMonth()}-${check.getDate()}`; if(!dayKeys.has(k)) break; streak++; check.setDate(check.getDate()-1); }

            const g=id=>document.getElementById(id);
            if(g('pgTotalWorkouts')) g('pgTotalWorkouts').textContent=totalWorkouts;
            if(g('pgWeekMins'))      g('pgWeekMins').textContent=weekMins;
            if(g('pgStreak'))        g('pgStreak').textContent=streak;

            // Lift dropdown
            progressExerciseData = buildProgressFromWorkouts(workouts);
            const exercises = Object.keys(progressExerciseData).sort();
            const dropdown = g('liftDropdown');
            const emptyState = g('progressEmptyState');
            const liftDetail = g('liftDetailSection');

            if (exercises.length === 0) {
                if(emptyState) emptyState.style.display='block';
                if(liftDetail) liftDetail.style.display='none';
                return;
            }
            if(emptyState) emptyState.style.display='none';

            const prev = dropdown ? dropdown.value : '';
            if (dropdown) {
                dropdown.innerHTML = '<option value="">— Choose a lift —</option>' +
                    exercises.map(n=>`<option value="${n.replace(/"/g,'&quot;')}"${n===prev?' selected':''}>${n}</option>`).join('');
            }
            if (prev && exercises.includes(prev)) {
                if(liftDetail) liftDetail.style.display='block';
                requestAnimationFrame(() => requestAnimationFrame(() => renderProgressChart(prev)));
            }
        }

        function onLiftDropdownChange(val) {
            const liftDetail = document.getElementById('liftDetailSection');
            if (!val) { if(liftDetail) liftDetail.style.display='none'; return; }
            if(liftDetail) liftDetail.style.display='block';
            // Double rAF: first lets browser paint display:block, second lets Chart.js measure
            requestAnimationFrame(() => requestAnimationFrame(() => renderProgressChart(val)));
        }

        function renderProgressChart(exerciseName) {
            const entries = progressExerciseData[exerciseName];
            if (!entries || entries.length === 0) return;
            const pr   = Math.max(...entries.map(e => e.weight));
            const diff = pr - entries[0].weight;

            const g = id => document.getElementById(id);
            if (g('chartTitle'))     g('chartTitle').textContent     = exerciseName;
            if (g('chartPrBadge'))   g('chartPrBadge').textContent   = `PR: ${pr} lbs`;
            if (g('currentPR'))      g('currentPR').textContent      = pr + ' lbs';
            if (g('totalIncrease'))  g('totalIncrease').textContent  = (diff >= 0 ? '+' : '') + diff + ' lbs';
            if (g('sessionsLogged')) g('sessionsLogged').textContent = entries.length;

            // Destroy old chart
            if (window.progressChart) { window.progressChart.destroy(); window.progressChart = null; }

            const canvas = g('progressChart');
            if (!canvas) return;

            // Force canvas to fill parent div before Chart.js measures it
            const parent = canvas.parentElement;
            const pxW = parent ? parent.offsetWidth  : 300;
            const pxH = parent ? parent.offsetHeight : 220;
            canvas.width  = pxW;
            canvas.height = pxH;

            // Duplicate single point so line draws
            const labels = entries.length === 1
                ? [entries[0].dateLabel, entries[0].dateLabel]
                : entries.map(e => e.dateLabel);
            const data = entries.length === 1
                ? [entries[0].weight, entries[0].weight]
                : entries.map(e => e.weight);
            const pts   = (entries.length === 1 ? [entries[0], entries[0]] : entries).map(e => e.weight === pr ? '#ffb347' : '#ff6b35');
            const radii = (entries.length === 1 ? [entries[0], entries[0]] : entries).map(e => e.weight === pr ? 8 : 5);

            const ctx  = canvas.getContext('2d');
            const grad = ctx.createLinearGradient(0, 0, 0, pxH);
            grad.addColorStop(0, 'rgba(255,107,53,0.35)');
            grad.addColorStop(1, 'rgba(255,107,53,0.0)');

            window.progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        data,
                        borderColor: '#ff6b35',
                        backgroundColor: grad,
                        borderWidth: 2.5,
                        fill: true,
                        tension: 0.35,
                        pointRadius: radii,
                        pointBackgroundColor: pts,
                        pointBorderColor: '#1a1a1a',
                        pointBorderWidth: 2,
                        pointHoverRadius: 10,
                        pointHoverBackgroundColor: '#ffb347',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    animation: { duration: 600 },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1a1a1a',
                            titleColor: '#ff6b35',
                            bodyColor: '#eee',
                            borderColor: '#333',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: false,
                            titleFont: { family: 'Oswald', size: 13, weight: '600' },
                            bodyFont:  { family: 'Roboto Mono', size: 12 },
                            callbacks: {
                                title: items => labels[items[0].dataIndex],
                                label: c => `  ${c.parsed.y} lbs`,
                                afterLabel: c => {
                                    const idx = Math.min(c.dataIndex, entries.length - 1);
                                    const e = entries[idx];
                                    const vol = e.weight * (parseInt(e.sets)||1) * (parseInt(e.reps)||1);
                                    const lines = [`  ${e.sets} sets × ${e.reps} reps`, `  Vol: ${vol.toLocaleString()} lbs`];
                                    if (e.weight === pr) lines.push('  🏆 PR!');
                                    return lines;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255,255,255,0.06)' },
                            border: { color: 'rgba(255,255,255,0.08)', dash: [4,4] },
                            ticks: { color: '#666', font: { family: 'Roboto Mono', size: 10 }, padding: 6, callback: v => v + ' lbs' }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.03)' },
                            border: { color: 'rgba(255,255,255,0.08)' },
                            ticks: { color: '#666', font: { family: 'Roboto Mono', size: 10 }, padding: 6, maxRotation: 40 }
                        }
                    },
                    interaction: { intersect: false, mode: 'index' }
                }
            });

            // History table — newest first
            const tbody = g('historyTableBody');
            if (tbody) {
                const rows = [...entries].reverse();
                tbody.innerHTML = rows.map((e, i) => {
                    const prev = rows[i + 1];
                    let trend = '<span style="color:#444;">—</span>';
                    if (prev) {
                        const d = e.weight - prev.weight;
                        if (d > 0) trend = `<span style="color:#4ade80;">↑ +${d}</span>`;
                        else if (d < 0) trend = `<span style="color:#f87171;">↓ ${d}</span>`;
                    }
                    const vol  = e.weight * (parseInt(e.sets)||1) * (parseInt(e.reps)||1);
                    const isPR = e.weight === pr;
                    return `<tr style="${isPR ? 'background:rgba(255,179,71,0.08);' : ''}">
                        <td style="white-space:nowrap;">${e.dateLabel}${isPR ? ' <span style="background:var(--primary);color:#fff;font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px;margin-left:4px;vertical-align:middle;">PR</span>' : ''}</td>
                        <td style="color:#fff;font-weight:600;">${e.weight} lbs</td>
                        <td>${e.sets}×${e.reps}</td>
                        <td style="color:#888;">${vol.toLocaleString()}</td>
                        <td>${trend}</td>
                    </tr>`;
                }).join('');
            }
        }

        // ── FILTER TABS FUNCTIONALITY
        // Filter tabs functionality
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Action buttons
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const text = this.textContent;
                if (text.includes('Respect')) {
                    const count = parseInt(text.match(/\d+/)[0]) + 1;
                    this.innerHTML = `<span class="action-icon">👊</span><span>${count} Respect</span>`;
                }
            });
        });

        // Close modal on outside click
        const workoutModal = document.getElementById('workoutModal');
        if (workoutModal) {
            workoutModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }

        // ── ACTION PICKER ────────────────────────────────────────────────────
        function openActionPicker() {
            const picker = document.getElementById('actionPicker');
            if (picker) picker.style.display = 'block';
        }

        function closeActionPicker() {
            const picker = document.getElementById('actionPicker');
            if (picker) picker.style.display = 'none';
        }

        // ── MODAL & WORKOUT FUNCTIONS ────────────────────────────────────────
        function openModal() {
            const modal = document.getElementById('workoutModal');
            if (modal) modal.classList.add('active');
            goToStep1();
            resetExerciseContainer();
            // Reset fields
            const fields = ['workoutName','workoutDuration','captionInput'];
            fields.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
            const wt = document.getElementById('workoutType'); if (wt) wt.value = '';
        }

        function closeModal() {
            const modal = document.getElementById('workoutModal');
            if (modal) modal.classList.remove('active');
        }

        function openGroupWorkoutModal() {
            populateGroupDropdowns();
            const modal = document.getElementById('groupWorkoutModal');
            if (modal) modal.classList.add('active');
        }

        function closeGroupWorkoutModal() {
            const modal = document.getElementById('groupWorkoutModal');
            if (modal) modal.classList.remove('active');
        }

        // ── EDIT PROFILE ──────────────────────────────────────────────────────
        function openEditProfileModal() {
            const user = getCurrentUser();
            if (!user) return;
            const nameEl = document.getElementById('epName');
            const userEl = document.getElementById('epUsername');
            const bioEl  = document.getElementById('epBio');
            if (nameEl) nameEl.value = user.full_name || user.fullName || '';
            if (userEl) userEl.value = user.username || '';
            if (bioEl)  bioEl.value  = user.bio || '';

            // Pre-fill avatar preview
            const preview  = document.getElementById('epAvatarPreview');
            const initials = document.getElementById('epAvatarInitials');
            const avatarUrl = user.avatar_url || '';
            if (preview && initials) {
                if (avatarUrl) {
                    preview.src = avatarUrl;
                    preview.style.display = 'block';
                    initials.style.display = 'none';
                } else {
                    preview.style.display = 'none';
                    initials.style.display = '';
                    initials.textContent = user.initials || (user.full_name||user.username||'?').slice(0,2).toUpperCase();
                }
            }

            // Wire up avatar file input (attach once)
            const avatarInput = document.getElementById('epAvatarInput');
            if (avatarInput && !avatarInput._wired) {
                avatarInput._wired = true;
                avatarInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        if (preview)  { preview.src = ev.target.result; preview.style.display = 'block'; }
                        if (initials) initials.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                });
            }

            const modal = document.getElementById('editProfileModal');
            if (modal) modal.classList.add('active');
        }

        function closeEditProfileModal() {
            const modal = document.getElementById('editProfileModal');
            if (modal) modal.classList.remove('active');
        }

        async function handleSaveProfile() {
            const newName     = document.getElementById('epName')?.value.trim();
            const newUsername = document.getElementById('epUsername')?.value.trim().toLowerCase();
            const newBio      = document.getElementById('epBio')?.value.trim();
            const preview     = document.getElementById('epAvatarPreview');
            const newAvatar   = (preview?.style.display !== 'none' && preview?.src && !preview.src.startsWith('http://localhost') && preview.src !== window.location.href)
                                ? preview.src : null;

            if (!newName || !newUsername) { alert('Name and username are required.'); return; }

            const btn = document.querySelector('#editProfileForm .submit-btn');
            if (btn) { btn.textContent = 'Saving...'; btn.disabled = true; }

            try {
                const newInitials = newName.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
                const patchBody = {
                    full_name: newName,
                    username:  newUsername,
                    bio:       newBio || '',
                    initials:  newInitials
                };
                // Only update avatar_url if a new photo was picked
                if (newAvatar) patchBody.avatar_url = newAvatar;

                await sb(`profiles?id=eq.${window._sbUserId}`, {
                    method: 'PATCH',
                    prefer: 'return=representation',
                    body: patchBody
                });

                // Update local user object
                const user = getCurrentUser();
                if (user) {
                    user.full_name  = newName;
                    user.fullName   = newName;
                    user.username   = newUsername;
                    user.bio        = newBio || '';
                    user.initials   = newInitials;
                    if (newAvatar) user.avatar_url = newAvatar;
                    setCurrentUser(user);
                    loadProfileForUser(user);
                }
                closeEditProfileModal();
            } catch(e) {
                alert('Failed to save: ' + e.message);
            } finally {
                if (btn) { btn.textContent = 'Save Changes'; btn.disabled = false; }
            }
        }

        function addGroupExercise() {
            const container = document.getElementById('gwExerciseContainer');
            if (!container) return;
            const row = document.createElement('div');
            row.className = 'exercise-inputs';
            row.innerHTML = `
                <input type="text" placeholder="Exercise name">
                <input type="number" placeholder="Sets">
                <input type="number" placeholder="Reps">
                <input type="number" placeholder="Weight (lbs)">`;
            container.appendChild(row);
        }

        async function handlePostGroupWorkout() {
            const name      = document.getElementById('gwName')?.value.trim();
            const groupId   = document.getElementById('gwGroupSelect')?.value;
            const desc      = document.getElementById('gwDescription')?.value.trim();
            const notes     = document.getElementById('gwNotes')?.value.trim();
            const prevImg   = document.getElementById('gwPreviewImage');
            const photoSrc  = prevImg?.classList.contains('active') ? prevImg.src : null;

            if (!name)    { alert('Please enter a workout name.'); return; }
            if (!groupId) { alert('Please select a group to post to.'); return; }

            const exercises = [];
            document.querySelectorAll('#gwExerciseContainer .exercise-inputs').forEach(row => {
                const inputs = row.querySelectorAll('input');
                const n = inputs[0]?.value.trim();
                if (n) exercises.push({ name: n, sets: inputs[1]?.value||'', reps: inputs[2]?.value||'', weight: inputs[3]?.value||'' });
            });

            const btn = document.querySelector('#groupWorkoutForm .submit-btn');
            if (btn) { btn.textContent = 'Posting...'; btn.disabled = true; }

            try {
                await sb('group_workouts', {
                    method: 'POST',
                    body: {
                        group_id:    groupId,
                        user_id:     window._sbUserId || null,
                        name,
                        description: desc || null,
                        notes:       notes || null,
                        exercises,
                        photo_url:   photoSrc || null
                    }
                });
                // Increment workout count on group
                const g = window._userGroups.find(x => x.id === groupId);
                if (g) { g.workout_count = (g.workout_count || 0) + 1; }
            } catch(e) {
                console.warn('Post group workout failed:', e.message);
            } finally {
                if (btn) { btn.textContent = 'Post to Group'; btn.disabled = false; }
            }

            // Reset form
            document.getElementById('groupWorkoutForm')?.reset();
            const pImg   = document.getElementById('gwPreviewImage');
            const pZone  = document.getElementById('gwPhotoZone');
            const rPhoto = document.getElementById('gwRemovePhoto');
            if (pImg)   pImg.classList.remove('active');
            if (pZone)  pZone.classList.remove('has-image');
            if (rPhoto) rPhoto.classList.remove('active');
            const uIcon = pZone?.querySelector('.upload-icon');
            const uText = pZone?.querySelector('.upload-text');
            if (uIcon) uIcon.style.display = 'block';
            if (uText) uText.style.display = 'block';
            const gwContainer = document.getElementById('gwExerciseContainer');
            if (gwContainer) gwContainer.innerHTML = `<div class="exercise-inputs">
                <input type="text" placeholder="Exercise name">
                <input type="number" placeholder="Sets">
                <input type="number" placeholder="Reps">
                <input type="number" placeholder="Weight (lbs)">
            </div>`;

            closeGroupWorkoutModal();

            // Navigate to the group detail
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector('.nav-link[data-page="groups"]')?.classList.add('active');
            document.querySelectorAll('.feed-page,.progress-page,.groups-page,.profile-page').forEach(p => p.classList.remove('active'));
            document.querySelector('.groups-page')?.classList.add('active');
            await openGroup(groupId);
        }

        const EXERCISE_OPTIONS = [
            'Barbell Bench Press','Incline Dumbbell Press','Decline Bench Press','Cable Flyes','Chest Dips',
            'Overhead Press','Arnold Press','Lateral Raises','Front Raises','Face Pulls',
            'Deadlift','Romanian Deadlift','Sumo Deadlift','Pull-Ups','Chin-Ups',
            'Barbell Rows','Dumbbell Rows','Lat Pulldown','Seated Cable Row','T-Bar Row',
            'Back Squat','Front Squat','Hack Squat','Leg Press','Walking Lunges',
            'Bulgarian Split Squat','Leg Extension','Leg Curl','Calf Raises','Hip Thrust',
            'Barbell Curl','Hammer Curl','Preacher Curl','Tricep Pushdown','Skull Crushers',
            'Tricep Dips','Close-Grip Bench','Plank','Crunches','Hanging Leg Raises',
            'Russian Twists','Cable Crunch','Running','Cycling','Jump Rope','Custom...'
        ];

        function makeExerciseRow() {
            const row = document.createElement('div');
            row.className = 'exercise-inputs';
            row.style.cssText = 'display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:8px;margin-bottom:10px;align-items:center;';
            row.innerHTML = `
                <div style="position:relative;">
                    <select class="ex-name-select" onchange="handleExerciseSelect(this)" style="width:100%;padding:12px;background:var(--iron);border:2px solid #333;color:var(--white);font-family:'Oswald',sans-serif;font-size:14px;">
                        <option value="">— Exercise —</option>
                        ${EXERCISE_OPTIONS.map(e => `<option value="${e}">${e}</option>`).join('')}
                    </select>
                    <input class="ex-name-custom" type="text" placeholder="Type exercise name" style="display:none;width:100%;padding:12px;background:var(--iron);border:2px solid var(--primary);color:var(--white);font-family:'Oswald',sans-serif;font-size:14px;">
                </div>
                <input type="number" placeholder="Sets" min="1" style="padding:12px;background:var(--iron);border:2px solid #333;color:var(--white);font-family:'Oswald',sans-serif;font-size:14px;width:100%;">
                <input type="number" placeholder="Reps" min="1" style="padding:12px;background:var(--iron);border:2px solid #333;color:var(--white);font-family:'Oswald',sans-serif;font-size:14px;width:100%;">
                <input type="number" placeholder="lbs" min="0" style="padding:12px;background:var(--iron);border:2px solid #333;color:var(--white);font-family:'Oswald',sans-serif;font-size:14px;width:100%;">
                <button type="button" onclick="this.closest('.exercise-inputs').remove()" style="background:transparent;border:none;color:#555;font-size:20px;cursor:pointer;padding:8px;line-height:1;flex-shrink:0;" title="Remove">×</button>`;
            return row;
        }

        function handleExerciseSelect(sel) {
            const custom = sel.nextElementSibling;
            if (sel.value === 'Custom...') {
                sel.style.display = 'none';
                custom.style.display = 'block';
                custom.focus();
                // Allow going back to dropdown
                custom.onblur = () => { if (!custom.value) { sel.style.display = 'block'; custom.style.display = 'none'; sel.value = ''; } };
            }
        }

        function addExercise() {
            const container = document.getElementById('exerciseContainer');
            if (container) container.appendChild(makeExerciseRow());
        }

        function resetExerciseContainer() {
            const container = document.getElementById('exerciseContainer');
            if (!container) return;
            container.innerHTML = '';
            container.appendChild(makeExerciseRow());
        }

        // ── FEED SEARCH ──────────────────────────────────────────────────────
        let _searchTimer = null;

        function onFeedSearch(val) {
            clearTimeout(_searchTimer);
            const q = val.trim();
            if (!q) { closeSearchDropdown(); return; }
            _searchTimer = setTimeout(() => runSearch(q), 220);
        }

        async function runSearch(q) {
            const dropdown = document.getElementById('searchDropdown');
            if (!dropdown) return;
            dropdown.innerHTML = `<div class="search-no-results">Searching…</div>`;
            openSearchDropdown();
            try {
                // Search by full_name or username (case-insensitive via ilike)
                const results = await sb(
                    `profiles?or=(full_name.ilike.*${encodeURIComponent(q)}*,username.ilike.*${encodeURIComponent(q)}*)&select=id,full_name,username,initials,avatar_url&limit=8`
                );
                renderSearchResults(results || []);
            } catch(e) {
                dropdown.innerHTML = `<div class="search-no-results">Search unavailable</div>`;
            }
        }

        function renderSearchResults(results) {
            const dropdown = document.getElementById('searchDropdown');
            if (!dropdown) return;
            if (results.length === 0) {
                dropdown.innerHTML = `<div class="search-no-results">No users found</div>`;
                return;
            }
            dropdown.innerHTML = results.map(p => {
                const name     = p.full_name || p.username || 'Unknown';
                const initials = p.initials || name.slice(0,2).toUpperCase();
                const avHtml   = p.avatar_url
                    ? `<img src="${p.avatar_url}" alt="">`
                    : initials;
                return `<div class="search-result-item" onclick="openUserProfile('${p.id}','${name.replace(/'/g,"\\'")}','${(p.username||'').replace(/'/g,"\\'")}','${initials}','${p.avatar_url||''}')">
                    <div class="search-result-avatar">${avHtml}</div>
                    <div>
                        <div class="search-result-name">${name}</div>
                        <div class="search-result-username">@${p.username||''}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function openSearchDropdown() {
            document.getElementById('searchDropdown')?.classList.add('open');
        }

        function closeSearchDropdown() {
            document.getElementById('searchDropdown')?.classList.remove('open');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', e => {
            const wrap = document.getElementById('feedSearchWrap');
            if (wrap && !wrap.contains(e.target)) closeSearchDropdown();
        });

        // Navigate to a user's profile overlay
        async function openUserProfile(userId, name, username, initials, avatarUrl) {
            closeSearchDropdown();
            document.getElementById('feedSearchInput').value = '';

            let overlay = document.getElementById('userProfileOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'userProfileOverlay';
                overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:1997;background:#0a0a0a;overflow-y:auto;padding-bottom:90px;transform:translateX(100%);transition:transform 0.32s cubic-bezier(0.32,0.72,0,1);-webkit-overflow-scrolling:touch;';
                document.body.appendChild(overlay);
            }

            const avHtml = avatarUrl
                ? `<img src="${avatarUrl}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--primary);">`
                : `<div style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:32px;">${initials}</div>`;

            overlay.innerHTML = `
                <div style="position:sticky;top:0;z-index:10;background:rgba(10,10,10,0.92);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-bottom:1px solid #1a1a1a;padding:14px 18px;">
                    <button onclick="closeUserProfile()" style="background:transparent;border:none;cursor:pointer;display:flex;align-items:center;gap:6px;color:#888;font-family:'Oswald',sans-serif;font-size:13px;letter-spacing:1px;text-transform:uppercase;padding:0;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg>Back
                    </button>
                </div>
                <div style="padding:24px 18px 0;">
                    <div style="display:flex;align-items:flex-start;gap:16px;margin-bottom:18px;">
                        ${avHtml}
                        <div style="flex:1;">
                            <div style="font-family:'Bebas Neue',cursive;font-size:26px;letter-spacing:2px;color:#fff;line-height:1.1;">${name}</div>
                            <div style="font-family:'Roboto Mono',monospace;font-size:12px;color:var(--primary);margin-top:2px;margin-bottom:10px;">@${username}</div>
                            <div id="upBio" style="font-size:13px;color:#777;line-height:1.5;"></div>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:18px;">
                        <div style="background:#1a1a1a;border-radius:10px;padding:12px 8px;text-align:center;">
                            <div id="upWorkouts" style="font-family:'Bebas Neue',cursive;font-size:26px;color:var(--primary);">—</div>
                            <div style="font-family:'Oswald',sans-serif;font-size:10px;color:#444;text-transform:uppercase;letter-spacing:0.5px;margin-top:2px;">Workouts</div>
                        </div>
                        <div style="background:#1a1a1a;border-radius:10px;padding:12px 8px;text-align:center;">
                            <div id="upFollowers" style="font-family:'Bebas Neue',cursive;font-size:26px;color:var(--primary);">—</div>
                            <div style="font-family:'Oswald',sans-serif;font-size:10px;color:#444;text-transform:uppercase;letter-spacing:0.5px;margin-top:2px;">Followers</div>
                        </div>
                        <div style="background:#1a1a1a;border-radius:10px;padding:12px 8px;text-align:center;">
                            <div id="upFollowing" style="font-family:'Bebas Neue',cursive;font-size:26px;color:var(--primary);">—</div>
                            <div style="font-family:'Oswald',sans-serif;font-size:10px;color:#444;text-transform:uppercase;letter-spacing:0.5px;margin-top:2px;">Following</div>
                        </div>
                    </div>
                    <div style="display:flex;border-bottom:1px solid #1e1e1e;margin-bottom:0;">
                        <button id="upTabPosts" onclick="switchUpTab('posts')" style="flex:1;background:transparent;border:none;border-bottom:2px solid var(--primary);color:var(--primary);font-family:'Oswald',sans-serif;font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:1px;padding:12px 0;cursor:pointer;transition:all 0.2s;">Posts</button>
                        <button id="upTabAchievements" onclick="switchUpTab('achievements')" style="flex:1;background:transparent;border:none;border-bottom:2px solid transparent;color:#444;font-family:'Oswald',sans-serif;font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:1px;padding:12px 0;cursor:pointer;transition:all 0.2s;">Achievements</button>
                    </div>
                </div>
                <div id="upTabPosts-content" style="padding-top:8px;"><div style="text-align:center;padding:40px;color:#333;font-family:'Oswald',sans-serif;font-size:13px;letter-spacing:1px;">Loading…</div></div>
                <div id="upTabAchievements-content" style="display:none;padding:16px;"><div style="text-align:center;padding:40px;color:#333;font-family:'Oswald',sans-serif;font-size:13px;letter-spacing:1px;">Loading…</div></div>`;

            overlay.style.display = 'block';
            requestAnimationFrame(() => requestAnimationFrame(() => { overlay.style.transform = 'translateX(0)'; }));

            try {
                const [profiles, workouts] = await Promise.all([
                    sb(`profiles?id=eq.${userId}&select=*`).catch(()=>[]),
                    sb(`workouts?user_id=eq.${userId}&order=created_at.desc&limit=30&select=*`).catch(()=>[])
                ]);
                const profile = profiles?.[0];
                const wList   = workouts || [];

                const bioEl = document.getElementById('upBio');
                const wkEl  = document.getElementById('upWorkouts');
                const flEl  = document.getElementById('upFollowers');
                const fiEl  = document.getElementById('upFollowing');
                if (bioEl) bioEl.textContent = profile?.bio || '';
                if (wkEl)  wkEl.textContent  = wList.length;
                if (flEl)  flEl.textContent  = profile?.followers ?? 0;
                if (fiEl)  fiEl.textContent  = profile?.following ?? 0;

                const postsFeed = document.getElementById('upTabPosts-content');
                if (postsFeed) {
                    if (wList.length === 0) {
                        postsFeed.innerHTML = `<div style="text-align:center;padding:50px 20px;color:#333;font-family:'Oswald',sans-serif;font-size:13px;letter-spacing:1px;">No workouts yet</div>`;
                    } else {
                        postsFeed.innerHTML = '';
                        wList.forEach(w => {
                            const dateStr = w.created_at ? new Date(w.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';
                            postsFeed.appendChild(buildSimpleCard({ name:w.name, duration:w.duration, exercises:w.exercises||[], photoSrc:w.photo_url||null, caption:w.caption||null, dateStr, avatarUrl:profile?.avatar_url||avatarUrl, initials, userName:name }));
                        });
                    }
                }

                const achDiv = document.getElementById('upTabAchievements-content');
                if (achDiv) achDiv.innerHTML = buildAchievementsHTML(wList);

            } catch(e) {
                const f = document.getElementById('upTabPosts-content');
                if (f) f.innerHTML = `<div style="text-align:center;padding:40px;color:#333;">Could not load profile</div>`;
            }
        }

        function switchUpTab(tab) {
            ['posts','achievements'].forEach(t => {
                const key = t.charAt(0).toUpperCase()+t.slice(1);
                const btn = document.getElementById('upTab'+key);
                const con = document.getElementById('upTab'+key+'-content');
                const active = t === tab;
                if (btn) { btn.style.borderBottomColor = active ? 'var(--primary)' : 'transparent'; btn.style.color = active ? 'var(--primary)' : '#444'; }
                if (con) con.style.display = active ? 'block' : 'none';
            });
        }

        function buildAchievementsHTML(workouts) {
            const count = workouts.length;
            const totalMins = workouts.reduce((s,w) => s+(parseInt(w.duration)||0), 0);
            const allEx = workouts.flatMap(w => (w.exercises||[]).map(e => e.name?.toLowerCase()));
            const weekMap = {};
            workouts.forEach(w => { const d=new Date(w.created_at||w.date); const k=`${d.getFullYear()}-W${Math.floor((d-new Date(d.getFullYear(),0,1))/604800000)}`; weekMap[k]=(weekMap[k]||0)+1; });
            const all = [
                { icon:'🥇', title:'First Rep',    desc:'Log your first workout',  earned:count>=1 },
                { icon:'🔟', title:'10 Club',      desc:'Log 10 workouts',          earned:count>=10 },
                { icon:'🏆', title:'25 Club',      desc:'Log 25 workouts',          earned:count>=25 },
                { icon:'💯', title:'100 Club',     desc:'Log 100 workouts',         earned:count>=100 },
                { icon:'⏱️', title:'Hour Grinder', desc:'60+ min in one workout',  earned:workouts.some(w=>w.duration>=60) },
                { icon:'🕐', title:'Time Warrior', desc:'Log 1,000 total minutes',  earned:totalMins>=1000 },
                { icon:'💪', title:'Variety Pack', desc:'5 different exercises',    earned:new Set(allEx.filter(Boolean)).size>=5 },
                { icon:'🔥', title:'On Fire',      desc:'3 workouts in one week',   earned:Object.values(weekMap).some(v=>v>=3) },
            ];
            const rowStyle = (earned) => `display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid #1e1e1e;${earned?'':'opacity:0.3;'}`;
            return all.map(a => `<div style="${rowStyle(a.earned)}"><div style="font-size:26px;width:34px;text-align:center;">${a.earned?a.icon:'🔒'}</div><div><div style="font-family:'Oswald',sans-serif;font-size:13px;color:${a.earned?'#fff':'#555'};font-weight:600;">${a.title}</div><div style="font-size:11px;color:#444;margin-top:1px;">${a.desc}</div></div></div>`).join('');
        }

        function closeUserProfile() {
            const overlay = document.getElementById('userProfileOverlay');
            if (!overlay) return;
            overlay.style.transform = 'translateX(100%)';
            setTimeout(() => { overlay.style.display = 'none'; }, 320);
        }


        // ── STEP NAVIGATION ──────────────────────────────────────────────────
        function goToStep1() {
            document.getElementById('logStep1').style.display = 'block';
            document.getElementById('logStep2').style.display = 'none';
            document.getElementById('stepDot1').style.background = 'var(--primary)';
            document.getElementById('stepDot1').style.color = '#fff';
            document.getElementById('stepDot2').style.background = '#333';
            document.getElementById('stepDot2').style.color = '#666';
            document.getElementById('stepLine').style.opacity = '0.25';
            document.getElementById('stepLabel').textContent = 'EXERCISES';
        }

        function goToStep2() {
            const name = document.getElementById('workoutName')?.value.trim();
            if (!name) {
                document.getElementById('workoutName').focus();
                document.getElementById('workoutName').style.borderColor = 'var(--primary)';
                return;
            }
            // Populate the "post to group" dropdown with real groups
            const sel = document.getElementById('postToGroupSelect');
            if (sel) {
                sel.innerHTML = '<option value="">— No, just my feed —</option>' +
                    (window._userGroups||[]).map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            }
            document.getElementById('logStep1').style.display = 'none';
            document.getElementById('logStep2').style.display = 'block';
            document.getElementById('stepDot1').style.background = '#4ade80';
            document.getElementById('stepDot1').innerHTML = '✓';
            document.getElementById('stepDot2').style.background = 'var(--primary)';
            document.getElementById('stepDot2').style.color = '#fff';
            document.getElementById('stepLine').style.opacity = '1';
            document.getElementById('stepLabel').textContent = 'SHARE';
        }

        function toggleDetails(button) {
            button.classList.toggle('active');
            const content = button.nextElementSibling;
            if (content) content.classList.toggle('active');
        }

        // ── SIMPLE FEED CARD BUILDER ─────────────────────────────────────────
        function buildSimpleCard(opts) {
            // opts: { workoutId, name, duration, exercises, photoSrc, caption, dateStr, avatarUrl, initials, userName }
            const { workoutId, name, duration, exercises=[], photoSrc, caption, dateStr, avatarUrl, initials, userName } = opts;

            const photoHTML   = photoSrc ? `<img src="${photoSrc}" class="workout-photo" alt="">` : '';
            // Strip any HTML/SVG that may have leaked into caption from old data
            const safeCaption = caption ? caption.replace(/<[^>]*>/g, '').replace(/&[a-z]+;/gi, '').trim() : null;
            const captionHTML = safeCaption ? `<p style="padding:12px 18px 0;font-size:14px;color:#ccc;line-height:1.5;">"${safeCaption}"</p>` : '';

            const pills = exercises.slice(0, 6).map(ex =>
                `<span class="ex-pill">${ex.name}${ex.weight ? ' · ' + ex.weight + 'lb' : ''}</span>`
            ).join('');
            const moreCount = exercises.length - 6;
            const morePill  = moreCount > 0 ? `<span class="ex-pill">+${moreCount} more</span>` : '';

            const card = document.createElement('div');
            card.className = 'activity-card';
            // Store workout data on the element for the detail modal
            card._workoutData = opts;
            card._workoutId   = workoutId || null;
            card.innerHTML = `
                <div class="activity-header">
                    ${avatarHTML(avatarUrl||'', initials||'??', 46)}
                    <div class="activity-user-info">
                        <h3 style="font-size:16px;">${userName||'Unknown'}</h3>
                        <span class="activity-time">${dateStr||'Just now'}</span>
                    </div>
                </div>
                <h2 class="workout-title" style="padding:8px 18px;font-size:22px;">${name.toUpperCase()}</h2>
                ${photoHTML}${captionHTML}
                <div class="card-exercises-row">${pills}${morePill}</div>
                <div class="card-meta-row">
                    <span class="card-duration">${duration ? '⏱ ' + duration + ' min' : ''}</span>
                    <button class="view-workout-btn" onclick="openWorkoutDetail(this.closest('.activity-card'))">View Full Workout</button>
                </div>
                <div class="activity-actions" style="padding:12px 18px;">
                    <button class="action-btn" onclick="openWorkoutDetail(this.closest('.activity-card'))"><span class="action-icon">👊</span><span class="card-like-count">0 Respect</span></button>
                    <button class="action-btn" onclick="openWorkoutDetail(this.closest('.activity-card'))"><span class="action-icon">💬</span><span class="card-comment-count">0 Comments</span></button>
                </div>`;
            return card;
        }

        // ── WORKOUT DETAIL MODAL ─────────────────────────────────────────────
        let _detailBarChart = null;
        let _detailWorkoutId = null;
        let _detailCardEl = null;

        async function openWorkoutDetail(cardEl) {
            const data = cardEl?._workoutData;
            if (!data) return;
            const { name, duration, exercises=[], dateStr, avatarUrl, initials, userName } = data;
            _detailWorkoutId = cardEl._workoutId || null;
            _detailCardEl    = cardEl;

            document.getElementById('detailWorkoutName').textContent = name.toUpperCase();
            document.getElementById('detailWorkoutMeta').textContent =
                [dateStr, duration ? duration + ' min' : null, userName].filter(Boolean).join(' · ');

            // Table
            const tbody = document.getElementById('detailExBody');
            if (tbody) {
                tbody.innerHTML = exercises.length ? exercises.map(ex => {
                    const vol = (parseFloat(ex.weight)||0)*(parseInt(ex.sets)||1)*(parseInt(ex.reps)||1);
                    return `<tr><td>${ex.name}</td><td>${ex.sets||'—'}</td><td>${ex.reps||'—'}</td><td>${ex.weight?ex.weight+' lb':'—'}</td><td style="color:#555;">${vol?vol.toLocaleString():'—'}</td></tr>`;
                }).join('') : '<tr><td colspan="5" style="color:#444;text-align:center;padding:20px;">No exercises recorded</td></tr>';
            }

            // Bar chart
            const chartWrap = document.getElementById('detailChartWrap');
            const chartLabel = document.getElementById('detailChartLabel');
            requestAnimationFrame(() => {
                const canvas = document.getElementById('detailBarChart');
                if (!canvas) return;
                if (_detailBarChart) { _detailBarChart.destroy(); _detailBarChart = null; }
                const exWithWeight = exercises.filter(e => parseFloat(e.weight) > 0);
                if (exWithWeight.length === 0) {
                    if (chartWrap)  chartWrap.style.display  = 'none';
                    if (chartLabel) chartLabel.style.display = 'none';
                    return;
                }
                if (chartWrap)  chartWrap.style.display  = 'block';
                if (chartLabel) chartLabel.style.display = 'block';
                const labels  = exWithWeight.map(e => e.name.length > 14 ? e.name.slice(0,13)+'…' : e.name);
                const weights = exWithWeight.map(e => parseFloat(e.weight)||0);
                const volumes = exWithWeight.map(e => (parseFloat(e.weight)||0)*(parseInt(e.sets)||1)*(parseInt(e.reps)||1));
                const ctx = canvas.getContext('2d');
                _detailBarChart = new Chart(ctx, {
                    type:'bar', data:{ labels, datasets:[{ label:'Weight (lbs)', data:weights, backgroundColor:'rgba(255,107,53,0.75)', borderColor:'#ff6b35', borderWidth:1.5, borderRadius:4, yAxisID:'y' },{ label:'Volume', data:volumes, backgroundColor:'rgba(255,179,71,0.35)', borderColor:'#ffb347', borderWidth:1.5, borderRadius:4, yAxisID:'y2' }] },
                    options:{ responsive:true, maintainAspectRatio:false, animation:{duration:500}, plugins:{ legend:{display:true,labels:{color:'#666',font:{family:'Oswald',size:11},boxWidth:12,padding:14}}, tooltip:{backgroundColor:'#1a1a1a',titleColor:'#ff6b35',bodyColor:'#eee',borderColor:'#333',borderWidth:1,cornerRadius:8,padding:10,titleFont:{family:'Oswald',size:12},bodyFont:{family:'Roboto Mono',size:11}} }, scales:{ y:{position:'left',beginAtZero:true,grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#555',font:{family:'Roboto Mono',size:9},callback:v=>v+'lb'}}, y2:{position:'right',beginAtZero:true,grid:{display:false},ticks:{color:'#555',font:{family:'Roboto Mono',size:9},callback:v=>v.toLocaleString()}}, x:{grid:{display:false},ticks:{color:'#666',font:{family:'Roboto Mono',size:9},maxRotation:35}} } }
                });
            });

            // Set up comment avatar
            const me = getCurrentUser();
            const caEl = document.getElementById('detailCommentAvatar');
            if (caEl) {
                if (me?.avatar_url) { caEl.innerHTML = `<img src="${me.avatar_url}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`; }
                else { caEl.textContent = me?.initials || '?'; }
            }

            // Open modal first, then load async data
            const modal = document.getElementById('workoutDetailModal');
            if (modal) modal.classList.add('active');

            // Load likes + comments
            if (_detailWorkoutId) {
                loadDetailLikes(_detailWorkoutId);
                loadDetailComments(_detailWorkoutId);
            } else {
                // No DB workout — reset
                const lc = document.getElementById('detailLikeCount'); if(lc) lc.textContent = '0 Respect';
                const lb = document.getElementById('detailLikeBtn'); if(lb) { lb.style.color='#666'; lb._liked=false; }
                const cl = document.getElementById('detailCommentsList'); if(cl) cl.innerHTML = '';
            }
        }

        async function loadDetailLikes(workoutId) {
            const btn   = document.getElementById('detailLikeBtn');
            const count = document.getElementById('detailLikeCount');
            if (!btn || !count) return;
            try {
                const likes = await sb(`workout_likes?workout_id=eq.${workoutId}&select=user_id`);
                const myId  = window._sbUserId;
                const liked = !!(myId && (likes||[]).some(l => l.user_id === myId));
                const n     = (likes||[]).length;
                count.textContent = `${n} Respect`;
                btn._liked        = liked;
                btn.style.color   = liked ? 'var(--primary)' : '#666';
                // Sync count back to the card action bar
                if (_detailCardEl) {
                    const cardLike = _detailCardEl.querySelector('.card-like-count');
                    if (cardLike) cardLike.textContent = `${n} Respect`;
                }
            } catch(e) { /* workout_likes table may not exist yet */ }
        }

        async function toggleDetailLike() {
            const workoutId = _detailWorkoutId;
            if (!workoutId || !window._sbUserId) {
                alert('Log in to like workouts!');
                return;
            }
            const btn   = document.getElementById('detailLikeBtn');
            const count = document.getElementById('detailLikeCount');
            const liked = btn?._liked;
            const cur   = parseInt(count?.textContent) || 0;
            const newN  = liked ? Math.max(0, cur - 1) : cur + 1;

            // Optimistic UI — update modal
            if (btn)   { btn._liked = !liked; btn.style.color = !liked ? 'var(--primary)' : '#666'; }
            if (count) { count.textContent = `${newN} Respect`; }

            // Immediately sync count back to card too
            if (_detailCardEl) {
                const cardLike = _detailCardEl.querySelector('.card-like-count');
                if (cardLike) cardLike.textContent = `${newN} Respect`;
                if (!liked) { // pulse animation on like
                    const cardBtn = _detailCardEl.querySelector('.action-btn');
                    if (cardBtn) { cardBtn.style.color = 'var(--primary)'; }
                }
            }

            try {
                if (liked) {
                    await sb(`workout_likes?workout_id=eq.${workoutId}&user_id=eq.${window._sbUserId}`, { method:'DELETE', prefer:'return=minimal' });
                } else {
                    await sb('workout_likes', { method:'POST', body:{ workout_id:workoutId, user_id:window._sbUserId } });
                }
            } catch(e) {
                // Revert on error
                if (btn)   { btn._liked = liked; btn.style.color = liked ? 'var(--primary)' : '#666'; }
                if (count) { count.textContent = `${cur} Respect`; }
                if (_detailCardEl) {
                    const cardLike = _detailCardEl.querySelector('.card-like-count');
                    if (cardLike) cardLike.textContent = `${cur} Respect`;
                }
            }
        }

        async function loadDetailComments(workoutId) {
            const list = document.getElementById('detailCommentsList');
            if (!list) return;
            list.innerHTML = '<div style="padding:16px;text-align:center;color:#333;font-size:12px;">Loading…</div>';
            try {
                const comments = await sb(`workout_comments?workout_id=eq.${workoutId}&order=created_at.asc&select=*,profiles(full_name,initials,avatar_url)`);
                renderDetailComments(comments || []);
                // Sync comment count back to card
                if (_detailCardEl) {
                    const countEl = _detailCardEl.querySelector('.card-comment-count');
                    if (countEl) countEl.textContent = `${(comments||[]).length} Comments`;
                }
            } catch(e) { list.innerHTML = ''; }
        }

        function renderDetailComments(comments) {
            const list = document.getElementById('detailCommentsList');
            if (!list) return;
            if (comments.length === 0) {
                list.innerHTML = '<div style="padding:16px 20px;color:#333;font-family:\'Oswald\',sans-serif;font-size:12px;letter-spacing:1px;">Be the first to comment…</div>';
                return;
            }
            list.innerHTML = comments.map(c => {
                const name     = c.profiles?.full_name || 'Unknown';
                const initials = c.profiles?.initials  || name.slice(0,2).toUpperCase();
                const avHtml   = c.profiles?.avatar_url
                    ? `<img src="${c.profiles.avatar_url}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
                    : initials;
                const timeStr = c.created_at ? timeAgo(new Date(c.created_at)) : '';
                return `<div class="detail-comment">
                    <div class="detail-comment-avatar">${avHtml}</div>
                    <div style="flex:1;">
                        <div class="detail-comment-name">${name} <span class="detail-comment-time">${timeStr}</span></div>
                        <div class="detail-comment-text">${c.body || ''}</div>
                    </div>
                </div>`;
            }).join('');
        }

        async function submitDetailComment() {
            const input = document.getElementById('detailCommentInput');
            const body = input?.value.trim();
            if (!body || !_detailWorkoutId || !window._sbUserId) return;
            input.value = '';
            const me = getCurrentUser();

            // Append optimistically to comments list
            const list = document.getElementById('detailCommentsList');
            if (list) {
                const isEmpty = list.children.length === 1 && list.firstChild?.style?.color === '#333';
                if (isEmpty) list.innerHTML = '';
                const avHtml = me?.avatar_url ? `<img src="${me.avatar_url}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : (me?.initials||'?');
                const newRow = document.createElement('div');
                newRow.className = 'detail-comment';
                newRow.innerHTML = `<div class="detail-comment-avatar">${avHtml}</div><div style="flex:1;"><div class="detail-comment-name">${me?.full_name||me?.fullName||'You'} <span class="detail-comment-time">Just now</span></div><div class="detail-comment-text">${body}</div></div>`;
                list.appendChild(newRow);
                newRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // Sync comment count back to card
            if (_detailCardEl) {
                const countEl = _detailCardEl.querySelector('.card-comment-count');
                if (countEl) {
                    const cur = parseInt(countEl.textContent) || 0;
                    countEl.textContent = `${cur + 1} Comments`;
                }
            }

            try {
                await sb('workout_comments', { method:'POST', body:{ workout_id:_detailWorkoutId, user_id:window._sbUserId, body } });
            } catch(e) { console.warn('Comment save failed:', e.message); }
        }

        function closeWorkoutDetail() {
            const modal = document.getElementById('workoutDetailModal');
            if (modal) modal.classList.remove('active');
            document.getElementById('detailCommentInput') && (document.getElementById('detailCommentInput').value = '');
        }

        function handleRespect(btn) {
            const span = btn.querySelector('span:last-child');
            const count = parseInt(span.textContent) + 1;
            span.textContent = count + ' Respect';
            btn.style.color = 'var(--primary)';
        }

        // ── AVATAR HELPER — returns either <img> or initials div ─────────────
        function avatarHTML(avatarUrl, initials, size) {
            size = size || 50;
            const fontSize = Math.round(size * 0.44);
            if (avatarUrl) {
                return `<img src="${avatarUrl}" style="width:${size}px;height:${size}px;border-radius:50%;object-fit:cover;border:2px solid var(--primary);flex-shrink:0;" alt="">`;
            }
            return `<div class="user-avatar" style="width:${size}px;height:${size}px;font-size:${fontSize}px;">${initials}</div>`;
        }

        async function handleLogWorkout() {
            const workoutName = document.getElementById('workoutName')?.value.trim();
            const duration    = parseInt(document.getElementById('workoutDuration')?.value) || 0;
            const caption     = document.getElementById('captionInput')?.value.trim();
            const previewImg  = document.getElementById('previewImage');
            const photoSrc    = previewImg?.classList.contains('active') ? previewImg.src : null;
            const postGroupId = document.getElementById('postToGroupSelect')?.value || '';

            if (!workoutName) { goToStep1(); document.getElementById('workoutName').focus(); return; }

            // Read exercises from new dropdown rows
            const exercises = [];
            document.querySelectorAll('#exerciseContainer .exercise-inputs').forEach(row => {
                const sel    = row.querySelector('.ex-name-select');
                const custom = row.querySelector('.ex-name-custom');
                // Name: prefer custom input if visible, else dropdown value
                let exName = '';
                if (custom && custom.style.display !== 'none') {
                    exName = custom.value.trim();
                } else if (sel) {
                    exName = sel.value === 'Custom...' ? '' : sel.value;
                }
                const numInputs = row.querySelectorAll('input[type="number"]');
                const sets   = numInputs[0]?.value || '';
                const reps   = numInputs[1]?.value || '';
                const weight = numInputs[2]?.value || '';
                if (exName) exercises.push({ name: exName, sets, reps, weight });
            });

            const postBtn = document.querySelector('#logStep2 .submit-btn');
            if (postBtn) { postBtn.textContent = 'Posting...'; postBtn.disabled = true; }

            const user      = getCurrentUser();
            const userName  = user ? (user.full_name || user.fullName || user.username) : 'Anonymous';
            const initials  = user ? (user.initials || userName.slice(0,2).toUpperCase()) : '??';
            const userAvUrl = user?.avatar_url || '';

            // Save personal workout to Supabase
            if (user && window._sbUserId) {
                try {
                    await sb('workouts', { method: 'POST', body: {
                        user_id:   window._sbUserId,
                        name:      workoutName,
                        duration,
                        caption:   caption || null,
                        exercises,
                        photo_url: photoSrc || null
                    }});
                    const fresh = await sb(`workouts?user_id=eq.${window._sbUserId}&order=created_at.desc&select=*`);
                    if (fresh) { user.workouts = fresh; setCurrentUser(user); refreshProfileStats(user); refreshProfileWorkouts(user); refreshAchievements(user); }
                } catch(e) { console.warn('Save workout failed:', e.message); }

                // Also post to group if selected
                if (postGroupId) {
                    try {
                        await sb('group_workouts', { method: 'POST', body: {
                            group_id:    postGroupId,
                            user_id:     window._sbUserId,
                            name:        workoutName,
                            description: caption || null,
                            exercises,
                            photo_url:   photoSrc || null
                        }});
                    } catch(e) { console.warn('Group post failed:', e.message); }
                }
            }

            // Build feed card
            const card = buildSimpleCard({
                name:      workoutName,
                duration,
                exercises,
                photoSrc,
                caption,
                dateStr:   'Just now',
                avatarUrl: userAvUrl,
                initials,
                userName
            });

            const feed = document.querySelector('.activity-feed');
            if (feed) feed.insertBefore(card, feed.firstChild);

            // Reset photo
            const pImg  = document.getElementById('previewImage');
            const pZone = document.getElementById('photoZone');
            const rPhoto = document.getElementById('removePhoto');
            if (pImg)   { pImg.src = ''; pImg.classList.remove('active'); }
            if (pZone)  pZone.classList.remove('has-image');
            if (rPhoto) rPhoto.classList.remove('active');
            const uIcon = pZone?.querySelector('.upload-icon');
            const uText = pZone?.querySelector('.upload-text');
            if (uIcon) uIcon.style.display = '';
            if (uText) uText.style.display = '';
            document.getElementById('photoInput').value = '';

            if (postBtn) { postBtn.textContent = 'Post Workout 🔥'; postBtn.disabled = false; }
            closeModal();

            // Navigate to feed
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector('.nav-link[data-page="feed"]')?.classList.add('active');
            document.querySelectorAll('.feed-page,.progress-page,.groups-page,.profile-page').forEach(p => p.classList.remove('active'));
            document.querySelector('.feed-page')?.classList.add('active');
        }

        // ── SUPABASE CONFIG ─────────────────────────────────────────────────
        const SUPABASE_URL = 'https://nygqoszurqvvdtndpufo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55Z3Fvc3p1cnF2dmR0bmRwdWZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NzU5NDksImV4cCI6MjA4NjM1MTk0OX0.KSd3SPRK2RULFCikjS7WpAlf8YvBiZnwsyA3OT6dzPY';

        window._ssCurrentUser = null;
        window._sbToken       = null;
        window._sbUserId      = null;

        // ── CONNECTION TEST ───────────────────────────────────────────────────
        // Show a helpful banner if Supabase can't be reached
        async function testConnection() {
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/profiles?limit=1`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                if (res.ok || res.status === 401 || res.status === 406) {
                    // Any HTTP response means we can reach Supabase — good
                    return true;
                }
                throw new Error(`HTTP ${res.status}`);
            } catch(e) {
                // Show a helpful overlay
                const banner = document.createElement('div');
                banner.style.cssText = `position:fixed;top:0;left:0;right:0;z-index:9999;background:#1a0a00;border-bottom:3px solid #ff6b35;padding:20px 25px;font-family:'Oswald',sans-serif;color:#fff;`;
                banner.innerHTML = `
                    <div style="font-size:18px;color:#ff6b35;font-weight:bold;margin-bottom:8px;">⚠️ CANNOT CONNECT TO SERVER</div>
                    <div style="font-size:14px;color:#ccc;line-height:1.6;">
                        Opening this file directly won't work because browsers block network requests from local files.<br>
                        <strong style="color:#ff6b35;">Fix:</strong> Host this file on any web server, or use VS Code's Live Server extension.
                    </div>`;
                document.body.appendChild(banner);
                // Push content down
                document.querySelector('main')?.style.setProperty('padding-top', '100px');
                return false;
            }
        }
        testConnection();

        // REST helper
        async function sb(path, opts = {}) {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
                method: opts.method || 'GET',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${window._sbToken || SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': opts.prefer || 'return=representation',
                    ...opts.headers
                },
                body: opts.body ? JSON.stringify(opts.body) : undefined
            });
            if (!res.ok) {
                const e = await res.json().catch(() => ({}));
                throw new Error(e.message || e.error_description || res.statusText);
            }
            return res.status === 204 ? null : res.json();
        }

        async function sbAuth(endpoint, email, password) {
            const res = await fetch(`${SUPABASE_URL}/auth/v1/${endpoint}`, {
                method: 'POST',
                headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error_description || data.msg || 'Auth failed');
            return data;
        }

        function getCurrentUser() { return window._ssCurrentUser; }
        function setCurrentUser(u) { window._ssCurrentUser = u; }

        function saveSession(data) {
            try {
                localStorage.setItem('sb_session', JSON.stringify({
                    access_token: data.access_token,
                    user_id: data.user.id,
                    expires_at: data.expires_at
                }));
            } catch(e) {}
        }

        // ── AUTH UI ──────────────────────────────────────────────────────────
        function showSignup() {
            const sp = document.getElementById('signupPage');
            const lp = document.getElementById('loginPage');
            if (sp) { sp.style.display = 'flex'; sp.classList.add('active'); }
            if (lp) { lp.style.display = 'none';  lp.classList.remove('active'); }
            clearAuthErrors();
        }

        function showLogin() {
            const lp = document.getElementById('loginPage');
            const sp = document.getElementById('signupPage');
            if (lp) { lp.style.display = 'flex'; lp.classList.add('active'); }
            if (sp) { sp.style.display = 'none';  sp.classList.remove('active'); }
            clearAuthErrors();
        }

        function logout() {
            window._ssCurrentUser = null;
            window._sbToken = null;
            window._sbUserId = null;
            try { localStorage.removeItem('sb_session'); } catch(e) {}
            document.querySelectorAll('.feed-page,.progress-page,.groups-page,.profile-page').forEach(p => p.classList.remove('active'));
            showSignup();
        }

        function showAuthError(formId, msg) {
            const el = document.getElementById(formId + 'Error');
            if (el) { el.textContent = msg; el.style.display = 'block'; }
        }

        function clearAuthErrors() {
            document.querySelectorAll('.auth-error').forEach(el => { el.textContent = ''; el.style.display = 'none'; });
        }

        // ── PROFILE ──────────────────────────────────────────────────────────
        function refreshProfileStats(user) {
            const workouts = user.workouts || [];
            const el = id => document.getElementById(id);
            if (el('statTotalWorkouts'))  el('statTotalWorkouts').textContent  = workouts.length;
            if (el('statTotalExercises')) el('statTotalExercises').textContent = workouts.reduce((s,w) => s+(w.exercises?.length||0), 0);
            if (el('statTotalMinutes'))   el('statTotalMinutes').textContent   = workouts.reduce((s,w) => s+(parseInt(w.duration)||0), 0);
            if (el('profileWorkoutCount')) el('profileWorkoutCount').textContent = workouts.length;
            const list = document.getElementById('recentWorkoutsList');
            if (list) {
                if (workouts.length === 0) { list.innerHTML = '<p style="color:#999;text-align:center;padding:30px;">No workouts yet.</p>'; return; }
                list.innerHTML = `<h3 style="font-family:'Bebas Neue',cursive;font-size:22px;letter-spacing:2px;color:var(--primary);margin-bottom:15px;">Recent Workouts</h3>` +
                    workouts.slice(0,10).map(w => `<div style="background:var(--steel);border-left:3px solid var(--primary);padding:15px 20px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;border-radius:0 8px 8px 0;">
                        <div><div style="font-family:'Bebas Neue',cursive;font-size:18px;letter-spacing:1px;">${w.name.toUpperCase()}</div>
                        <div style="font-size:12px;color:#999;margin-top:3px;">${w.exercises?.length||0} exercises · ${w.duration||0} min</div></div>
                        <div style="font-size:12px;color:#666;font-family:'Roboto Mono',monospace;">${new Date(w.created_at||w.date).toLocaleDateString()}</div>
                    </div>`).join('');
            }
        }

        function loadProfileForUser(user) {
            const el = id => document.getElementById(id);
            if (el('profileName'))     el('profileName').textContent    = user.full_name || user.fullName || '';
            if (el('profileUsername')) el('profileUsername').textContent = '@' + user.username;
            if (el('profileBio'))      el('profileBio').textContent      = user.bio || 'No bio yet.';
            if (el('profileFollowers')) el('profileFollowers').textContent = user.followers || 0;
            if (el('profileFollowing')) el('profileFollowing').textContent = user.following || 0;

            // Avatar: show photo if available, otherwise show initials
            const avatarImg      = el('profileAvatarImg');
            const initialsSpan   = el('profileInitials');
            const avatarUrl      = user.avatar_url || '';
            if (avatarImg && initialsSpan) {
                if (avatarUrl) {
                    avatarImg.src = avatarUrl;
                    avatarImg.style.display = 'block';
                    initialsSpan.style.display = 'none';
                } else {
                    avatarImg.style.display = 'none';
                    initialsSpan.style.display = '';
                    initialsSpan.textContent = user.initials || (user.full_name||user.username||'?').slice(0,2).toUpperCase();
                }
            }

            refreshProfileStats(user);
            refreshProfileWorkouts(user);
            refreshAchievements(user);
        }

        // ── SESSION CHECK ON LOAD ─────────────────────────────────────────────
        (async function init() {
            try {
                const stored = localStorage.getItem('sb_session');
                if (stored) {
                    const sess = JSON.parse(stored);
                    if (sess.expires_at > Date.now() / 1000) {
                        window._sbToken  = sess.access_token;
                        window._sbUserId = sess.user_id;
                        const [profiles, restoreWorkouts] = await Promise.all([
                            sb(`profiles?id=eq.${sess.user_id}&select=*`),
                            sb(`workouts?user_id=eq.${sess.user_id}&order=created_at.desc&select=*`)
                        ]);
                        if (profiles && profiles[0]) {
                            profiles[0].workouts = restoreWorkouts || [];
                            setCurrentUser(profiles[0]);
                            loadProfileForUser(profiles[0]);
                            await loadFeedFromSupabase();
                            loadUserGroups();
                            navigateToFeed();
                            return;
                        }
                    }
                }
            } catch(e) { console.warn('Session restore failed:', e.message); }
            showSignup();
        })();

        // ── PROFILE TAB SWITCHING ─────────────────────────────────────────────
        function switchProfileTab(tabName) {
            document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.profile-tab').forEach(t => {
                if (t.getAttribute('onclick')?.includes(tabName)) t.classList.add('active');
            });
            document.querySelectorAll('.profile-tab-content').forEach(c => c.classList.remove('active'));
            const tc = document.getElementById(tabName + '-tab');
            if (tc) tc.classList.add('active');
            const u = getCurrentUser();
            if (!u) return;
            if (tabName === 'stats')        refreshProfileStats(u);
            if (tabName === 'workouts')     refreshProfileWorkouts(u);
            if (tabName === 'achievements') refreshAchievements(u);
        }

        function refreshProfileWorkouts(user) {
            const feed = document.getElementById('profileWorkoutFeed');
            if (!feed) return;
            const workouts = user.workouts || [];
            if (workouts.length === 0) {
                feed.innerHTML = `<div style="text-align:center;padding:60px 20px;color:#999;">
                    <div style="font-size:48px;margin-bottom:15px;">🏋️</div>
                    <h3 style="font-family:'Bebas Neue',cursive;font-size:28px;color:var(--primary);margin-bottom:10px;">No Workouts Yet</h3>
                    <p>Hit the + button to log your first workout!</p>
                </div>`;
                return;
            }
            feed.innerHTML = '';
            const displayName = user.full_name || user.fullName || user.username || 'You';
            const initials    = user.initials || displayName.slice(0,2).toUpperCase();
            workouts.forEach(w => {
                const rawDate = w.created_at || w.date;
                const dateStr = rawDate ? new Date(rawDate).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : 'Just now';
                const card = buildSimpleCard({
                    name:      w.name,
                    duration:  w.duration,
                    exercises: w.exercises || [],
                    photoSrc:  w.photo_url || null,
                    caption:   w.caption   || null,
                    dateStr,
                    avatarUrl: user.avatar_url || '',
                    initials,
                    userName:  displayName
                });
                feed.appendChild(card);
            });
        }

        function refreshAchievements(user) {
            const grid = document.getElementById('achievementsGrid');
            if (!grid) return;
            const workouts = user.workouts || [];
            const count = workouts.length;
            const totalMinutes = workouts.reduce((s, w) => s + (w.duration || 0), 0);

            // Define all achievements with earned condition
            const all = [
                { icon:'🥇', title:'First Rep',         desc:'Log your first workout',          earned: count >= 1 },
                { icon:'🔟', title:'10 Workout Club',   desc:'Log 10 workouts',                 earned: count >= 10 },
                { icon:'🏆', title:'25 Workout Club',   desc:'Log 25 workouts',                 earned: count >= 25 },
                { icon:'💯', title:'100 Workout Club',  desc:'Log 100 workouts',                earned: count >= 100 },
                { icon:'⏱️', title:'Hour Grinder',      desc:'Log 60+ minutes in a workout',    earned: workouts.some(w => w.duration >= 60) },
                { icon:'🕐', title:'Time Warrior',      desc:'Log 1,000 total minutes',         earned: totalMinutes >= 1000 },
                { icon:'💪', title:'Variety Pack',      desc:'Log 5 different exercise names',  earned: new Set(workouts.flatMap(w => (w.exercises||[]).map(e => e.name.toLowerCase()))).size >= 5 },
                { icon:'🔥', title:'On Fire',           desc:'Log 3 workouts in one week',      earned: hasWorkoutsInWeek(workouts, 3) },
                { icon:'⚡', title:'Consistent',        desc:'Log workouts 2 weeks in a row',   earned: hasWeeklyStreak(workouts, 2) },
                { icon:'🦾', title:'Iron Habit',        desc:'Log workouts 4 weeks in a row',   earned: hasWeeklyStreak(workouts, 4) },
            ];

            const earned = all.filter(a => a.earned);
            const locked = all.filter(a => !a.earned);

            if (earned.length === 0 && locked.length > 0) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px 20px; color:#999;">
                    <div style="font-size:48px; margin-bottom:15px;">🎯</div>
                    <h3 style="font-family:'Bebas Neue',cursive; font-size:28px; color:var(--primary); margin-bottom:10px;">No Achievements Yet</h3>
                    <p>Log workouts to start earning achievements!</p>
                </div>` + locked.map(a => lockedCard(a)).join('');
                return;
            }

            grid.innerHTML =
                (earned.length > 0 ? `<div style="grid-column:1/-1; font-family:'Bebas Neue',cursive; font-size:18px; letter-spacing:2px; color:var(--primary); padding:10px 0 5px;">EARNED (${earned.length})</div>` + earned.map(a => earnedCard(a)).join('') : '') +
                (locked.length > 0 ? `<div style="grid-column:1/-1; font-family:'Bebas Neue',cursive; font-size:18px; letter-spacing:2px; color:#555; padding:20px 0 5px;">LOCKED (${locked.length})</div>` + locked.map(a => lockedCard(a)).join('') : '');
        }

        function earnedCard(a) {
            return `<div class="achievement-card" style="border-color:var(--primary);">
                <div class="achievement-icon">${a.icon}</div>
                <div class="achievement-title">${a.title}</div>
                <div class="achievement-description">${a.desc}</div>
            </div>`;
        }

        function lockedCard(a) {
            return `<div class="achievement-card" style="opacity:0.35; filter:grayscale(1);">
                <div class="achievement-icon">🔒</div>
                <div class="achievement-title" style="color:#666;">${a.title}</div>
                <div class="achievement-description">${a.desc}</div>
            </div>`;
        }

        function hasWorkoutsInWeek(workouts, n) {
            const weeks = {};
            workouts.forEach(w => {
                const d = new Date(w.date);
                const key = `${d.getFullYear()}-W${Math.floor((d - new Date(d.getFullYear(),0,1)) / 604800000)}`;
                weeks[key] = (weeks[key] || 0) + 1;
            });
            return Object.values(weeks).some(v => v >= n);
        }

        function hasWeeklyStreak(workouts, weeks) {
            if (workouts.length === 0) return false;
            const weekNums = [...new Set(workouts.map(w => {
                const d = new Date(w.date);
                return `${d.getFullYear()}-W${Math.floor((d - new Date(d.getFullYear(),0,1)) / 604800000)}`;
            }))].sort();
            let streak = 1, best = 1;
            for (let i = 1; i < weekNums.length; i++) {
                const prev = weekNums[i-1].split('-W'), cur = weekNums[i].split('-W');
                const diff = (parseInt(cur[1]) - parseInt(prev[1])) + (parseInt(cur[0]) - parseInt(prev[0])) * 52;
                streak = diff === 1 ? streak + 1 : 1;
                best = Math.max(best, streak);
            }
            return best >= weeks;
        }

        // ── SIGNUP ───────────────────────────────────────────────────────────
        async function handleSignup() {
            const fullName = document.getElementById('signupName').value.trim();
            const username = document.getElementById('signupUsername').value.trim().toLowerCase();
            const email    = document.getElementById('signupEmail').value.trim().toLowerCase();
            const password = document.getElementById('signupPassword').value;

            if (!fullName || !username || !email || !password) { showAuthError('signup','Please fill in all fields.'); return; }
            if (username.length < 3) { showAuthError('signup','Username must be at least 3 characters.'); return; }
            if (password.length < 6) { showAuthError('signup','Password must be at least 6 characters.'); return; }

            const btn = document.querySelector('#signupForm .auth-submit-btn');
            btn.textContent = 'Creating...'; btn.disabled = true;

            try {
                // Check username availability
                const taken = await sb(`profiles?username=eq.${username}&select=id`);
                if (taken && taken.length > 0) { showAuthError('signup','Username already taken.'); btn.textContent='Create Account'; btn.disabled=false; return; }

                const authData = await sbAuth('signup', email, password);

                // Supabase may require email confirmation — handle both cases
                const userId = authData.user?.id || authData.session?.user?.id;
                const token  = authData.access_token || authData.session?.access_token;

                if (!userId) {
                    showAuthError('signup', 'Please check your email and confirm your account, then log in.');
                    btn.textContent = 'Create Account'; btn.disabled = false; return;
                }

                window._sbToken  = token;
                window._sbUserId = userId;
                if (token) saveSession({ access_token: token, user: { id: userId }, expires_at: authData.expires_at || (Date.now()/1000 + 3600) });

                const initials = fullName.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
                const profile = { id: userId, username, full_name: fullName, initials, bio: '', followers: 0, following: 0 };
                await sb('profiles', { method:'POST', body: profile });

                profile.workouts = [];
                setCurrentUser(profile);
                loadProfileForUser(profile);
                await loadFeedFromSupabase();
                loadUserGroups();
                navigateToFeed();
            } catch(err) {
                showAuthError('signup', err.message);
                btn.textContent = 'Create Account'; btn.disabled = false;
            }
        }

        // ── LOGIN ────────────────────────────────────────────────────────────
        async function handleLogin() {
            const identifier = document.getElementById('loginIdentifier').value.trim().toLowerCase();
            const password   = document.getElementById('loginPassword').value;

            if (!identifier || !password) { showAuthError('login','Please fill in all fields.'); return; }

            const btn = document.querySelector('#loginForm .auth-submit-btn');
            btn.textContent = 'Logging in...'; btn.disabled = true;

            try {
                // Allow login by username — look up their email first
                let email = identifier;
                if (!identifier.includes('@')) {
                    const rows = await sb(`profiles?username=eq.${identifier}&select=id`);
                    if (!rows || rows.length === 0) { showAuthError('login','No account with that username.'); btn.textContent='Log In'; btn.disabled=false; return; }
                    // We need email — prompt them to use email
                    showAuthError('login', 'Please log in with your email address (username login coming soon).');
                    btn.textContent='Log In'; btn.disabled=false; return;
                }

                const authData = await sbAuth('token?grant_type=password', email, password);
                window._sbToken  = authData.access_token;
                window._sbUserId = authData.user.id;
                saveSession(authData);

                // Load profile
                // Fetch profile + workouts in parallel
                const [profiles, loginWorkouts] = await Promise.all([
                    sb(`profiles?id=eq.${authData.user.id}&select=*`),
                    sb(`workouts?user_id=eq.${authData.user.id}&order=created_at.desc&select=*`)
                ]);
                let profile = profiles && profiles[0];

                // Profile might not exist yet (e.g. email confirmation was on during signup)
                if (!profile) {
                    profile = {
                        id: authData.user.id,
                        username: email.split('@')[0],
                        full_name: email.split('@')[0],
                        initials: email.slice(0,2).toUpperCase(),
                        bio: '', followers: 0, following: 0
                    };
                    await sb('profiles', { method: 'POST', body: profile });
                }

                profile.workouts = loginWorkouts || [];

                setCurrentUser(profile);
                loadProfileForUser(profile);
                await loadFeedFromSupabase();
                loadUserGroups();
                navigateToFeed();
            } catch(err) {
                showAuthError('login', err.message.includes('Invalid') ? 'Incorrect email or password.' : err.message);
                btn.textContent = 'Log In'; btn.disabled = false;
            }
        }

        // ── FEED FROM SUPABASE ────────────────────────────────────────────────
        async function loadFeedFromSupabase() {
            try {
                const workouts = await sb('workouts?order=created_at.desc&limit=30&select=*,profiles(id,full_name,initials,username,avatar_url)');
                const feed = document.getElementById('mainFeed');
                if (!feed) return;
                // Remove old db-sourced cards
                feed.querySelectorAll('.activity-card[data-db]').forEach(c => c.remove());
                const empty = document.getElementById('feedEmptyState');
                if (!workouts || workouts.length === 0) {
                    if (empty) empty.style.display = 'block';
                    return;
                }
                if (empty) empty.style.display = 'none';
                const frag = document.createDocumentFragment();
                workouts.forEach(w => {
                    const card = buildWorkoutCard(w, w.profiles);
                    card.dataset.db = '1';
                    frag.appendChild(card);
                });
                feed.insertBefore(frag, feed.firstChild);
            } catch(e) { console.warn('Feed load error:', e.message); }
        }

        function buildWorkoutCard(w, profile) {
            const name     = profile?.full_name || profile?.username || 'Unknown';
            const initials = profile?.initials  || (name !== 'Unknown' ? name.slice(0,2).toUpperCase() : '??');
            const avUrl    = profile?.avatar_url || '';
            const dateStr  = w.created_at ? new Date(w.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : 'Just now';
            return buildSimpleCard({
                workoutId: w.id || null,
                name:      w.name,
                duration:  w.duration,
                exercises: w.exercises || [],
                photoSrc:  w.photo_url || null,
                caption:   w.caption   || null,
                dateStr,
                avatarUrl: avUrl,
                initials,
                userName:  name
            });
        }

        // ── GROUP WORKOUT PHOTO WIRING ────────────────────────────────────────
        (function() {
            const gwInput  = document.getElementById('gwPhotoInput');
            const gwZone   = document.getElementById('gwPhotoZone');
            const gwImg    = document.getElementById('gwPreviewImage');
            const gwRemove = document.getElementById('gwRemovePhoto');
            if (!gwInput || !gwZone || !gwImg || !gwRemove) return;

            gwInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(ev) {
                    gwImg.src = ev.target.result;
                    gwImg.classList.add('active');
                    gwZone.classList.add('has-image');
                    gwRemove.classList.add('active');
                    const uIcon = gwZone.querySelector('.upload-icon');
                    const uText = gwZone.querySelector('.upload-text');
                    if (uIcon) uIcon.style.display = 'none';
                    if (uText) uText.style.display = 'none';
                };
                reader.readAsDataURL(file);
            });

            gwRemove.addEventListener('click', function(e) {
                e.stopPropagation();
                gwInput.value = '';
                gwImg.classList.remove('active');
                gwZone.classList.remove('has-image');
                gwRemove.classList.remove('active');
                const uIcon = gwZone.querySelector('.upload-icon');
                const uText = gwZone.querySelector('.upload-text');
                if (uIcon) uIcon.style.display = 'block';
                if (uText) uText.style.display = 'block';
            });
        })();

        // Close group workout modal on outside click
        document.getElementById('groupWorkoutModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeGroupWorkoutModal();
        });

        // Close edit profile modal on outside click
        document.getElementById('editProfileModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeEditProfileModal();
        });

        // ── HELPERS ───────────────────────────────────────────────────────────
        function timeAgo(date) {
            const secs = Math.floor((Date.now() - date.getTime()) / 1000);
            if (secs < 60)   return 'Just now';
            if (secs < 3600) return Math.floor(secs/60) + 'm ago';
            if (secs < 86400) return Math.floor(secs/3600) + 'h ago';
            return Math.floor(secs/86400) + 'd ago';
        }

        // ── NAVIGATE ─────────────────────────────────────────────────────────
        function navigateToFeed() {
            const sp = document.getElementById('signupPage');
            const lp = document.getElementById('loginPage');
            if (sp) { sp.classList.remove('active'); sp.style.display = 'none'; }
            if (lp) { lp.classList.remove('active'); lp.style.display = 'none'; }
            document.querySelectorAll('.feed-page,.progress-page,.groups-page,.profile-page').forEach(p => p.classList.remove('active'));
            const fp = document.querySelector('.feed-page');
            if (fp) fp.classList.add('active');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const feedLink = document.querySelector('.nav-link[data-page="feed"]');
            if (feedLink) feedLink.classList.add('active');
        }
    </script>


</body>
</html>
